  
  SPN
  切片分组传送平台
  故障处理
  版本：A
  代号：MNxxxxxxxxx
  
  
  
  
  
  
  烽火通信科技股份有限公司
  二零二零年四月
  
  感谢您选择我们的产品！
  EMBED Word.Picture.8
  
  
  版权声明
  EMBED Word.Picture.8
  
  
  前  言
  相关手册
  手  册
  说  明
  
  《CiTRANS 690 E系列大容量切片分组传送平台 系列手册》
  该系列包括产品描述、硬件描述、快速安装指南等手册。
  
  《CiTRANS 650小型化融合光传送平台 系列手册》
  该系列包括产品描述、硬件描述、快速安装指南等手册。
  
  《UNM2000网络融合管理系统系列手册》
  该系列包括产品描述、操作指南和安装指南等手册，针对性介绍UNM2000公共、基础性的内容，旨在帮助用户深入了解和熟练使用该网管系统。
  
  用户可访问以下网址浏览手册电子版本：
  HYPERLINK "http://service.fiberhome.com"http：//service.fiberhome.com
  
  版本说明
  版  本
  说  明
  
  A
  初始版本。
  
  
  
  读者范围
  本手册适用以下读者对象：
  工程设计人员
  产品开通人员
  产品维护人员
  使用该手册需要事先掌握以下相关知识：
  PTN相关技术
  数据通信技术
  光纤通信技术
  以太网技术
  相关约定
  术语约定
  术  语
  表示含义
  
  UNM2000
  烽火通信UNM2000统一网络管理系统
  
  CiTRANS 690 E10
  烽火通信CiTRANS 690 E10大容量切片分组传送平台
  
  CiTRANS 690 E20
  烽火通信CiTRANS 690 E20大容量切片分组传送平台
  
  CiTRANS 690 E30
  烽火通信CiTRANS 690 E30大容量切片分组传送平台
  
  CiTRANS 650 U3
  烽火通信CiTRANS 650 U3小型化融合光传送平台
  
  CiTRANS 650 U5
  烽火通信CiTRANS 650 U5小型化融合光传送平台
  
  S16J1
  2.5G光接口盘
  
  S1J1
  STM-1光接口盘
  
  E1J1
  2M接口盘
  
  IFJ1
  FE端子板
  
  IEJ1
  2M端子板
  
  AIFJ1/AIFJ2
  电源及辅助端子板
  
  符号约定
  符号
  提示类型
  提示事项
  
  
  提示
  重要的特征或操作指导。
  
  
  注意
  可能会对人身造成伤害，或给系统造成损害，或造成业务中断或丢失。
  
  
  警告
  可能会对人身造成重大伤害。
  
  (
  跳转
  操作步骤跳转至后续步骤。
  
  →
  级联菜单
  连接多级菜单项。
  
  (
  双向业务
  业务信号方向为双向。
  
  (
  单向业务
  业务信号方向为单向。
  
  
  
  操作安全要则
  强功率激光对人体特别对眼睛有危害，不得将光发送器的尾纤端面或其上面的活动连接器的端面对着眼睛。
  不得用手触摸机盘上的元器件、布线及插头座中的金属导体。维修机盘必须触及时应采取静电防护措施。机房地面不得使用地毯或其它容易产生静电的材料。
  光纤通信设备须注意对强电和雷电的防护，尤其应注意光缆在设备终接时，必须采取有效措施，以免将强电或雷电引入设备。
  注意不得将光纤产生折弯，必须弯曲光纤时，曲率半径不得小于38mm。
  设备中的光纤活动连接器不得随意打开，维修设备必须打开时，须采取保护措施，以免连接器的端面被污染。
  网络管理用的计算机是专用设备，不得挪作它用。特别不得使用来历不明的软盘，以免病毒的侵害。
  在进行设备维护和对设备接口指标测试时，仪表的地必须与设备（或设备所在的机架）的地良好地接在一起。否则可能会损坏信号接口的相关元器件。
  
  
  目  录
  TOC \o "1-2" \h \z \t "标题 3,3,附录三级标题,3"  HYPERLINK \l "_Toc37166952" 前  言	 PAGEREF _Toc37166952 \h III
  HYPERLINK \l "_Toc37166953" 相关手册	 PAGEREF _Toc37166953 \h III
  HYPERLINK \l "_Toc37166954" 版本说明	 PAGEREF _Toc37166954 \h IV
  HYPERLINK \l "_Toc37166955" 读者范围	 PAGEREF _Toc37166955 \h IV
  HYPERLINK \l "_Toc37166956" 相关约定	 PAGEREF _Toc37166956 \h V
  HYPERLINK \l "_Toc37166957" 操作安全要则	 PAGEREF _Toc37166957 \h VII
  HYPERLINK \l "_Toc37166958" 1	管理面故障定位及处理	 PAGEREF _Toc37166958 \h 1
  HYPERLINK \l "_Toc37166959" 1.1	网元开通和脱管故障定位及处理	 PAGEREF _Toc37166959 \h 2
  HYPERLINK \l "_Toc37166960" 1.2	管理面DCN故障定位及处理	 PAGEREF _Toc37166960 \h 8
  HYPERLINK \l "_Toc37166961" 1.3	OSPF协议故障定位及处理	 PAGEREF _Toc37166961 \h 22
  HYPERLINK \l "_Toc37166962" 1.3.1	OSPF邻居不能正常建立	 PAGEREF _Toc37166962 \h 22
  HYPERLINK \l "_Toc37166963" 1.3.2	设备学习不到OSPF路由	 PAGEREF _Toc37166963 \h 32
  HYPERLINK \l "_Toc37166964" 1.4	网元配置下发失败定位及处理	 PAGEREF _Toc37166964 \h 41
  HYPERLINK \l "_Toc37166965" 1.5	网元状态命令行查询失败定位及处理	 PAGEREF _Toc37166965 \h 45
  HYPERLINK \l "_Toc37166966" 1.6	告警相关故障定位及处理	 PAGEREF _Toc37166966 \h 49
  HYPERLINK \l "_Toc37166967" 1.7	性能上报故障定位及处理	 PAGEREF _Toc37166967 \h 56
  HYPERLINK \l "_Toc37166968" 2	控制面故障定位及处理	 PAGEREF _Toc37166968 \h 65
  HYPERLINK \l "_Toc37166969" 2.1	PCEP连接中断故障定位及处理	 PAGEREF _Toc37166969 \h 66
  HYPERLINK \l "_Toc37166970" 2.2	ISIS邻居状态异常故障定位及处理	 PAGEREF _Toc37166970 \h 72
  HYPERLINK \l "_Toc37166971" 2.3	ISIS路由故障定位及处理	 PAGEREF _Toc37166971 \h 83
  HYPERLINK \l "_Toc37166972" 2.4	SR-TP配置下发故障定位及处理	 PAGEREF _Toc37166972 \h 90
  HYPERLINK \l "_Toc37166973" 2.5	控制面DCN故障定位及处理	 PAGEREF _Toc37166973 \h 96
  HYPERLINK \l "_Toc37166974" 3	业务故障定位及处理	 PAGEREF _Toc37166974 \h 109
  HYPERLINK \l "_Toc37166975" 3.1	L2VPN业务不通故障定位及处理	 PAGEREF _Toc37166975 \h 110
  HYPERLINK \l "_Toc37166976" 3.2	L3VPN业务不通故障定位及处理	 PAGEREF _Toc37166976 \h 119
  HYPERLINK \l "_Toc37166977" 3.3	CCC业务不通故障定位及处理	 PAGEREF _Toc37166977 \h 132
  HYPERLINK \l "_Toc37166978" 3.4	MPLS-TP隧道不通故障定位及处理	 PAGEREF _Toc37166978 \h 136
  HYPERLINK \l "_Toc37166979" 3.5	SR-TP隧道不通故障定位及处理	 PAGEREF _Toc37166979 \h 140
  HYPERLINK \l "_Toc37166980" 3.6	FlexE故障定位及处理	 PAGEREF _Toc37166980 \h 144
  HYPERLINK \l "_Toc37166981" 4	主控盘故障定位及处理	 PAGEREF _Toc37166981 \h 153
  HYPERLINK \l "_Toc37166982" 4.1	主备无法切换故障定位及处理	 PAGEREF _Toc37166982 \h 154
  HYPERLINK \l "_Toc37166983" 4.2	主备倒换故障定位及处理	 PAGEREF _Toc37166983 \h 158
  HYPERLINK \l "_Toc37166984" 5	业务保护和倒换故障定位及处理	 PAGEREF _Toc37166984 \h 162
  HYPERLINK \l "_Toc37166985" 5.1	概述	 PAGEREF _Toc37166985 \h 163
  HYPERLINK \l "_Toc37166986" 5.2	VPN FRR倒换故障定位及处理	 PAGEREF _Toc37166986 \h 164
  HYPERLINK \l "_Toc37166987" 5.3	混合FRR倒换故障定位及处理	 PAGEREF _Toc37166987 \h 171
  HYPERLINK \l "_Toc37166988" 5.4	隧道保护倒换故障定位及处理	 PAGEREF _Toc37166988 \h 178
  HYPERLINK \l "_Toc37166989" 6	线路故障定位及处理	 PAGEREF _Toc37166989 \h 184
  HYPERLINK \l "_Toc37166990" 6.1	线路光功率异常故障定位及处理	 PAGEREF _Toc37166990 \h 185
  HYPERLINK \l "_Toc37166991" 7	PTP故障定位及处理	 PAGEREF _Toc37166991 \h 189
  HYPERLINK \l "_Toc37166992" 7.1	背景信息	 PAGEREF _Toc37166992 \h 190
  HYPERLINK \l "_Toc37166993" 7.2	1588v2配置说明	 PAGEREF _Toc37166993 \h 192
  HYPERLINK \l "_Toc37166994" 7.3	锁定状态检查	 PAGEREF _Toc37166994 \h 194
  HYPERLINK \l "_Toc37166995" 7.4	应用场景及故障排查	 PAGEREF _Toc37166995 \h 196
  HYPERLINK \l "_Toc37166996" 7.4.1	同步tod无法锁定问题定位	 PAGEREF _Toc37166996 \h 197
  HYPERLINK \l "_Toc37166997" 7.4.2	同步线路口无法锁定问题定位	 PAGEREF _Toc37166997 \h 201
  HYPERLINK \l "_Toc37166998" 8	其他故障定位及处理	 PAGEREF _Toc37166998 \h 209
  HYPERLINK \l "_Toc37166999" 8.1	机电相关故障定位及处理	 PAGEREF _Toc37166999 \h 210
  HYPERLINK \l "_Toc37167000" 8.1.1	电源性能问题	 PAGEREF _Toc37167000 \h 210
  HYPERLINK \l "_Toc37167001" 8.1.2	电源和风扇的告警问题	 PAGEREF _Toc37167001 \h 212
  HYPERLINK \l "_Toc37167002" 8.2	时钟故障定位及处理	 PAGEREF _Toc37167002 \h 214
  HYPERLINK \l "_Toc37167003" 8.3	DHCP Relay故障定位及处理	 PAGEREF _Toc37167003 \h 220
  HYPERLINK \l "_Toc37167004" 8.4	LAG故障定位及处理	 PAGEREF _Toc37167004 \h 226
  HYPERLINK \l "_Toc37167005" 8.5	BFD故障定位及处理	 PAGEREF _Toc37167005 \h 233
  HYPERLINK \l "_Toc37167006" 8.6	LLDP故障定位及处理	 PAGEREF _Toc37167006 \h 239
  HYPERLINK \l "_Toc37167007" 8.7	LACP故障定位及处理	 PAGEREF _Toc37167007 \h 243
  HYPERLINK \l "_Toc37167008" 附 录 A	软件升级失败处理	 PAGEREF _Toc37167008 \h 251
  HYPERLINK \l "_Toc37167009" A.1	整包预升级注册时报错	 PAGEREF _Toc37167009 \h 251
  HYPERLINK \l "_Toc37167010" A.1.1	整包不存在	 PAGEREF _Toc37167010 \h 251
  HYPERLINK \l "_Toc37167011" A.1.2	处于busy状态	 PAGEREF _Toc37167011 \h 251
  HYPERLINK \l "_Toc37167012" A.2	整包注册后执行激活失败	 PAGEREF _Toc37167012 \h 252
  HYPERLINK \l "_Toc37167013" A.2.1	盘状态显示VER_IS_ACTIVE	 PAGEREF _Toc37167013 \h 252
  HYPERLINK \l "_Toc37167014" A.2.2	盘状态一直显示REG_ING	 PAGEREF _Toc37167014 \h 253
  HYPERLINK \l "_Toc37167015" A.2.3	盘状态显示COPY_WH_PACK_ERROR	 PAGEREF _Toc37167015 \h 253
  HYPERLINK \l "_Toc37167016" A.2.4	盘状态显示BACKUP_FILE_ERROR	 PAGEREF _Toc37167016 \h 254
  HYPERLINK \l "_Toc37167017" A.2.5	盘状态显示FILE_IMCOMPATIBLE	 PAGEREF _Toc37167017 \h 254
  HYPERLINK \l "_Toc37167018" A.2.6	盘状态显示WH_PACK_CHECK_ERROR	 PAGEREF _Toc37167018 \h 254
  HYPERLINK \l "_Toc37167019" 附 录 B	网管服务器异常处理	 PAGEREF _Toc37167019 \h 255
  HYPERLINK \l "_Toc37167020" B.1	服务状态监测工具	 PAGEREF _Toc37167020 \h 255
  HYPERLINK \l "_Toc37167021" B.2	服务启动日日志	 PAGEREF _Toc37167021 \h 256
  HYPERLINK \l "_Toc37167022" B.3	服务异常文件查看	 PAGEREF _Toc37167022 \h 257
  HYPERLINK \l "_Toc37167023" B.4	网管管理工具无法打开或者提示用户数量限制	 PAGEREF _Toc37167023 \h 258
  HYPERLINK \l "_Toc37167024" 附 录 C	控制命令/状态查询/配置下发失败时日志分析	 PAGEREF _Toc37167024 \h 261
  HYPERLINK \l "_Toc37167025" C.1	网管报错信息分析	 PAGEREF _Toc37167025 \h 261
  HYPERLINK \l "_Toc37167026" C.2	网管和网元交互日志分析	 PAGEREF _Toc37167026 \h 262
  HYPERLINK \l "_Toc37167027" C.3	常见设备返错信息及处理方法	 PAGEREF _Toc37167027 \h 264
  HYPERLINK \l "_Toc37167028" C.3.1	no exec info错误	 PAGEREF _Toc37167028 \h 264
  HYPERLINK \l "_Toc37167029" C.3.2	unkown namespace错误	 PAGEREF _Toc37167029 \h 266
  HYPERLINK \l "_Toc37167030" C.3.3	value not in set/bad value错误	 PAGEREF _Toc37167030 \h 267
  HYPERLINK \l "_Toc37167031" C.3.4	error-number大于900的错误	 PAGEREF _Toc37167031 \h 267
  HYPERLINK \l "_Toc37167032" C.3.5	commit错误	 PAGEREF _Toc37167032 \h 268
  HYPERLINK \l "_Toc37167033" C.3.6	wrong node type错误	 PAGEREF _Toc37167033 \h 268
  HYPERLINK \l "_Toc37167034" C.3.7	unknown object错误	 PAGEREF _Toc37167034 \h 269
  HYPERLINK \l "_Toc37167035" C.3.8	Uim data convert failed错误	 PAGEREF _Toc37167035 \h 270
  HYPERLINK \l "_Toc37167036" C.3.9	xml reader EOF错误	 PAGEREF _Toc37167036 \h 271
  HYPERLINK \l "_Toc37167037" 附 录 D	ARP诊断方法	 PAGEREF _Toc37167037 \h 275
  HYPERLINK \l "_Toc37167038" 附 录 E	NDP诊断方法	 PAGEREF _Toc37167038 \h 277
  HYPERLINK \l "_Toc37167039" 附 录 F	OAM配置检查和CV帧统计方法	 PAGEREF _Toc37167039 \h 280
  HYPERLINK \l "_Toc37167040" F.1	SR-TP OAM配置检查	 PAGEREF _Toc37167040 \h 280
  HYPERLINK \l "_Toc37167041" F.2	CV帧统计查询方法	 PAGEREF _Toc37167041 \h 283
  
  
  管理面故障定位及处理
  介绍管理面故障的定位及处理。
  网元开通和脱管故障定位及处理
  管理面DCN故障定位及处理
  OSPF协议故障定位和处理
  网元配置下发失败定位和处理
  网元状态命令行查询失败定位和处理
  告警相关故障定位及处理
  性能上报故障定位及处理
  网元开通和脱管故障定位及处理
  背景信息
  网管服务器通过管理面DCN通道周期性地跟SPN设备交互UDP报文，报文采用“请求——应答”的模式，当网管发送的请求报文持续多次未收到设备应答时，会判断设备失联，从而在网管服务器上将网元“点黑”，并且产生网元通信中断告警。
  EMBED Visio.Drawing.15
  故障现象
  常见的网元脱管故障现象如下：
  网元在网管上没有点亮，并且有网元中断告警
  网管无法查询相邻网元SN
  网管给设备写管理IP失败
  可能原因
  现网网元脱管故障问题，原因一般有以下几个方面：
  原因类型
  原因详述
  
  配置问题
  网管和网元IP地址配置不一致
  跟设备管理面通信的网卡上未配置网管管理程序IP地址
  
  协议异常
  管理面DCN故障
  
  网管问题
  网管服务异常
  
  定位思路
  针对网元脱管故障，总体定位思路如下：
  检查网管服务器跟网元之间管理面DCN通道是否正常。
  检查网管服务是否正常。
  检查设备在脱管之前是否存在异常告警。
  抓包分析判断是设备问题还是网管问题。
  故障处理流程
  EMBED Visio.Drawing.15
  操作步骤-网元脱管故障
  检查网管服务器是否可以ping通脱管网元管理IP地址。
  如果ping不通：➔跳转到管理面DCN故障章节继续处理。
  可以ping通：➔步骤2。
  检查网管服务是否正常。
  打卡网管服务管理面工具（D：\UNM2000\pas\tools目录下IceGridGUI），启动时需要填写如下参数，然后找到UNM2000-OtnmManagerServer服务，确认该服务是否正常。
  
  检查管理程序配置是否正常，注意管理程序属性中设备管理IP地址跟网卡（管理面网卡）上配置的IP地址是否一致，如下图。
  
  telnet到设备上检查设备udp 7889（1ed1）状态。
  先telnet到网元，然后执行ostelnet 127.0.0.1转登录到os，然后执行telnet 127.1 8800，接着进入nmunet组件。具体操作如下：
  
  进入NMUNET组件后，执行socklib_show_appinfo()命令，找到sourceport为1ed1的条目。注意两点：
  sourceip正常为网元管理IP。
  正常时4个统计都有增长，如果rec没有增长，可能是网管未发送或者管理面DCN丢包，可以先排除网管问题。如果故障无法排除可以联系烽火工程师处理；如果rec统计增长但是send统计未增长，则可以确认设备存在故障，可以联系烽火工程师处理。
  
  在网管服务器和设备上抓包分析大概故障。
  通过wireshark或者netmon工具，在网管服务器上抓包（注意选择管理程序网卡），抓包时长1分钟后结束抓包，将抓包文件保存。
  分析抓包文件，注意两点：
  网管服务器是否给目标网元发送了UDP报文，如果未发送，则大概率网管问题，请联系烽火网管专家处理。
  是否抓到了设备发给网管的UDP报文，如果未抓到，则大概率是设备问题，请联系烽火工程师处理。
  wireshark截图，如下图所示：
  
  汇总相关信息，联系烽火工程师。
  操作步骤-网管上发现指定网元的邻居失败故障
  确认指定网元是否正常上管。
  正常上管：➔步骤2。
  未正常上管：➔跳转到网元脱管故障处理章节。
  登录到指定网元确认设备上是否正常发现邻居网元。
  telnet到指定网元上，执行ems-show neighbor ne命令查看是否可以学到邻居SN，可以跟show lldp neighbor brief命令配合分析，确认网元，如下图所示。
  
  如果设备上未发现邻居SN或者LLDP邻居未发现，可以先检查线路故障，如果不存在线路故障，请联系烽火工程师处理。
  检查网管服务是否正常。
  检查UNM2000-OtnmManagerServer和UNM2000-servicecfgotnmserver两个服务是否正常（参考网管脱管故障操作步骤2）。如果不正常，请联系烽火工程师处理。
  在网管服务器上抓包保存，然后发给烽火工程师分析。
  在网管服务器上开启抓包，然后重新尝试发现邻居，网管显示发现失败时停止抓包，将抓包保存，然后将故障现象和抓包文件发给烽火工程师处理。
  操作步骤-网管远程写IP失败故障
  确认源网元是否正常上管。
  正常上管：➔步骤2。
  未正常上管：➔跳转到网元脱管故障处理章节。
  检查网管服务是否正常。
  检查UNM2000-OtnmManagerServer和UNM2000-servicecfgotnmserver两个服务是否正常（参考网管脱管故障操作步骤2）。如果不正常，请联系烽火工程师处理。
  在网管服务器上抓包保存，然后发给烽火工程师分析。
  在网管服务器上开启抓包，然后重新尝试发现邻居，网管显示发现失败时停止抓包，将抓包保存，然后将故障现象和抓包文件发给烽火工程师处理。
  管理面DCN故障定位及处理
  背景信息
  管理面DCN承载两个基于TCP的应用协议，分别是网元基础配置下发协议Netconf和网元性能上报协议FTP，基于UDP传输协议的告警上报私有协议，管理面DCN需要保证网管管理程序IP地址跟跟每个网元的网元管理IP地址（NE IP）路由可达。
  网管服务器需要配置去往设备管理面的静态路由，路由nexthop为对应的外部DCN网络与网关服务器相连接口IP地址。
  随着网管中心云化、集约化部署的要求，建议外部整体采用三层DCN，需要保证网管服务器到每个网元NE IP路由可达（跟控制面DCN分开）。
  管理面内部DCN通过OSPF协议打通网元之间的路由；在接入网元上（NPE/SPE节点）需要配置去往网管服务器管理程序IP地址的静态路由，路由nexthop为对应的外部DCN网络与接入网元外部DCN接口相连的接口IP地址，同时将静态路由重分布到每个管理面OSPF进程；在SPN网内，管理面内部DCN和控制内部DCN属于不同的VRF。
  EMBED Visio.Drawing.15
  如上图所示，为实际工程网管集约化后管理面DCN整体组网图。每一对接入网元负责打通所在OSPF域内所有的网元到网管服务器管理面路由，要求形成保护，网管和网元之间管理面流量双向流量路径一致。
  接入网元选择：外部DCN部署到每个核心汇聚节点和骨干汇聚节点，每个地市选取一对NPE作为接入网元管理核心OSPF进程，同时每一对SPE作为接入网元管理其下挂的所有网元。
  接入网元跟外部DCN物理对接要求：要求接入网元带外口采用以太光口（GE口），要求外部DCN为每一对接入网元提供GE的带宽。
  接入网元路由部署：每个接入网元配置去往网管服务器管理程序IP的静态路由，下一跳为外部DCN设备跟带外口对接的IP，并且将静态路由引入所在每一个OSPF实例；要求接入网元跟外部DCN直连三层设备之间互通BFD，当静态路由下一跳失效时可以及时撤销静态路由，保证路由正常切换。为保证管理面流量双向路径一致，需要对每一对主备接入网元路由的AD值和metric值进行相应的规划。具体如下：
  1）NPE接入网元路由部署。
  核心OSPF进程内所有节点（包括NPE和核心调度节点）流量优先走主用NPE转发，保护走备用NPE转发。
  主用网关NPE配置的静态路由AD为100，cost为40000，该静态路由重分发到OSPF实例（核心OSPF实例，默认实例号为65533）时metric为40000。
  备用网关NPE配置的静态路由AD为110，cost为50000，该静态路由重分发到OSPF实例时metric为50000。
  2）SPE接入网元路由部署。
  主备SPE节点及下挂汇聚环、UPE设备流量优先走主用SPE转发，保护走备用SPE转发。
  静态路由和重分布配置：主用SPE配置静态路由AD为100，cost值为默认值，该静态路由重分布到除了OSPF 65533以外的其他ospf实例，重分布时metric值为默认值10；备用SPE配置静态路由AD为110，cost为30000，该静态路由重分发到除了OSPF 65533以外的其他ospf实例，重分布时metric值为30000。
  OSPF实例重分布：主用SPE将OSPF实例65533中的loopback1020的路由重分布到其他OSPF实例时cost配置为200；备用SPE将OSPF实例65533中的loopback1020的路由重分布到其他OSPF实例时cost配置为35000。
  故障现象
  常见的管理面DCN故障现象如下：
  网管服务器无法ping通网元的管理 IP地址
  可能原因
  现网管理面DCN故障问题，原因一般有以下几个方面：
  原因类型
  原因详述
  
  配置问题
  网管服务器上管理面静态路由未配
  网管服务器上管理面静态路由下一跳或者目标网段配置错误
  dcn接口未加入了正确的ospf实例
  对接的两个dcn接口ospf area不一致
  接入网元（SPE/NPE）引入的静态路由配置错误
  接入网元匹配去往网管服务器管理网卡IP地址静态路由的目标网段的路由策略和前缀列表配置错误
  OSPF实例65533之外的其他OSPF实例重分布静态路由时未选择路由策略
  SPE接入网元匹配loopback1020口IP地址的路由策略和前缀列表配置错误
  OSPF实例65533重分布到其他OSPF实例时未选择路由策略
  对接的两个NNI口MTU配置不匹配
  网元管理IP地址冲突
  router-id冲突
  OSPF实例中“等价路径数目”配置不为1
  
  线路故障
  网元因为线路多处故障变成网元孤岛
  
  协议异常
  OSPF协议会话异常
  OSPF协议会话正常但管理面私网路由不存在
  接入网元跟外部DCN设备互通的bfd状态down
  
  定位思路
  针对网管服务器ping不通某网元管理IP地址故障，总体定位思路如下：
  结合实际网络拓扑和管理DCN网络规划，初步确认故障网元来回的路由路径。
  从网管服务器上tracert故障网元管理IP地址，根据tracert结果可以判断故障点是网管服务器静态路由配置问题，或者外部DCN通道问题，或者内部DCN某网元故障导致。
  针对不同的情况进一步排查，先排除硬件、线路和配置问题，再查路由状态，尽量找出问题点。
  故障处理流程
  EMBED Visio.Drawing.15
  操作步骤
  根据tracert结果判断故障出在网络中的哪一段。
  梳理故障网元在网络中的位置，根据当前物理拓扑情况以及管理面DCN网络规划，判断故障网元正常时应该的路由走向。
  然后在网管服务器的CMD（命令管理器）中执行tracert -d x.x.x.x，其中x.x.x.x为故障网元管理IP地址，确认tracert结果可达的最后一个IP地址在网络中的位置判断故障出在网络中的哪一段。
  如下图tracert结果，红色方框为最后可达IP地址。
  
  Tracert无法达到服务器网关：➔步骤2。
  Tracert无法达到接入网元：➔步骤3。
  Tracert只能到达接入网元：➔步骤4。
  Tracert不只能到达接入网元：➔步骤5。
  检查网管服务器控制网卡IP和静态路由配置。
  找出网络规划台账，确认网管服务器管理程序网卡IP地址和网关IP地址规划，检查管理程序网卡配置上配置的IP地址和掩码是否跟规划匹配是否正确。
  在网管服务器的命令管理器中通过route print命令查看服务器是否有到达故障网元所在网络的管理面DCN网段路由，如下图所示。
  
  如果网卡IP和静态路由配置无问题，则先检查网关服务器跟网关之间的链路是否正常。
  在网管服务器命令管理器中通过arp -a x.x.x.x 命令查看是否可以学到服务器网关的arp，其中x.x.x.x为服务器网关IP地址，如下图所示。
  
  如果ARP无法学到，或ARP可以正常学到但服务器仍然ping不通网关，则需要跟网关设备厂家的专家一起排查，必要时可以在网管服务器上抓包（wireshark或者netmon）分析，也可以联系烽火工程师协助处理。
  排查管理面外部DCN故障。
  找出管理面DCN台账规划，确认接入网元管理带外口IP地址规划、接入网元的网关IP地址、跟外部DCN对接的bfd参数等规划，一一检查。
  注意：
  此时接入网元可能通过管理IP地址无法登录，可以尝试通过接入管理带外口IP地址、控制带外口IP以及控制面loopback0口IP地址登录接入网元，或者先尝试登录备用接入网元，然后在尝试转登录。
  如果无法登录，则联系烽火网络工程师协助处理。
  检查接入网元当前去往网管服务器管理程序网卡IP地址静态路由配置，是否跟规划一致。具体查询方式如下图。
  
  检查静态路由绑定的bfd状态是否为up。
  先执行show bfd session ，然后通过Name找到静态路由绑定的bfd条目，关注State状态。
  
  如果静态路由绑定的bfd状态为down，尝试核对bfd规划参数，规划参数跟实际配置不一致，则需要对配置进行修改。再检查bfd的源、peer ip之间的可达性。
  如果source、peer ip之间可以ping通：➔跳转到bfd故障排查章节或者联系烽火工程师处理。
  如果source、peer ip之间不能ping通：➔跳转到直连路由不可达故障处理章节或者联系烽火工程师处理。
  通过show route detail vrf FHNMVPN ipv4 x.x.x.x命令查看管理面私网路由表中是否存在去往网管服务器管理程序IP地址的静态路由，其中x.x.x.x是网管服务器管理程序IP地址。具体操作如下图所示：
  
  关注显示出的路由条目中的优选路由条目的出接口是否跟规划一致。
  如果接入网元到网管服务器管理程序IP地址的路由出现了出现了ECMP（Priority），则直接联系烽火工程师处理。
  检查接入网元所有OSPF实例的重分布配置是否正常。
  查看所有OSPF实例中重分布静态路由时是否引用了正确的route-policy。
  
  若确认引用的路由策略名称为dcn-static-route，则可以通过show route-policy dcn-static-route来确认引用的ipv4-prefix的名称，然后通过show ipv4-prefix命令查看前缀列表匹配的网段是否跟管理面带外静态路由的目标网段完全匹配，如下图所示。
  
  注意：
  前缀列表跟静态路由的目标网段一定要完全匹配，不能为包含关系！
  SPE需要检查除了ospf 65533之外的其他ospf实例中是否重分布ospf 65533实例并且匹配了管理IP地址（loopback1020接口地址）的路由策略。
  
  如确认引用的路由策略名称为ipv4-dcn，则可以通过show route-policy ipv4-dcn来确认引用的ipv4-prefix的名称，然后通过show ipv4-prefix命令查看前缀列表匹配的网段是否跟本网元管理IP地址（loopback1020口地址）是否完全匹配，如下图所示。
  
  注意：
  前缀列表跟本网元管理IP地址（loopback1020口地址）一定要完全匹配，不能为包含关系！
  排查tracert最后可达网元跟它下游相邻网元的OSPF邻居状态。
  
  Tracert最后可达网元与它相邻的下游网元之间OSPF邻居状态不FULL，则从如下思路进行排查：
  排查tracert最后可达网元及其下游相邻网元互联线路是否存在告警。如果线路故障无法排除，请联系烽火工程师处理。
  排查是否存在单盘故障。需要检查单盘是否存在温度、脱管、CPU、内存等告警。如果单盘故障无法消除，请联系烽火工程师处理。
  排查dcn口配置检查。
  所有dcn口vrf都属于vrf FHNMVPN，并且借用管理口IP地址（SPN所有应用场景都是loopback口IP作为管理IP地址）。
  所有dcn口都需要配置vlan 4093，对于DCN子接口，需要配置双层vlan，其中外层vid为4093，内层vid跟DCN子接口名称编号保持一致。如下图所示。
  
  DCN接口mtu和up/down状态检查。
  通过show ospf interface 命令可以检测dcn接口的状态、MTU，如下图所示。
  注意：
  dcn-serial-flexe-tnl口和dcn-serial-flexe-tnl子接口的mtu为1500，dcn-serial口和dcn-serial子接口的mtu为1496。
  
  如果线路故障已经排除并且接口IP已配置，则是接口状态是两个up，否则联系烽火工程师处理。
  排查dcn接口ARP是否学到。
  dcn接口通过动态ARP学习对端接口的mac地址，可以通过show arp命令查询当前arp状态，是否学到对端的ARP，需要核对对端dcn口的MAC地址，尤其注意vrf为FHNMVPN。
  
  排查OSPF配置。
  查看当前ospf实例的show running配置是否正常，确认dcn口和loopback1020是否都正确加入了对应的实例。OSPF配置实例关注点如下图所示。
  
  检查ospf接口收发包统计，大致确认是否存在报文不通情况，如下图所示。
  
  排除以上原因，OSPF邻居仍然无法正常建立，可以尝试跳转到OSPF故障排除章节继续处理，或者联系烽火工程师处理。
  排查tracert最后可达的网元的路由。
  提示：
  路由表查看小技巧：一是需要路由有没有学到，二是看路由跟当前物理拓扑和网络规划是否一致。
  EMBED Visio.Drawing.15
  以上图为例：
  排查tracert最后可达网元到故障网元的路由。
  如果存在ecmp，检查OSPF实例配置中最大等价路径数目是否配置的1，检查路由出接口和下一跳是否跟网络规划一致。
  
  排查tracert最后可达网元相邻的下游网元的到网管服务器管理程序IP地址的路由（可以尝试从其他网元转登录或者通过控制面DCN通道登录）。
  
  如果路由状态跟上图中描述不一致并且无法排除，或者路由故障排除后仍然ping不通，需要在当前tracert最后可达网元及其下游故障网元上进行ping测和抓包分析，也可以参考相关章节进一步排查或者联系烽火工程师处理。
  汇总相关信息，联系烽火工程师。
  OSPF协议故障定位及处理
  背景信息
  OSPF路由协议是一种典型的链路状态（Link-state）的路由协议，一般用于同一个路由域内。路由域是指一个自治系统（Autonomous System），即AS，它是指一组通过统一的路由政策或路由协议互相交换路由信息的网络。在这个AS中，所有的OSPF路由器都维护一个相同的AS结构数据库，该数据库中存放的是路由域中相应链路的状态信息，OSPF路由器正是通过这个数据库计算出其OSPF路由表的。
  当前SPN工程OSPF组网方案详见管理面DCN故障定位及处理章节背景信息的描述。
  OSPF邻居不能正常建立
  故障现象
  常见的OSPF邻居不能正常建立故障现象如下：
  通过show ospf neighbor，或show ospf ospf-id neighbor看不到邻居
  通过show ospf neighbor，或show ospf ospf-id neighbor回显中邻居状态不为FULL，而是显示ATTEMPT \ INIT \ 2WAY \ EXCHANGE-START \ EXCHANGE \ LOADING状态
  可能原因
  现网OSPF邻居不能正常建立故障，原因一般有以下几个方面：
  原因类型
  原因详述
  
  配置问题
  路由器ID冲突
  区域ID不一致
  Hello间隔和Dead间隔配置不一致
  认证类型和密码不一致
  特殊区域（如stub和nssa等）类型不匹配
  路由器的接口是否被passive掉
  链路上的MTU不匹配
  若采用私网OSPF进程，接口未使能VRF属性或接口未添加到OSPF VRF实例中
  
  链路问题
  直连链路异常
  
  协议异常
  DR/BDR选举失败
  Router-ID被占用
  协议启动失败
  接口未宣告进OSPF实例
  
  定位思路
  针对OSPF邻居不能正常建立故障，总体定位思路如下：
  排除链路及设备问题：直连知否能ping通对端，ping不通检查对端接口类型是否一致，接口是否up，直连IP地址配置是否正确，本对端是否有异常告警。
  检查相关OSPF参数配置，排除配置问题。
  检查协议问题，排除协议异常。
  汇总信息，联系烽火工程师。
  故障处理流程
  EMBED Visio.Drawing.11
  操作步骤
  ping异常邻居的直连接口IP地址。
  执行ping ip-address命令，ping异常邻居的直连接口地址，检测是否可以ping通。
  ping不通：➔步骤2。
  能ping通：➔步骤4。
  
  检查网管服务器控制网卡IP和静态路由配置。
  登录协议栈，执行show arp命令，查看ARP信息是否正常。
  正常：➔步骤3。
  不正常：➔解决ARP问题。
  
  检查对接双方接口是否UP。
  登录协议栈，执行show ospf interface命令，查看接口状态是否UP，如果接口状态为DOWN，那么邻居状态为空。
  接口状态UP：➔步骤4。
  接口状态DOWN：
  检查接口是否人为shutdown：通过no shutdown开启端口。
  
  接口的类型/工作模式是否一致：修改接口类型、工作模式为一致。
  
  检查OSPF相关配置参数是否正常。
  登录协议栈，执行show ospf interface命令，在OSPF实例下执行show this命令检查配置参数。
  是：➔步骤5。
  否：修正参数。
  
  
  链路两侧OSPF路由器的接口IP应在同一网段，掩码应一致，否则邻居状态为空。
  链路两侧OSPF路由器的Area ID应一致，否则邻居状态为空。
  链路两侧OSPF路由器的区域类型不能冲突，如stub和nssa等，否则邻居状态为空。
  链路两侧OSPF路由器的接口MTU应保持一致，否则接口一直处于EXCHANGE-START状态。配置命令如下：
  
  链路两侧OSPF路由器的接口hello、dead间隔应保持一致，如本端hello、dead间隔为10、40，对端也应为10、40，否则邻居状态为空。配置命令如下：
  
  
  检查链路两侧OSPF路由器的接口是否被passive，如配置，请去掉passive配置，否则邻居状态为空。配置命令如下：
  
  链路两侧OSPF路由器的router-id应不同，否则邻居状态为空。
  接口认证类型及认证秘钥应一致，否则邻居状态为空。
  检查本对端接口MAC地址是否一致。
  在建立邻居的过程中，OSPF协议的数据包存在单播包交互过程，因此存在MAC地址不一致状况，可通过抓包进行查看。
  本对端接口MAC地址匹配：➔步骤6。
  本对端接口MAC地址不匹配：➔查找MAC地址不匹配原因。
  
  若采用私网OSPF进程，检查接口是否使能VRF属性、接口是否添加到OSPF VRF实例中。
  接口使能了VRF属性、且接口已添加到OSPF VRF实例：➔步骤7。
  接口未使能VRF属性或接口未添加到OSPF VRF实例：修正配置。
  接口使能VRF属性的命令如下所示：
  
  将VRF接口注册到OSPF VRF实例中的命令如下：
  
  检查协议收发包是否正常。
  对于OSPF协议，可通过登录telnet 127.1 4604端口，打开数据包调试开关，查看协议数据包的收发状况。
  端口4604用于ospfv2协议主控信息的查看，4604中也可以查看warn和err历史日志，每项最多纪录300条，通过命令show log warn或show log err进行历史日志查看，也可打印协议运行时的实时debug日志信息，主控板对应4604，备主控板对应4704。
  当打开日志开关后，想要关闭日志开关，若此时有信息不断输出，冲断命令的输入，无须理会，输入完命令后，直接回车即可。可通过no terminal monitor关闭terminal monitor，no debug all或no debug ospf packet关闭debug日志。
  与此同时，也可进一步通过show ospf interface命令查看各接口数据包的统计，命令如下所示：
  
  无异常：➔步骤8。
  存在异常：分析异常原因。如还未解决：➔步骤8。
  通过show ospf neighbor命令查看邻居状态，如果两端均没有任何状态信息，那么表示两端均为收到对端的hello报文，打开hello报文调试开关，查看打印信息，查看是否只有本端发送的hello报文，而没有收到对端的hello报文，如果确定未收到，请根据定位手册继续进行查看；通过no debug all关闭开关。示例如下：
  
  通过show ospf neighbor命令查看邻居状态，如果一端为INIT，一端没有邻居状态，此时表示单通，一端收到了对端的hello报文，而另一端未收到hello报文，请根据定位手册继续进行查看。
  通过show ospf neighbor命令查看邻居状态，如果处于2WAY状态，则查看是否DR/BDR选举失败，如果接口priority配置为0，则不参与DR/BDR选举。具体配置如下：
  
  通过show ospf neighbor命令查看邻居状态，如果一端处于EXCHANGE-START状态，而另一端处于EXCHANGE-START或EXCHANGE状态，表示协议两端均未收到对端的DD报文，或一端收到了重复的DD报文，可通过抓包查看是否收到重复DD报文，或未收到对端DD报文。
  
  通过show ospf neighbor命令查看邻居状态，如果处于LOADING状态，可能未收到对端的LSU（lsa-update）报文。首先登陆4604，通过show ip ospf neighbor private命令查看链表中还有1个LSR，对端没有回复。
  
  登录4604打开LSR、LSU报文的打印开关，查看报文收发状况，发现自身设备有发送的LSR，但是对端未回复LSU。
  
  抓包查看报的收发状况，查看本端发送的LSR具体的报文，然后查看对端是否回复相应的LSU报文，如果本端设备抓包能够看到发送了LSR给对端，并接收到了对端的LSU报文，那么表示数据包未上送，请根据定位手册继续进行查看问题；本端发送LSR报文，抓包如下：
  
  如果本端设备LSR和LSU均能看到，那么对端进行抓包查看是否有接收到LSR或发出LSU，如果没有，那么查看底层数据转发是否存在问题；对端收到LSR报文，抓包如下：
  
  如果对端抓包能够收到LSR但是未回复LSU，那么同样的方式登录4604打开LSR、LSU报文的打印开关，查看报文收发状况；对端未回复相应的LSU报文（观察LSA），抓包如下：
  
  汇总相关信息，联系烽火工程师。
  
  设备学习不到OSPF路由
  故障现象
  常见的设备学习不到OSPF路由故障现象如下：
  设备OSPF邻居正常建立，但是没有所需的路由。
  可能原因
  现网设备学习不到OSPF路由故障，原因一般有以下几个方面：
  原因类型
  原因详述
  
  配置问题
  接口网络类型不一致导致路由计算错误
  ldp-igp同步导致接口代价出现65535值，影响路由计算
  配置了路由过滤，控制了所需路由的发布和接收
  配置了stub域，导致无法引入自治系统外部路由
  配置了数据库超限，导致数据库缺少对应的LSA，未进行路由计算
  配置的骨干区域被分割，导致部分summary-lsa无法计算路由
  非骨干区域与骨干区域不相邻，导致部分summary-lsa无法计算路由
  私网重分配，导致无法引入自治系统外部路由
  
  链路问题
  链路异常
  
  定位思路
  针对设备学习不到OSPF路由故障，总体定位思路如下：
  排除链路异常。
  排除链路两端接口网络类型不一致导致路由计算问题。
  排除ldp-igp同步导致接口代价出现65535值，影响路由计算问题。
  排除路由过滤规则引起的路由计算问题。
  排除stub区域引起的外部路由计算问题。
  排除数据库超限引起的外部路由计算问题。
  排除骨干区域分割引起的域间路由计算问题。
  排除骨干区域与非骨干区域不相邻引起的域间路由计算问题。
  排除重分配私网，引起的外部路由计算问题。
  汇总信息，联系烽火工程师。
  故障处理流程
  EMBED Visio.Drawing.11
  操作步骤
  检查相应线路是否存在异常。
  无异常：➔步骤2。
  有异常：解决链路问题。
  检查链路两端接口网络类型是否一致。
  登录协议栈，执行show ospf interface命令，查看接口网络类型。
  
  接口网络类型一致：➔步骤3。
  接口网络类型不一致：修改配置。
  
  接口cost是否出现65535值。
  当接口使能了ldp-igp同步，同时LDP会话为DOWN状态时，系统将该接口的COST值置为65535，实现路由重新计算，确保LDP会话中断时路由、LSP同步切换。
  登录协议栈，执行show ospf routes命令，查看cost值。
  
  未出现cost值是65535：➔步骤4。
  出现65535cost值：
  如果确定需要配置，那么参考LDP故障定位及处理章节恢复LDP会话后，路由计算就会正常。
  如果在无需同步的情况下，去除同步功能即可。配置如下：
  
  检查路由中是否配置了路由过滤规则，控制了某些路由的发布或接收，导致路由计算不正常。
  路由表中条目不全，但数据库中lsa数据正常时，需要检查是否配置了路由过滤规则，access-list或者prefix-list，如果有路由设定在access-list或者prefix-list中，该路由将学习不到。
  未配置路由过滤规则：➔步骤5。
  配置了路由过滤规则：修改配置。
  以prefix-list为例，如果本端配置路由规则，对端未配置，那么查看本端路由过滤规则如下：
  
  本端路由表如下所示：
  
  对端路由表如下：
  
  检查是否将ospf区域类型配置成stub区域。
  此区域类型是无法引入自治系统外部路由。
  否：➔步骤6。
  是：请检查该区域类型是否必须配置，如果不是，修改配置。
  
  检查是否配置有数据库超限功能。
  配置数据库超限功能会对5类LSA（AS-External-LSA）进行数量限制，从而影响自治系统外部路由计算结果。
  
  未配置：➔步骤7。
  配置：请检查数据库超限功能是否必须配置，如果不是，修改配置。
  未配置数据库超限功能，路由表示例如下：
  
  配置数据库超限后，路由表路由如下：
  
  检查骨干区域是否被分割。
  骨干区域0被分割，会导致部分3类LSA（summary-lsa）无法计算路由。
  若不是：➔步骤8。
  若是：修改配置。
  检查非骨干区域是否与骨干区域不相邻。
  骨干区域0与非骨干区域不相邻，会导致部分3类LSA（summary-lsa）无法计算路由，可登陆4604，通过命令show ospf process details查看路由器是否是ABR。
  
  若不是：➔步骤9。
  若是：保证非骨干区域与骨干区域相通，修改配置。
  是否重分配私网路由。
  重分配私网路由，会导致无法引入自治系统外部路由。
  若不是：➔步骤10。
  若是：修改配置，通过show running查看配置，重分布私网路由如下所示：
  
  汇总相关信息，联系烽火工程师。
  
  网元配置下发失败定位及处理
  背景信息
  网元配置是设备上管的最基础操作，是将网元设备的基本配置信息通过网管下发给设备，根据组网的要求赋予网元设备基本属性。
  网元配置通过管理DCN通道+Netconf配置协议下发给网元。子网配置最终也是网管后台计算后，分配到各个网元形成网元配置后下发的。
  故障现象
  常见的网元配置下发失败故障现象如下：
  网元基础配置下发失败。
  可能原因
  现网网元配置下发失败，原因一般有以下几个方面：
  原因类型
  原因详述
  
  通信问题
  IP配置错误
  通信链路故障
  
  服务故障
  服务器服务故障
  
  网管仿真
  网管仿真功能是否开启
  
  设备问题
  设备配置冲突或者报错
  
  定位思路
  针对网元配置下发失败，总体定位思路如下：
  ping不通设备IP，检查ip配置是否正确，服务器网卡IP是否与ma网元的IP在同一网段，服务器是否添加静态路由。
  查看网络NNI端口是否有RLOS告警，是否有收发光。
  查看服务器服务，相关服务是否完全开启。
  查看网管仿真功能是否关闭，查看网管日志和设备底层是否有下发和反馈。
  故障处理流程
  EMBED Visio.Drawing.15
  操作步骤
  检查网元是否脱管。
  网元脱管：➔可以参考1.1网元开通和脱管故障定位与处理章节继续处理。
  网元未脱管：➔步骤2。
  检查网管服务是否正常。
  参考附录B 网管服务器异常处理，核查netconf服务（如下图）是否正常。
  
  查看网管仿真功能是否关闭，如果未关闭，需要关闭。
  仿真开关位置：D：\UNM2000\server\etc\platform-options， 其中的test中前两项改为：
  
  服务器通信网卡MTU值大于设备通信网卡MTU值，导致服务器与设备之间交互发生丢包。
  打开网管服务器命令管理器（cmd），执行netsh interface ipv4 show subinterfaces查看下网卡名。
  
  通过netsh interface ipv4 set subinterface "NIC4" mtu=1400 store=persistent 修改mtu值 ，其中NIC4为设备和网卡的交互网卡名。
  分析网管和设备交互的日志。
  请参考附录C控制命令/状态查询/配置下发失败时日志分析的方法分析。
  汇总相关信息，联系烽火工程师。
  
  
  网元状态命令行查询失败定位及处理
  背景信息
  网元状态命令行是通过网管查询 网管接口状态、业务状态、保护倒换状态、协议状态、路由状态和时间状态等常用状态的查询接口，集成程度高、涉及范围广、使用频率高，在设备正常运行和维护过程中作用十分重要。
  故障现象
  常见的网元状态命令行查询失败故障现象如下：
  查询的状态不能上报。
  可能原因
  现网网元状态命令行查询失败，原因一般有以下几个方面：
  原因类型
  原因详述
  
  设备异常
  设备异常掉管，如掉电、通信中断等
  
  服务异常
  netconf服务异常
  
  MTU值设置错误
  服务器通信网卡MTU值大于设备通信网卡MTU值，导致服务器与设备之间交互发生丢包
  
  定位思路
  针对网元状态命令行查询失败，总体定位思路如下：
  由于现网设备异常，导致通信中断，使得网元状态不能上报。
  Netconf通道服务异常，导致netconf通道异常，不能正常上报网元状态。
  服务器通信网卡MTU值大于设备通信网卡MTU值，导致服务器与设备之间交互发生丢包。
  故障处理流程
  EMBED Visio.Drawing.15
  操作步骤
  检查网元是否脱管。
  网元脱管：➔可以参考1.1网元开通和脱管故障定位与处理章节继续处理。
  网元未脱管：➔步骤2。
  检查网管服务是否正常。
  参考附录B 网管服务器异常处理，核查netconf服务（如下图）是否正常。
  
  查看网管仿真功能是否关闭，如果未关闭，需要关闭。
  仿真开关位置：D：\UNM2000\server\etc\platform-options， 其中的test中前两项改为：
  
  服务器通信网卡MTU值大于设备通信网卡MTU值，导致服务器与设备之间交互发生丢包。
  打开网管服务器命令管理器（cmd），执行netsh interface ipv4 show subinterfaces查看下网卡名。
  
  netsh interface ipv4 set subinterface "NIC4" mtu=1400 store=persistent，其中NIC4为设备和网卡的交互网卡名。
  分析网管和设备交互的日志。
  请参考附录E	控制命令/状态查询/配置下发失败时日志分析的方法分析。
  汇总相关信息，联系烽火工程师。
  
  告警相关故障定位及处理
  背景信息
  SPN设备告警通过管理平面DCN通道达到网管，承载于采用UDP传输的私有协议WS-NMU之上，告警净荷经过了PB技术进行了加密与封装，告警上送需要保证网管管理IP地址跟每个网元的loopback1020口IP地址路由可达。
  SPN设备告警支持实时主动上送网管，并与网管之前采用缓存-确认-重传机制保障告警数据传输可靠性。另外辅助手动同步告警查询功能进行网管与设备之间告警对账，消除网管与设备告警不一致问题，在网管判断与设备断联后再次恢复通信时，网管会主动向设备获取告警数据，防止告警数据丢失或者残留；反之设备在判断与网管告警差异时，也会主动向网管请求告警数据同步动作，保证网管与设备告警数据的一致性。
  SPN设备告警支持屏蔽、反转、防抖、抑制等等多种高级功能特性。
  故障现象
  常见的SPN设备告警故障现象如下：
  网管上出现告警丢失的问题，表现为网管上告警无法结束或者无显示。
  可能原因
  现网SPN设备告警故障，原因一般有以下几个方面：
  原因类型
  原因详述
  
  配置问题
  网管服务器上框视图中没有配置对应的单盘
  网管服务器与设备未校时，时间差异很大
  网管服务器下发相应的告警屏蔽配置
  网管服务器进行了告警反转操作
  网管服务器心跳帧下发间隔大于1分钟
  网管服务器管理IP设置不正确
  网元类型配置错误
  
  网络问题
  网管服务器管理IP与设备网元IP之间PING不通或者PING 1518大包不通
  
  设备问题
  告警被平台抑制策略抑制住了
  设备7889端口 UDP socket没有建立成功
  设备检测网管管理IP状态失效
  设备上报的盘类型与网管不一致
  设备上报了盘通信中断或者不在位告警
  
  定位思路
  针对网管上告警丢失问题，总体定位思路如下：
  从网管服务器上PING设备网元管理IP地址，最好PING1518字节大包，初步检测一下是否是网络问题。
  查看网元是否处于正常态，网元类型配置是否正确，框视图对应单盘是否已经加载，设备与网管的时间是否一致，网管通信配置界面网管IP及协议是否选择正确。
  登录到设备命令行界面，查看设备上告警与网管是否一致，查看是否下发屏蔽配置，告警反转操作，告警是否被抑制。
  如果以上步骤都正确，联系烽火工程师处理，直到问题解决。
  故障处理流程
  EMBED Visio.Drawing.11 \* MERGEFORMAT
  操作步骤
  检查一下网管与设备之间网络情况，Ping 1518大包。
  在网管服务器的（CMD命令管理器）中执行ping x.x.x.x -l 1518，其中x.x.x.x为故障网元loopback1020口IP地址。
  确认一下网管与设备网元之间路由是否可达，同时明确大包也可正常到达并且不丢包，排除网络层面的原因导致设备告警丢失。
  如果设备IP不可达，请联系烽火工程师或按照1.2管理平面DCN故障定位与处理章节进行排查。
  检查网管上网元是否为正常态。
  一般在工程开通初期，网元会被设置为工程态，此状态下网管不接受该网元任何告警，只有在正常态下，网管才接受设备告警。
  可在网管右键单击故障网元，在弹出的快捷菜单中选择“告警事件”→“管理工程态”→“修改工程态”，检查网元状态，如下图所示。
  
  
  检查网元类型是否选择正确。
  网管管理网元种类多，不同网元类型对应的管理协议可能不一样的，网元类型选择不正确，也会导致网管与网元之间通信协议不匹配，从而引起告警丢失。
  可在网管右键单击故障网元，在弹出的快捷菜单中选择“网元属性”菜单，在属性最上面可以看到配置的网元类型，检查与实际设备网元类型是否一致，如下图所示。
  
  检查网管框视图中是否添加了对应槽位的单盘，以及盘类型匹配。
  网管上必须在框视图中对应槽位上添加了单盘。设备告警上报网管都携带槽位信息，若网管上没有配置相应槽位，网管会因为找不到匹配槽位丢弃告警，同时网管也不会查相应槽位上的告警数据，左键双击故障网元，即可查看框视图，检查对应槽位是否配置单盘，以及单盘名称是否与实际相符。
  可以通过登录网元管理IP，进入设备命令行界面，查看告警所属单盘槽位，及设备上实际的单盘名称。
  
  
  检查网管与设备网元的时间、时区设置、夏令时是否一致。
  若设备与网管时区、夏令时、时间设置不一致，设备与网管时间差异大，从而导致设备上报的告警会被误判断过期告警被丢弃掉，网管上告警丢失。
  设备时间状态通过如下操作查看：
  
  如果不一致，需要手动设置与网管保持一致。
  排查设备上保存的告警与网管是否一致。
  通过以下命令查看设备上保存告警，比较设备告警与网管是否存在差异。
  
  如果设备与网管上告警是一致的：➔再检测设备上告警是否因为被屏蔽、反转、抑制了，导致告警无法显示。
  
  
  
  如果设备与网管不一致：➔可以将设备/dev/shm/fos/log/logfile/nem-4.log拷贝出来，或者在网管上抓包，联系烽火工程师排查。
  汇总相关信息，联系烽火工程师。
  
  性能上报故障定位及处理
  背景信息
  SPN设备性能通过管理平面DCN通道达到送至网管，其中查询命令承载于采用UDP传输的私有协议WS-NMU之上，性能数据净荷经过了PB技术进行了加密与封装，生成性能文件，由设备通过FTP协议主动推送到网管，因此性能命令与性能数据是分开传送的，性能上送同样需要保证网管管理IP地址跟每个网元的loopback1020口IP地址路由可达。
  SPN设备性能从归属上分为网元性能与单盘性能，其中网元性能需要在网元界面才可以查询，单盘界面只能看到单盘性能，网元界面既可以看到网元性能也可以看到单盘性能。SPN性能从时标上分有当前15分钟性能、当前24小时性能、上电累计性能、1~16个历史15分钟性能、1个24小时性能，对于以上时间段，设备可以统计相应性能的最大、最小、平均值。
  SPN性能尤其是逻辑接口、子接口、业务性能都是通过开关控制，需要先下发性能开关才设备才可以采集的，默认是不采集的；SPN性能支持性能屏蔽、性能清零等高级特性，也支持特色的秒级流量性能采集。
  故障现象
  常见的SPN设备性能故障现象如下：
  网管上出现性能丢失的问题，现象表现为网管上无法查询性能，或者无法查询某一特性性能，或者某一特定时间段的性能。
  可能原因
  现网SPN性能丢失故障，原因一般有以下几个方面：
  原因类型
  原因详述
  
  配置问题
  网管服务器上是否安装有防火墙
  网管服务器上文件FTP传输服务是否开启
  网管服务器上下发了相应的性能屏蔽配置
  网管服务器上未使能性能开关
  网管服务器上未下发相应的性能查询命令
  
  网络问题
  网管服务器管理IP与设备网元IP之间PING不通或者PING 1518大包不通
  
  设备问题
  设备7889端口 UDP socket没有建立成功
  设备性能文件未生成
  FTP传输时源IP未设置为网元管理IP
  FTP协议传输失败
  
  定位思路
  针对网管上性能丢失问题，总体定位思路如下：
  从网管服务器上PING设备网元管理IP地址，最好PING1518字节大包，初步检测一下是否是网络问题。
  查看网管服务器上防火墙是否关闭，网管FTP服务是否正常，网管上性能采集开关是否打开，检查网管服务器目录下是否有性能文件。
  登录到设备命令行界面，查看设备上性能是否存在，性能文件是否生成，抓包确认FTP源IP是否为网元管理IP、以及确认FTP传输是否异常。
  如果以上步骤都正确再联系烽火工程师处理，直到问题解决。
  故障处理流程
  EMBED Visio.Drawing.11 \* MERGEFORMAT
  操作步骤
  检查一下网管与设备之间网络情况，Ping 1518大包。
  在网管服务器的（CMD命令管理器）中执行ping x.x.x.x -l 1518，其中x.x.x.x为故障网元loopback1020口IP地址。
  确认一下网管与设备网元之间路由是否可达，同时明确大包也可正常到达并且不丢包，排除网络层面的原因导致设备告警丢失。
  如果设备IP不可达，请联系烽火工程师或按照1.2管理平面DCN故障定位与处理章节进行排查。
  检查网管服务器上防火墙是否为关闭态。
  网管服务器防火墙会阻止设备性能文件传输，这里必须选为关闭状态。
  
  检查网管服务器上FTP服务是否开启。
  观察网管FTP服务器是否启动。
  如果网管FTP服务已经启动，但是设备无法连接FTP，基本可以定位为FTP服务问题，可联系协议栈或者FTP模块进行排查。
  
  检查网管上对应业务的性能开关是否打开。
  除了物理接口之外，所有逻辑主接口、子接口、业务性能开关都是默认关闭的，若要采集性能必须先打开对应的性能开关，如下图所示。
  
  检查网管服务器上对应的目录是否有性能文件生成。
  性能数据都是通过FTP传输到网管服务器的，其中网管服务器上当前性能文件目录：
  
  历史性能文件目录：（特别注意：历史性能需要网管开启性能采集任务，网管每隔15分钟向设备捞一次数据，在网管界面点击历史性能查询，都是查询的网管数据库中数据）
  
  只要网管执行查性能的操作，网管上就会有新的性能数据文件产生，如果没有产生新的性能文件，可先通过抓包（网管服务器管理IP所在端口）看网管是否有给设备下发性能查询命令，如下图所示：
  
  注意：性能查询是JC0421 0E，告警是JC0421 0D。
  如果无则联系网管查看；如果有查询命令，但是网管上还是没有文件产生，继续下面的步骤排查。
  
  排查设备上性能及文件是否生成。
  登录设备后，通过下面的命令，可以查看设备上保存的性能数据，通过不同参数进行过滤，可以查看所有时间段的性能。
  
  如果性能项太多，不方便浏览，还可以通过Obj Name和Wskey进行精准查询，如下图所示。
  
  如果所查询的性能项在设备上都没有，则直接联系烽火工程师排查。
  如果所查性能项设备存在，则继续排查设备上的性能文件是否更新了。
  在网管上下发查询性能操作，设备也会生成对应的性能文件的，如下图所示，设备上的性能文件需要转登录到OS操作系统查看。
  路径为：/dev/shm，对应的文件名为pbperfm.dat和ne_pbperfm.dat，前者为单盘性能文件，后者为网元性能文件，关注性能文件的时间是否与网管查询操作一致，如果相差比较大，请联系烽火工程师排查。
  
  检查FTP传输性能文件时源IP是否指定为网元管理IP。
  在网管服务器设备管理网卡上抓包后，通过下图的条件进行过滤，其中ip为故障网元的管理IP，这样可以检查源IP的正确性，同时可以查看FTP握手确认过程、以及数据传输过程是否正常。
  
  
  汇总相关信息，联系烽火工程师。
  
  
  控制面故障定位及处理
  介绍控制面故障的定位及处理。
  PCEP连接中断故障定位及处理
  ISIS邻居状态异常故障定位及处理
  ISIS路由故障定位及处理
  SR-TP配置下发故障定位及处理
  控制面DCN故障定位及处理
  PCEP连接中断故障定位及处理
  背景信息
  PCEP（Path Computation Element Protocol）是由IETF的PCE工作组于2006年为MPLS网络域间流量工程（即显式路由）等应用提出的，以支持集中化的路径计算。
  PCE工作组的体系结构基于两个核心功能模块：PCC（Path Computation Client）部署在路由器等数据平面节点上，在控制平面上则部署PCE服务器，实现路径计算单元PCE（Path Computation Element），负责计算来自PCC的路径计算请求。
  PCEP则是为PCE和PCC之间通信而提出的相关通信协议。PCEP协议定义了PCC与PCE交互过程中的消息报文格式及其相关作用，其中包括会话初始化、请求回复、安全管理、状态通知、出错反馈等。
  基于转控分离的思想，PCEP提出了从PCE下发lsp路径的标准，也就是实现动态创建，删除，修改lsp路径的功能。
  故障现象
  在设备发起连接后，通过show查看，连接状态为false。pcep连接不正常。
  
  可能原因
  PCEP连接故障问题，原因一般有以下几个方面：
  原因类型
  原因详述
  
  配置问题
  设备ip配置有问题，导致ping不通服务端
  部分需要绑定本地ip的场景没有绑定本地ip
  服务端没有监听4189
  绑定本地ip出错，将网管ip作为本地ip绑定
  服务端是否阻塞，导致tcp不成功
  
  设备问题
  PCC未获取设备的uuid，这种情况pcep连接不会成功
  
  协议异常
  open消息不正确，导致接收后直接断开连接
  当下发的配置报文格式不符合标准报文时（长度不对），会出现断连
  
  其他问题
  网管长时间不回任何消息（包含keepalive，超过2分钟）消息会出现断连
  设备路由断开导致pcep连接成功
  
  定位思路
  针对PCEP连接故障问题，总体定位思路如下：
  首先通过ping服务端ip，确定大体方向。
  如果ping通，则看服务端是否监听4189，在设备上检查配置是否正确。
  在通过抓包和在8800通过调试函数查找定位。如果都没有问题，最后可以通过看出日志进行定位。
  故障处理流程
  EMBED Visio.Drawing.11
  操作步骤
  ping对端ip，看是否能够ping通，如果带vrf需要加上vrf进行ping。
  能ping通：➔步骤2。
  ping不通：需要找相关模块定位，或者测试人员看下环境搭建是否正常。
  
  有的实际网络情况需要加上本地ip才能ping通，这个时候PCC需要先绑定本地ip。
  
  在PCC视图下面，通过show this可以看到自己绑定的本地ip和连接服务器的ip。
  其中：bind local-ip 为绑定的本地ip地址、connect server 为连接的服务端的ip地址。
  注意：
  绑定ip时，不要绑定网管ip为本地ip，否则会绑定失败，导致tcp连接失败。
  在配置了vrf后，PCC在连接服务端连接时要加上vrf。
  
  
  在服务端查看是否监听端口4189。
  如果没有监听4189，则需要打开。
  
  服务端是否阻塞，可以通过相关命令进行查看，看是否有很多处于异常状态的tcp套接字（比如close_wait）。
  
  以上情况都正常的话，则需在服务端进行抓包，通过抓包报文进行初步定位。
  Tcp连接失败，如下图，下面配图关键字是server 端发送了 RST报文，导致连接建立不成功，需要网管专家介入排查。
  
  Open交互完成后，由设备发送close报文，主动断连，这一般是open报文有问题（报文长度不符合规范，报文格式不符合规范），需要网管专家介入自查open报文。
  PCEP未获取uuid，PCEP在还未获取uuid的情况下，不会连接服务端，不过会通过定时器定时判断是否获取uuid，在获取uuid后，在连接服务端。（此场景很少出现）
  这个可以根据日志来判断。（一般记录在nem_4.log中）
  日志中会打印"please wait for get the uuid then connect the ip. "这句话。
  通过调试函数定位闪断重连情况。
  8800里面也有一些相关调试函数（有些场景默认进去的就是9000，这时需要ostelnet出来，再进入8800），这些主要是用来定位pcep连接上后出现的闪断重连情况，如下：
  
  pcc_session_show() 显示当前会话信息；用来辅助定位当前会话状态。
  pcc_show_sck_snap_info() 记录当前pcep是否断过连接，里面只有断连的时候会记录，主要断连的相关信息，其中node_no为断开节点数，每次断开都会新增一个节点，记录最新的30次断开记录。
  
  
  汇总相关信息，联系烽火工程师。
  ISIS邻居状态异常故障定位及处理
  背景信息
  ISIS邻接有三种状态：Down、Init和UP。
  Down：收到对端发送过来的Hello报文，但其中有些配置不正确。
  Init：收到对端发送的Hello报文，但是报文中没有邻居节点的ID。
  UP：邻接正常建立。
  Broadcast网络类型的邻接状态说明：
  
  System Id：邻居节点的系统ID
  Interface：建立邻接的接口
  State：状态，UP、Init、Down
  Type：邻接类型 Level-1、 Level-2
  Priority：只有Broadcast类型的邻接才有该值，表示邻接接口的优先级，该值用于选举DIS
  Circuit ID：DIS ID，只有Ethernet类型的邻接才有该值
  Up Time：邻接UP到现在的时间
  Point-to-point网络类型的邻接状态说明：不同之处就在于Priority和Circuit Id。
  
  故障现象
  通过show isis neighbor或show clns neighbor命令看不到邻居。
  show clns is-neighbors或show clns neighbor命令回显中ISIS邻居状态不为UP，而是显示“Init / Down”等状态。
  可能原因
  现网ISIS邻居状态异常故障，原因一般有以下几个方面：
  原因类型
  原因详述
  
  配置问题
  物理链路故障
  System-ID冲突
  接口IP地址，接口下使能地址族类型不一致
  Level和网络类型不匹配
  MTU配置问题
  MAC地址冲突
  接口vrf与所绑定实例vrf是否匹配
  
  单盘问题
  有如下异常告警：
  TEMP_OVER(单盘温度过高)
  COMFAIL（单盘通信中断）
  UNCORR_MEM_ECC_ERR（存储单元不可恢复奇偶校验错误）等相关相关告警
  
  协议异常
  直连链路异常
  单盘信令通道CRC
  链路CRC
  
  定位思路
  针对ISIS邻居状态异常故障，总体定位思路如下：
  逐步排除法：
  确认当前路由器与哪些邻居建立异常。
  ping异常邻居的直连接口IP地址，排除物理链路故障、端口IP配置错误。
  检查接口状态是否UP、接口IP、MAC配置正确。
  检查接口相关的Level、网络类型、ISIS使能、MTU配置是否正确。
  检查Level-1邻接的区域ID是否一致、系统ID是否重复。
  检查ISIS协议使能是否正确。
  检查是否因BFD联动导致ISIS邻接故障。
  抓包或者查看日志进行故障定位法：
  通过抓包或者查看日志查看ISIS Hello包的收发情况，定位邻居不能正常建立的原因，再参考逐条介绍的方法排除故障。
  日志开启方式：
  首先在9000端口中进入诊断模式，打开zsniffer开关。
  
  克隆当前窗口，进入ISIS调试端口4602，并进行debug和打印。
  
  结束debug命令：no debug isis ，结束打印命令：no terminal monitor观察输出的日志，可以很快的判断收发包的情况，以及各种可能的错误。
  日志中可能出现的一些错误提示信息说明如下表：
  日志信息
  详细说明
  
  same source ID from
  表示收到的Hello报文系统ID重复
  
  source ID mismatch from
  表示收到的Hello报文的系统ID发生了改变
  
  SNPA addresse is different
  表示收到的Hello报文的源mac地址发生了改变，一般是网络拓扑中一个接口同时和两个接口直连
  
  authentication failure
  表示认证失败
  
  circuit ID mismatch
  表示circuit ID发生了变化，一般GR失败可能遇到这样的问题
  
  circuit-type mismatch
  表示circuit type不匹配
  
  circuit-type change
  表示circuit type发生了变化
  
  area address mismatch
  表示Level-1邻接的区域ID不同
  
  Neighbor System ID mismatch in 3Way TLV
  对端发送过来的Hello报文中的邻居系统ID字段与本端的系统ID不一致。一般GR失败可能出现这样的问题
  
  Extended Circuit ID mismatch in 3Way TLV
  扩展Circuit ID字段发生了变化。一般GR失败可能出现这样的问题。
  
  IPv4 protocols supported mismatch
  本端没有使能IPv4的ISIS协议，而对端使能了
  
  IPv4 interface address mismatch
  IPv4接口地址不在一个网段内
  
  IPv6 protocols supported mismatch
  本端没有使能IPv6的ISIS协议，而对端使能了
  
  IPv6 interface address mismatch
  本端无IPv6链路本地地址
  
  Invalid Three-Way Handshake state
  无效的三次握手状态，只有点对点链路会有该问题
  
  抓包方式
  可在接口或OS系统上抓包，抓包及分析方法参考CiTRANS R800设备抓包及分析方法。
  在本端接口上抓包，若无本端发送的Hello包，通常ISIS配置存在问题；检查协议使能是否正确、VPN绑定是否正确、接口的MTU值是否大于ISIS Hello报文的大小。
  在本端接口上抓包，可以抓到自身发送的报文，而在操作系统OS上抓不到，则可能是OS的故障，或者OS MTU值不匹配。
  在本端接口和OS上均能抓到自身发送的报文，但是在对端的OS上抓不到，可能是底层转发平面故障，或者对端OS MTU值不匹配。
  在本端接口上、在本端OS上、在对端OS上可抓到自身发送的报文，但在对端的接口上抓不到，则可能是对端OS转发存在故障。
  在本端接口上、本端OS上、对端OS上、对端接口上均可抓到本端发送的报文，可能是协议配置不正确导致的邻接无法建立，或者协议接口的MTU值不匹配。
  
  故障处理流程
  EMBED Visio.Drawing.11
  操作步骤
  确认当前路由器与哪些邻居建立异常。
  通过show isis neighbor命令查看当前路由器回显信息中，是否有所有邻居（直连节点）的条目，并且“state”均为UP。
  条目正常且状态均UP：说明邻居建立正常。
  缺失某些邻居条目或某些邻居状态始终无法UP：➔步骤2。
  ping异常邻居的直连接口IP地址。
  Ping不通：➔步骤3。
  能ping通：➔步骤4。
  检查接口状态是否UP、接口IP配置正确。
  正常： ➔步骤4。
  不正常： 排除链路故障或修正配置。若故障仍未解决，➔步骤4：
  通过show isis interface查看接口状态，下图所示表明接口物理状态、协议状态均down，原因可能是接口被人为shutdown、或者link down。查看接口配置，如果接口被shutdown，则在接口下配置命令no shutdown；如果接口link down，则排除链路故障。
  
  检查对接端口是否处于同一网段。如果使能的是IPv6的ISIS协议，则检查两个接口上是否都有IPv6的链路本地地址。
  如果两端的IP地址不在一个网段，则修正配置。配置命令：ip address x.x.x.x/masklen。
  如果使能了IPv6 ISIS协议，却没有IPv6的链路本地地址，则在接口下配置ipv6 address auto link-local。
  检查接口相关的Level、网络类型、ISIS使能、MTU配置是否正确。
  正确： ➔步骤5。
  不正确：修正配置；若故障仍未解决，➔步骤5。
  检查Level配置：
  接口电路类型要匹配：例如实例为level-2，而接口电路类型是level-1，则该接口无法正常发送ISIS的Hello报文，邻接无法建立；若实例为level-1-2，而接口电路类型是level-1或level-2或level-1-2，则可建立邻接关系。
  本对端的level不能冲突：例如本端level-1，另一端为level-2，则邻接无法建立；但Level-1-2的类型可以同时支持level-1和level-2。假如一端可建立的邻接是level-1，另一端可建立的邻接为level-1-2，则可以建立level-1的邻接。
  接口的isis circuit-type查看示例如下：
  
  ISIS实例中的is-type查看示例如下：
  
  通过show isis interface检查接口是否使能ISIS协议，若未使能，在isis实例下声明等待建邻的接口：
  
  检查两端的网络类型是否一致。
  查看接口下的ISIS网络类型，两端一致即可。要么同为broadcast，要么同为point-to-point。
  如果网络类型不一致，在实例接口下修改网络类型，网络类型缺省值为Broadcast。
  
  检查两个邻居节点直连接口的MTU值是否一致。
  如果两个邻居节点直连接口的MTU值不匹配，则会导致ISIS邻接无法正常建立，或者LSDB无法同步。下图所示接口的MTU值为1500：
  
  ISIS默认是使能Hello Padding的，发送的Hello报文是按照接口的MTU值大小进行填充的，如果对端接口的MTU值比本端小，则会丢弃该报文，导致邻接无法建立。
  修改接口MTU值命令为：在接口模式下配置mtu MTU值。
  
  如果接口的MTU值设置大于1500，则LSP的接收buffer大小也要相应调整，否则LSP会有丢包，导致LSDB无法同步，从而路由计算不正确。
  调整LSP接收buffer命令：在ISIS实例下配置lsp-mtu < 512-16384>，默认值为1492
  
  检查Level-1邻接的区域ID是否一致、系统ID是否重复。
  正常： ➔步骤6。
  不正常：修正配置；若故障仍未解决，➔步骤6。
  如果要建立的邻接级别为Level-1，则需要确保两端的区域ID相同。如果两端区域ID不同，则在两个站点上用show isis neighbor查看相应的邻居条目均为空。
  两个邻居节点的系统ID不能重复，否则在两个站点上用show isis neighbor查看相应的邻接条目均为空。
  查看net地址的配置：
  
  Net 10.2000.2000.2000.00，后面的倒数第7-2字节2000.2000.2000表示系统ID，系统ID前面的内容10为Area-ID。
  通过no net xxxx.xxxx.aaaa.aaaa.aaaa.00将原先的net地址删除，再用命令net yyyy.yyyy.aaaa.aaaa.aaaa.00配置新的net地址。
  检查ISIS协议使能是否正确。
  正确： ➔步骤7。
  不正确：修正配置，若故障仍未解决，➔步骤7。
  普通ISIS协议使能：
  两端协议使能必须配置正确。要么都为IPv4，要么都为IPv6，要么都为IPv4\IPv6，否则邻接无法建立。在ISIS实例下show this查看两个邻居节点直连接口下的协议使能是否正确。将接口声明进ISIS实例中并选择使能IPV4/IPV6地址族，从而决定建立IPV4/IPV6的邻居。
  
  VPN ISIS协议使能：
  如果是配置VPN ISIS实例，则要求该ISIS实例和接口同时绑定VPN。查看接口上绑定的VRF实例号和实例配置Router isis [ISIS实例名称] vrf [VPN实例名称]中的“VPN实例名称”是否一致，如果不一致，删除配置，重新配置。
  使用命令show isis process可查看ISIS绑定的VRF实例名称。
  
  检查是否因BFD联动导致ISIS邻接故障。
  若不是：➔步骤8。
  若是：参考动态BFD会话无法UP故障定位及处理。
  如果BFD会话配置的不正确或者BFD会话不稳定，反复震荡，将导致ISIS邻接震荡。
  如果发现ISIS邻接震荡，查看BFD会话也在震荡，则先排除BFD会话的故障，参考动态BFD会话无法UP故障定位及处理；查看BFD会话的建立时间，如果比ISIS的会话时间长，则可断定ISIS邻接故障不是由于BFD造成的。
  通过使用show bfd session命令查看BFD会话状态。
  
  汇总相关信息，联系烽火工程师。
  ISIS路由故障定位及处理
  背景信息
  LSDB（链路状态数据库）
  LSDB（链路状态数据库）是网络拓扑信息和可达信息的集合。只有所有路由节点的LSDB达到同步状态、完全一致，路由计算的结果才会正确。
  链查看链路状态数据库信息命令：show isis NAME database。该命令可以查看LSDB是否完整：通过查看LSPID一列是否完整列出所有节点判断；若某条LSP的 Seq Num 每次刷新都不同时，说明该节点邻接不正常。
  
  LSPID：系统ID+伪节点ID+分片ID，后面的*号表示该LSP是自身生成的。LSP Seq Num：LSP报文的序列号。
  LSP Checksum：LSP报文的校验和。
  LSP Holdtime：LSP剩余生命时间。
  ATT/P/OL：几个标志位，ATT置1表示与另一个区域相连；P表示区域分割，暂不支持；OL表示超载位。
  LSDB（链路状态数据库）说明。
  如果LSDB已经同步，但是路由计算结果依然不正确，则需要检查具体的链路状态信息是否正确。
  通过show isis NAME database detail查看LSP中的信息是否正确，通常需关注该LSP的区域地址、接口IP、路由器ID是否与实际配置有冲突，还需关注该LSP邻接的拓扑信息、IP可达信息是否完整/正确、Metric值是否有异常过大或与实际配置不一致的情况。
  
  ISIS日志查看与分析
  如果检查LSDB发现数据库无法同步，则首先排除LSP收发的故障。可以采用日志和抓包的方式进行分析。这里只介绍日志方式。
  9000端口diagnose模式下开启zsniffer开关：
  
  克隆当前会话，进入ISIS调试端口4602：
  
  关闭debug和terminal monitor：no debug isis ，no terminal monitor。
  观察输出的日志，可以很快的判断收发包的情况，以及各种可能的错误。
  日志中可能出现的一些错误提示信息：
  原因类型
  原因详述
  
  received LSP's remaining lifetime is zero
  表示收到的报文生命周期为0，需要检查网络中该LSP的源节点的邻接是否有发生变化：正常的网络拓扑变化、配置变化无需处理；如果邻接状态未发生变化，则检查是否有对该LSP包含的路由撤销的动作，如果有，则为正常。
  
  authentication failure
  认证失败。
  
  checksum error
  校验和检查错误，可能是底层传输差错，可配置（路由模式下） ignore-lsp-errors忽略该检查。
  
  Lifetime is greater than MaxAge
  接收到的LSP的lifetime大于LSP的最大生命周期。检查该LSP源节点的配置，进入ISIS实例下show this查看max-lsp-lifetime，缺省值为1200s，且缺省值默认不显示，两端LSP最大生存时间修改成相同值。
  配置命令：isis实例下max-lsp-lifetime <350-65535>
  
  故障现象
  ISIS邻居正常建立，但是没有相应路由。
  可能原因
  现网设备学不到ISIS路由故障，原因一般有以下几个方面：
  原因类型
  原因详述
  
  配置问题
  系统ID重复
  路由泄漏配置错误
  路由重分发漏配或配置错误
  拓扑连接错误或节点度量模式metric-style不一致，如果一台设备开启宽度量模式，则建邻设备也需同时开启
  ISIS LDP-IGP同步故障
  
  定位思路
  针对设备学不到ISIS路由故障，总体定位思路如下：
  检查System-ID是否重复。
  检查路由泄漏是否配置正确。
  检查路由重分发是否正确，分为IPV4/IPV6两种地址族。
  检查是否存在拓扑连接错误和metric-style不相同的情况，度量模式默认为窄度量。
  检查是否因ISIS IGP-LDP同步引起故障。
  故障处理流程
  EMBED Visio.Drawing.11
  操作步骤
  检查系统ID是否重复。
  不重复： ➔步骤2。
  重复：修正配置；若故障仍未解决，➔步骤2。
  当某些路由无法计算出来或者计算的下一跳不正确，而LSDB中某个LSP的序列号总是在变化，则需要查看网络中是否有两个节点的系统ID重复了，如果是，则修改该节点的系统ID。
  查看net地址的配置：
  
  Net 10.2000.2000.2000.00，后面的倒数第7-2字节2000.2000.2000表示系统ID，系统ID前面的内容10为Area-ID。
  通过no net xxxx.xxxx.aaaa.aaaa.aaaa.00将原先的net地址删除，再用命令net yyyy.yyyy.aaaa.aaaa.aaaa.00配置新的net地址。
  检查路由泄漏配置是否正确。
  正确： ➔步骤3。
  不正确：修正配置，若故障仍未解决，➔步骤3。
  如果在level-1-2实例上将level-2的路由泄漏至level-1，但是其他相连的level-1节点却学习不到相应的路由：
  首先检查level-2的数据库中是否有该路由（参考背景信息中的LSDB说明）；
  如果有，则检查level-1的数据库中是否有该路由可达信息，类似情况如下图所示：
  
  若路由表中无此路由，则检查是否使用了路由过滤策略将此条路由过滤掉了，若是，可以对相应配置进行修改：
  
  检查路由重分发是否正确。
  正确： ➔步骤4。
  不正确：修正配置，若故障仍未解决，➔步骤4。
  如果有将其他协议生成的路由重分发至ISIS，在LSDB中查看配置了重分发的节点对应的LSP中是否有该路由条目的可达信息。
  show isis NAME database verbose中类似于：
  
  Metric值为1000的路由为其邻居重分发过来的路由。
  如果没有可达信息，检查重分发是否配置正确。
  如果是重分发至level-1，则需要明确指定redistribute [协议类型]level-1。
  如果有配置route-map，则需要进一步检查routemap是否将该路由过滤了。
  检查拓扑配置是否正确。
  检查各节点度量模式是否一致。
  各节点度量模式metric-style需统一配置成wide或者narrow。
  路由模式下：metric-style wide或者metric-style narrow。
  检查是否因ISIS LDP-IGP同步引起故障。
  不是： ➔步骤6。
  是：修正配置或参考LDP故障定位排除LDP会话故障；若故障仍未解决，➔步骤6。
  接口未使能LDP，但是协议开启了IGP-LDP同步这种情况会导致ISIS认为IGP LDP一直未同步，从而该接口上的metric值一直是224-2；此时需去掉该接口的ISIS LDP同步配置，或者在该接口上使能LDP，根据需要进行选择。
  去使能IGP-LDP同步命令：
  
  LDP会话down导致ISIS路由计算的metric值很大。此情况查看ISIS会话邻接正常，但是LDP会话状态不正常，路由metric值很大，导致对应路由学习不到。此时需参考LDP故障定位排除LDP会话故障。
  汇总相关信息，联系烽火工程师。
  
  SR-TP配置下发故障定位及处理
  背景信息
  SPN设备实行的是管控分离的方式进行管理，重路由功能是在基于ISIS协议的控制面上实现的，承载的通道为SR-TP隧道。
  故障现象
  常见的SR-TP配置下发失败现象如下：
  PCE ip配置错误。
  PCE服务异常。
  PCE链路侧异常。
  SR-TP业务异常。
  可能原因
  现网SR-TP配置下发失败，原因一般有以下几个方面：
  原因类型
  原因详述
  
  PCE ip配置错误
  PCE服务器ip地址配置错误
  PCE本地ip地址配置错误
  
  服务异常
  PCEService服务异常退出
  
  通信中断
  物理链路异常
  网元配置下发失败
  
  定位思路
  针对SR-TP配置下发失败，总体定位思路如下：
  首先查看网管相关告警，是否因通信中断导致。
  查看服务器服务，PCEService是否正常。
  查看网元配置中PCE服务器连接配置中ip配置是否异常。
  查看网元状态命令行中PCC的本地状态和连接状态是否异常。
  故障处理流程
  EMBED Visio.Drawing.15 \* MERGEFORMAT
  操作步骤
  检查是否因通信中断导致网元配置下发失败。
  详细方法参见1.4网元配置下发失败定位与处理。
  查看服务器是否添加静态路由。
  打开服务器CMD（命令提示符），输入route print，路由表中是否含有相关网元的ip或网段。
  
  查看服务器服务及相关日志。
  PCEService、Netconfserver是否正常。
  服务文件位置：D:\UNM2000\pas\tools\ IceGridGUI.jar
  
  
  查看netconf相关连接日志。
  日志位置：D:\UNM2000\server\log\netconf目录下unm_logger_netconf_cmd_con_[进程id]文件
  
  查看pcep相关日志。
  日志位置：D:\UNM2000\server\log\pcep目录下对应进程ID日志文件
  查看网管仿真功能是否关闭，查看网管日志是否有下发和反馈。
  仿真开关位置：D:\UNM2000\server\etc\platform-options。
  其中的test中前两项改为：
  [TEST]
  enable = false
  OTNM_NE = false
  
  重启UNM2000-NeServer。
  注：邻接标签配置通过netconf通道下发，其他SR业务数据通过pcep通道下发。
  检查PCC本地状态和连接状态是否异常。
  通过网管查询。
  
  通过命令行输入show pcc server info。
  
  检查PCE服务器IP和PCE全局配置下发。
  PCE服务器IP
  
  PCE全局配置
  
  注明：同一个isis下，PCE服务器IP唯一，本地IP每个网元不同。
  汇总相关信息，联系烽火工程师。
  
  
  控制面DCN故障定位及处理
  背景信息
  SPN控制面DCN承载三个基于TCP的应用协议，分别是SR-TP配置下发协议PCEP、链路状态更新和上报协议BGP-LS以及用于性能订阅和采集的Telemetry，控制面DCN需要保证网管控制面IP地址跟跟每个网元的loopback0口IP地址路由可达。
  网管服务器需要配置去往设备控制面的静态路由，路由nexthop为对应的外部DCN网络与网关服务器相连接口IP地址。
  随着网管中心云化、集约化部署的要求，建议外部控制面DCN整体采用三层DCN。外部DCN需要保证网管服务器和每个网元控制IP通信的上下行路由可达（跟管理面DCN分开），
  控制面内部DCN通过ISIS协议打通网元之间的路由；在接入网元上（NPE/SPE节点）需要配置去往网管服务器控制面IP的静态路由，路由nexthop为对应的外部DCN网络与接入网元外部DCN接口相连的接口IP地址，同时将静态路由每个控制面ISIS进程；在SPN网内，管理面内部DCN和控制内部DCN属于不同的VRF。
  控制面DCN的所有配置都是通过管理面配置协议Netconf下发，所以在配置控制面DCN前，要求管理面DCN已经打通。
  EMBED Visio.Drawing.15
  如上图所示，为控制面DCN整体组网图。每一对接入网元负责打通所在ISIS域内所有的网元到网管服务器控制面路由，要求形成保护，网管和网元之间控制面流量双向流量路径一致。
  接入网元选择：外部DCN部署到每个核心汇聚节点和骨干汇聚节点，每个地市选取一对NPE作为接入网元管理核心ISIS进程，同时每一对SPE作为接入网元管理其下挂的所有网元。
  接入网元跟外部DCN物理对接要求：要求接入网元带外口采用以太光口（XGE口），要求外部DCN为每一对接入网元提供10GE的带宽。
  接入网元路由部署：每个接入网元配置去往网管服务器控制IP的静态路由，下一跳为外部DCN设备跟带外口对接的IP，并且将静态路由引入所在每一个ISIS实例；要求接入网元跟外部DCN直连三层设备之间互通BFD，当静态路由下一跳失效时可以及时撤销静态路由，保证路由正常切换。为保证控制面流量双向路径一致，需要对每一对主备接入网元路由的AD值和metric值进行相应的规划。具体如下：
  1）NPE接入网元路由部署。
  核心ISIS进程内所有节点（包括NPE和核心调度节点）流量优先走主用NPE转发，保护走备用NPE转发。
  主用网关NPE配置的静态路由AD为100，cost为40000，该静态路由重分发到ISIS实例（核心ISIS实例，默认实例号为1）时metric为40000；
  备用网关NPE配置的静态路由AD为115，cost为50000，该静态路由重分发到ISIS实例时metric为50000。
  2）SPE接入网元路由部署。
  主备SPE节点及下挂汇聚环、UPE设备流量优先走主用SPE转发，保护走备用SPE转发。
  静态路由和重分布配置：主用SPE配置静态路由AD为100，cost值为默认值，该静态路由需要重分布到除了ISIS实例1之外的其他实例，重分布时metric值为默认值10；备用SPE配置静态路由AD为115，cost为30000，该静态路由需要重分布到除了ISIS实例1之外的其他实例，重分布时metric值为30000。
  ISIS实例重分布：主用SPE将ISIS实例1中的loopback0的路由重分布到其他ISIS实例时cost配置为200；备用SPE将ISIS实例1中的loopback0的路由重分布到其他ISIS实例时cost配置为35000。
  故障现象
  常见的控制面DCN故障现象如下：
  网管服务器无法ping通网元的管理 IP地址
  可能原因
  现网控制面DCN故障问题，原因一般有以下几个方面：
  原因类型
  原因详述
  
  配置问题
  网管服务器上控制面静态路由未配
  网管服务器上控制面静态路由下一跳或者目标网段配置错误
  ISIS接口IPv4地址族未配
  ISIS接口metric类型配置错误（统一为wide）
  ISIS接口网络类型配置错误（比如NNI口配成了broadcast类型，loopback0口配置成了point-to-point类型）
  ISIS level类型配置成了L1或者L1-L2
  接入网元（SPE/NPE）引入的静态路由配置错误
  接入网元匹配去往网管服务器控制网卡IP地址静态路由的目标网段的路由策略和前缀列表配置错误
  ISIS实例1之外的其他ISIS实例重分布静态路由时未选择路由策略
  SPE接入网元匹配loopback0口IP地址的路由策略和前缀列表配置错误
  ISIS实例1重分布到其他ISIS实例时未选择路由策略
  对接的两个NNI口MTU配置不匹配
  IP地址冲突（所有公网接口，比如NNI口IP地址、loopback0口IP地址）
  ISIS实例配置中IPv4地址族未配
  ISIS实例中“等价路径数目”配置不为1
  对接的两个网元ISIS区域ID不同
  ISIS实例systemID配置冲突
  NNI口IP地址配置错误（对接的NNI口不在同一网段）
  NNI口静态ARP配置错误
  
  线路故障
  网元因为线路多处故障变成网元孤岛
  
  协议异常
  ISIS协议会话异常
  ISIS协议会话正常但公网路由不存在
  接入网元跟外部DCN设备互通的bfd状态down
  
  定位思路
  针对网管服务器无法ping通网元loopback0口IP地址问题，总体定位思路如下：
  结合实际网络拓扑和控制DCN网络规划，初步确认故障网元来回的路由路径。
  从网管服务器上tracert故障网元loopback0口IP地址，根据tracert结果可以判断故障点是网管服务器静态路由配置问题，或者外部DCN通道问题，或者内部DCN某网元故障导致。
  针对不同的情况进一步排查，先排除硬件、线路和配置问题，再查路由状态，尽量找出问题点。
  故障处理流程
  EMBED Visio.Drawing.15
  操作步骤
  根据tracert结果判断故障出在网络中的哪一段。
  梳理故障网元在网络中的位置，根据当前物理拓扑情况以及DCN网络规划，判断故障网元正常时应该的路由走向。
  然后在网管服务器的CMD（命令管理器）中执行tracert -d x.x.x.x，其中x.x.x.x为故障网元loopback0口IP地址，确认tracert结果可达的最后一个IP地址在网络中的位置判断故障出在网络中的哪一段。
  如下图tracert结果，红色方框为最后可达IP地址。
  
  Tracert无法达到服务器网关：➔步骤2。
  Tracert无法达到接入网元：➔步骤3。
  Tracert只能到达接入网元：➔步骤4。
  Tracert不只能到达接入网元：➔步骤5。
  检查网管服务器控制网卡IP和静态路由配置。
  找出网络规划台账，确认网管服务器控制网卡IP地址和网关IP地址规划，检查控制网卡配置上配置的IP地址和掩码是否跟规划匹配是否正确。
  在网管服务器的命令管理器中通过route print命令查看服务器是否有到达故障网元所在网络的控制面DCN网段路由，如下图所示。
  
  如果网卡IP和静态路由配置无问题，则先检查网关服务器跟网关之间的链路是否正常。
  在网管服务器命令管理器中通过arp -a x.x.x.x 命令查看是否可以学到服务器网关的arp，其中x.x.x.x为服务器网关IP地址，如下图所示。
  
  如果ARP无法学到，或ARP可以正常学到但服务器仍然ping不通网关，则需要跟网关设备厂家的专家一起排查，必要时可以在网管服务器上抓包（wireshark或者netmon）分析，也可以联系烽火工程师协助处理。
  排查外部DCN故障。
  找出控制面DCN台账规划，确认接入网元带外口IP地址规划、接入网元的网关IP地址、跟外部DCN对接的bfd参数等规划，一一检查。
  检查接入网元当前去往网管服务器控制网卡IP地址静态路由配置，是否跟规划一致。具体查询方式如下图。
  
  检查静态路由绑定的bfd状态是否为up。
  先执行show bfd session ，通过Name找到静态路由绑定的bfd条目，关注State状态。
  
  如果静态路由绑定的bfd状态为down，尝试核对bfd规划参数，规划参数跟实际配置不一致，则需要对配置进行修改。再检查bfd的源、peer ip之间的可达性。
  如果源、peer ip之间可以ping通：➔跳转到bfd故障排查章节或者联系烽火工程师处理。
  如果源、peer ip之间不能ping通：➔跳转到直连路由不可达故障处理章节或者联系烽火工程师处理。
  通过管理面DCN通道telnet到当前主用接入网元，通过show route detail ipv4 x.x.x.x命令查看公网路由表中是否存在去往网管服务器的静态路由，其中x.x.x.x是网管服务器控制网卡IP地址。具体操作如下图所示：
  
  关注显示出的路由条目中的优先级高（Priority）的条目出接口（Interface）是否跟规划一致。
  如果接入网元到网管服务器控制网卡IP地址的路由出现了ECMP（Priority为ECMP），则直接联系烽火工程师处理。
  检查接入网元ISIS重分布静态路由配置是否正常。
  查看所有ISIS实例中重分布静态路由时是否引用了正确的route-policy。
  
  如上图确认引用的路由策略名称为1，则可通过show route-policy 1来确认引用的ipv4-prefix的名称，然后通过show ipv4-prefix命令查看前缀列表匹配的网段是否跟控制面带外静态路由的目标网段完全匹配，如下图所示。
  
  注意：
  前缀列表跟静态路由的目标网段一定要完全匹配，不能为包含关系！
  排查tracert最后可达网元跟它下游相邻网元的ISIS邻居状态。
  
  Tracert最后可达网元与它相邻的下游网元之间ISIS邻居状态不UP，则从如下思路进行排查：
  排查tracert最后可达网元及其下游相邻网元互联线路是否存在告警。如果线路故障无法排除，请联系烽火工程师处理。
  排查是否存在单盘故障。需要检查单盘是否存在温度、脱管、CPU、内存等告警。如果单盘故障无法消除，请联系烽火工程师处理。
  排查NNI口IP地址和MTU配置。
  接口up/down状态：如果线路故障已经排除并且接口IP已配置，则是两个up，否则联系烽火工程师处理。
  接口IP地址：要求对接的NNI口IP必须同网段。
  接口MTU：要求两端MTU保持一致。
  
  排查NNI口静态ARP配置。
  通过show running检查arp配置是否正确，需要核对两端NNI接口IP地址和MAC地址。
  
  查询当前arp状态，是否跟实际配置一致。
  
  排查ISIS配置。
  检查isis实例配置，关注下图红色方框。
  
  查看当前show running是否跟网管配置一致，确认NNI口和loopback0是否都正确加入了对应的实例。如下图所示。
  
  排除以上原因，ISIS邻居仍然无法正常建立，可以尝试跳转到ISIS故障排除章节继续处理，或者联系烽火工程师处理。
  排查tracert最后可达网元的路由。
  提示：
  路由表查看小技巧：一是需要路由有没有学到，二是看路由跟当前物理拓扑和网络规划是否一致。
  
  EMBED Visio.Drawing.15  以上图为例：
  排查tracert最后可达网元到故障网元的路由。
  如果存在ecmp，检查ISIS实例配置中最大等价路径数目是否配置的1，检查路由出接口和下一跳是否跟网络规划一致。
  
  排查tracert最后可达网元相邻的下游网元的到网管服务器控制网卡IP地址的路由。
  
  如果路由状态跟上图中描述不一致并且无法排除或者路由故障排除后仍然ping不通，需要在当前tracert最后可达网元及其下游故障网元上进行ping测和抓包分析，也可以参考相关章节进一步排查或者联系烽火工程师处理。
  汇总相关信息，联系烽火工程师。
  
  
  业务故障定位及处理
  介绍L2VPN、L3VPN等业务故障的定位及处理。
  REF _Ref257920008 \h  \* MERGEFORMAT L2VPN业务不通故障定位及处理
  REF _Ref257920010 \h  \* MERGEFORMAT L3VPN业务不通故障定位及处理
  CCC业务不通故障定位及处理
  REF _Ref285721140 \h MPLS-TP隧道不通故障定位及处理
  SR-TP隧道不通故障定位及处理
  FlexE故障定位及处理
  L2VPN业务不通故障定位及处理
  背景信息
  L2VPN是服务提供商 VPN 解决方案中一种基于 PE 的 L2VPN 技术，使用 MPLS在网络上转发mpls-tp报文。mpls-tp L2VPN 组网方式灵活、可扩展性好，并能够方便地支持 MPLS QoS ，因此得到越来越多的应用。
  按照MPLS标签的分配方式，目前L2VPN手工分配标签的静态L2VPN。
  目前移动5G业务采用 L2VPN承载方式，其中专线业务采用静态 L2VPN部署。
  
  故障现象
  常见的L2VPN业务故障现象如下：
  L2VPN业务不通，首先考虑业务配置原因。
  L2VPN业务丢包，光模块是否有误码。
  可能原因
  现网L2VPN业务故障，原因一般有以下几个方面：
  原因类型
  原因详述
  
  配置问题
  地址解析协议未正确配置（静态ARP基本配置）
  mpls lsr标示未正确配置（mpls lsr id配置）
  tunnel业务配置未正确配置（Lsp标签）
  L2VPN业务配置未正确配置（pw标签、接口绑定关系）
  业务保护未正确配置（VPN配置、LSP1：1配置)
  
  单盘问题
  有如下异常告警：
  TEMP_OVER（单盘温度过高）
  COMFAIL（单盘通信中断）
  UNCORR_MEM_ECC_ERR（存储单元不可恢复奇偶校验错误）等相关告警
  
  协议异常
  地址解析协议未正常工作（ARP会话未建立，路由不存在）
  
  定位思路
  针对移动场景的静态L2VPN，总体定位思路如下：
  优先考虑配置问题，依次业务规划，初步进行配置自查。
  确认业务流向后，在当前工作的站点上，查询业务性能等操作，逐段进行性能查询的定位，确定故障网元。
  协议层面检查完毕无误后，通过告警分析等手段，完成故障链路、单盘的查找定位。
  故障处理流程
  EMBED Visio.Drawing.11
  操作步骤
  根据业务的保护状态，确认业务流向。
  针对L2VPN场景：
  查看主、备用接入/汇聚/核心设备的隧道保护状态，确认当前业务工作的主用设备。
  查看主、备用接入、汇聚、核心设备间的隧道OAM/BFD状态及保护组的工作状态，确认当前业务的工作路径。
  隧道保护状态查询
  如下图所示，状态为正常时，表示工作路径的下一跳节点为主用设备；状态为桥接时，表示工作路径的下一跳节点为备用设备。
  
  端到端查询L2VPN状态，查看是否建立成功。
  在网管上，查询L2VPN状态：
  
  设备底层Show run如下：
  
  查询隧道是否up，确认是否为网内tunnel故障。
  无故障时，TUN state 是UP，有故障是down。
  
  设备底层show出来如下：
  
  
  在网内ARP是否配置。
  是：➔步骤 5。
  否：检查网内ARP是否正常，是否能够ping通对端nni口ip地址。
  网管查看 ARP的配置：
  
  设备底层命令如下：show arp all
  
  
  查看 L2VPN 两端对应pw的收发标签，即 L2PW 收发标签是否存在。
  两端收发标签存在且一致： ➔步骤 6。
  两端收发标签不存在或者不一致：
  网管查询pw入出标签配置：
  
  网管查询pw入出标签状态：
  
  查看mpls 两端的收发标签，即LSP收发标签是否存在且一致。
  两端收发标签存在且一致： ➔步骤 7。
  两端收发标签不存在或者不一致：
  网管查看mpls收发标签如下：
  
  设备底层查看隧道入出标签命令：show mpls traffic-eng tunnels brief。示例如下：
  
  检查L2VPN源、宿、中间节点是否有如下表所示的异常告警。
  无异常告警➔步骤8
  存在异常告警：消除异常告警。若故障仍存在，➔步骤8
  告警分类
  告警代码
  告警全称
  
  转发单盘硬件类告警
  TEMP_OVER
  单盘温度过高
  
  
  COMFAIL
  单盘失效
  
  
  UNCORR_MEM_ECC_ERR
  存储单元不可修复奇偶校验错误
  
  主控盘异常类告警
  DISK_USE_PER_OVER
  磁盘利用率过限
  
  
  MEM_USE_PER_OVER
  内存利用率过限
  
  
  CPU_USE_PER_OVER
  CPU利用率过限
  
  链路异常告警
  LINK_LOS
  连接信号丢失
  
  
  R_LOS
  输入信号丢失
  
  
  FLEXE_LOF
  FLEXE开销帧丢失
  
  
  CRC_ERR
  CRC错误包过限
  
  检测报文告警
  
  BFD_DOWN
  BFD会话状态DOWN
  
  
  BFD_REMOTE_DOWN
  BFD会话状态远端DOWN
  
  
  VP-LOC
  虚通路连接确认信号丢失
  
  
  VP-RDI
  虚通路远端故障指示
  
  
  汇总相关信息，联系烽火工程师。
  
  L3VPN业务不通故障定位及处理
  背景信息
  SPN设备上存在两种场景下的L3VPN业务：
  与SPN设备对接，作为接入侧或者核心网设备，由SR-TP隧道承载L3VPN业务。
  与PTN设备对接，作为网络N侧的核心设备，由MPLS-TP隧道承载L2L3桥接业务的L3侧业务。
  两种场景下的L3VPN业务都是由静态配置的隧道承载，定位思路也基本一致。
  故障现象
  常见的L3VPN业务故障现象如下：
  L3VPN业务不通，从主、备用汇聚设备均无法ping通核心网IP地址。
  L3VPN业务丢包，从主、备用汇聚设备ping核心网IP地址存在丢包。
  可能原因
  现网FlexE故障问题，原因一般有以下几个方面：
  原因类型
  原因详述
  
  配置问题
  静态路由未正确配置（UNI向NNI业务的汇聚路由和NNI向UNI业务的明细路由）
  隧道策略和路由策略未正常配置（路由策略配置错误导致无路由信息，隧道策略配置错误导致不能迭代正确的隧道）
  私网标签、隧道标签、PATHID未正确配置（私网的业务标签、MPLS-TP/SR-TP的隧道标签、PATH是否匹配）
  L3VPN业务配置未正确配置 (L3VPN RD、RT配置、隧道策略绑定关系）
  业务保护未正确配置 （VPN FRR配置、静态MPLS-TP的LSP1：1配置)
  静态ARP未正确配置（有保护情况下的主备下一跳静态ARP配置）
  
  平台问题
  路由、隧道、标签转发表等未正常生成（形成ECMP路由，隧道策略不生效、标签转发表中标签存在冲突等）
  IP、接口、标签、路由、隧道信息未正常下发转发
  
  转发问题
  接口、路由、下一跳、标签转发表、ARP未正常生成
  业务盘硬件问题，如光模块光功率异常、器件间连接通道异常、超规格转发资源溢出等问题
  
  定位思路
  针对SPN静态L3VPN场景，总体定位思路如下：
  优先确认故障源结点的路由/标签转发表/隧道/ARP是否正常，出现异常时需要检查源站点的VRF/路由策略/隧道策略/标签/静态路由/TE隧道配置是否正确。
  配置正常、各业务表项正常生成情况，在故障源结点执行trace操作，用以定位出现故障的具体位置，通过trace找到具体站点后按第一步操作确认配置和业务表项是否都正常生成。
  故障结点各配置和表项均正常生成的情况，需要检查业务盘上的表项是否均正确；存在异常的配置或表项则需要优先解决。
  确认业务盘上表项正确时需要在业务盘上进行抓包分析，通常使用业务盘芯片驱动适配提供的镜像抓包命令进行分析。
  故障处理流程
  EMBED Visio.Drawing.15
  操作步骤
  根据保护状态确认业务工作节点。
  目前SPN设备不支持ECMP场景，仅支持VPN FRR主备路径场景，可通以下命令确认主备路径，同时还可以通过show vpn-frr state all查看工作路由和保护路径的状态。
  若有，则优先解决单盘硬件或主控异常问题。
  
  端到端使用VRF ping测试L3VPN连通性。
  在L3VPN接入结点执行带源PING操作，PING的源/目的IP是两端落地结点UNI口的IP，检测是否可以端到端PING通，是否有丢包。
  Ping A.B.C.D a A.B.C.D vrf WORD
  
  能ping通且无丢包：➔与用户沟通，确定是否为无线误报。
  能ping通有丢包：➔步骤3。
  不能ping通：➔步骤3。
  进行私网Trace操作确认故障点位置。
  通过trace命令确认出现问题的站点，那里不通查那里。
  可以在L3VPN的两端分别执行tracert进行确认，结果会更准确。如下图Trace最后一跳由16.2.1.45返回，因此最可能出问题的结点为该节点，或该结点的下一跳结点，可以将问题分析重心放在这两个站点上。
  需要注意的时Trace操作也需要带源进行，否则中间站点可能出现无路由不回包情况。
  
  Trace不通：➔确认故障的链路段，检查故障段的配置，反馈给用户解决该段故障。
  可以Trace通：➔步骤4。
  检查私网路由是否正常。
  故障源端可以使用如下命令检查私网路由配置：
  show route detail vrf WORD ipv4 A.B.C.D
  Show route detail vrf WORD ipv6 X：X：X：X：X：X：X：X
  如下图所示，Flag为Primary的为主用路由，Secondary的为备用路由，当前不支持ECMP场景的情况下，业务仅在主用路径上生效。
  
  可以Trace通：➔步骤5。
  路由不存在：➔依次检查路由配置/路由策略配置/隧道策略配置，同时确认不能生成ECMP路由，本端配置检查无误并修复后确认故障是否解决。
  路由配置检查：
  
  私网配置检查：
  进行VPN视图确认绑定的路由策略和隧道策略。
  
  路由策略配置检查：
  
  隧道策略配置检查：
  
  检查两端私网标签配置。
  私网标签不一致：➔修改私网标签配置，再确认故障是否解决。
  私网标签一致：➔步骤6。
  
  检查TE隧道配置。
  TE和相邻站下一跳ARP都己学习到，则主控配置无问题，需要确认转发平面的相关表项是否正确：➔步骤7。
  TE隧道配置不正确：➔修改私网标签配置，再确认故障是否解决。
  从路由查询的显示结果可以确认主用路径的出接口为Tunnel3，对应te 3，可进行mpls traffic-eng视图查看te配置，主要确认destination是否为对端IP地址，pathid与对端是否相同。
  
  通过主路径path配置可以找到与相邻站点直连的实现物理接口：
  
  上述方法适用于静态配置显式路径，另一种查看邻接标签的方法如下：
  show mpls traffic-eng tunnels x
  
  查询到邻静态SR配置后就可以确定下一跳IP和出接口了，下一步则继续确认下一跳IP对应ARP是否存在：
  show arp interface if-name
  
  转发路由/FEC/ARP表项确认。
  查询转发表项不存在：➔联系研发同时确认平台表项是否下发转发。
  转发表项存在：➔步骤8。
  690设备业务盘路由/FEC/ARP表项确认方法如下：
  先进入业务盘的BCM视图。
  
  在该视图下查看路由。
  非32位掩码路由：kbp kaps_show
  
  32位掩码路由：diag dbal dbd 0
  
  查看下一跳FEC信息。
  
  业务盘抓包分析。
  抓包文件中无业务报文或者格式不正确：➔联系研发同事确认收发包异常问题。
  转发表项存在：➔步骤9。
  业务盘抓包操作：
  通过主控盘Os上执行ssh root@10.22.12/13.x进入业务盘OS，其中12或者13	取决于主控盘是在小槽位还是大槽位，x表示具体的业务盘槽位号。
  业务盘上SCC信令报文可在ethx.4092接口上进行抓包查看，格式与主控一致。
  业务盘Jericho+镜像操作。
  在主控Os上执行ssh root@10.22.12/13.x进入业务盘OS。
  在业务盘os执行telnet 127.0.0.1 10000进入命令行终端，用户名diag/密码diag。
  通过psn_scc_help查看帮助函数。
  
  命令使用说明如下：
  项目
  说明
  
  fhdrv_psn_flexe_map_op (0，4)
  看fsa记录的flexe-tunnel ID和端口的对应关系
  
  
  dbg_port_get_port_info (unit，slot，ilkn_and_port，channel_id)
  查看指定端口具体信息：
  Unit：0或1，指示为第几片Jericho+，默认写0
  Slot：端口槽位号
  Ilkn_and_port：flexe-tunnel为0，以太网接口为8
  Channel_id：指定通道号
  Flexe-tunnel101接口的端口信息：
  
  Eth接口的端口信息：
  
  
  psn_cpu_port_mirror (unit，inport，outport，mirror_type，prob，enable)
  开启镜像命令：
  unit：0或1，指示为第几片Jericho+，默认写0
  inport：对应第2项中查到的local_port值，参考dbg_port_get_port_info接口
  output：固定填0，表示镜像到CPU口
  mirror_type：镜像类型，2入口镜像、4出口镜像、6双向镜像
  prob_enable：1打开0关闭镜像
  
  dbg_cpu_switch (type，enable，unit)
  CPU层信令调试函数：
  dbg_cpu_switch 5，3，0开始抓包
  dbg_cpu_switch 5，0，0停止抓包
  type：调试类型，抓包只用5
  enable：使能，只使用3开启抓包和0停止抓包
  unit：只使用0
  
  dbg_fsa_switch
  Fsa层调试函数
  
  BCM debug：进BCM>视图
  
  d chg IHP_VSI_LOW_CFG_1
  查VSI，看MAC的低12bit
  
  g ihp_my_mac
  看MAC的高36bit
  
  kbp kaps_show
  网段路由
  
  diag dbal dbd 0
  主机路由
  
  diag cos lo
  看端口信息
  
  diag cos non
  看拥塞
  
  Flexe-tunnel接口镜像操作：
  项目
  说明
  
  fhdrv_psn_flexe_map_op 0，4
  查看flexe-tunnel ID和端口对应关系
  
  dbg_port_get_port_info 0，slot，0，port
  查看flexe-tunnel 接口local_port
  
  psn_cpu_port_mirror 0，localport，0，2/4/6，1，1
  开启端口镜像，将报文镜像到CPU口
  
  dbg_cpu_switch 5，3，0
  开始抓包
  
  dbg_cpu_switch 5，0，0
  停止抓包
  
  psn_cpu_port_mirror 0，localport，0，2/4/6，1，0
  关闭镜像
  
  scp /tmp/cpu-xxxx.pcap root@x.x.x.x：/tmp
  抓包文件在业务盘tmp目录，通过scp取出
  
  以太接口抓包操作：
  项目
  说明
  
  dbg_port_get_port_info 0，slot，8，port
  查看以太接口local_port
  
  psn_cpu_port_mirror 0，localport，0，2/4/6，1，1
  开启端口镜像，将报文镜像到CPU口
  
  dbg_cpu_switch 5，3，0
  开始抓包
  
  dbg_cpu_switch 5，0，0
  停止抓包
  
  psn_cpu_port_mirror 0，localport，0，2/4/6，1，0
  关闭镜像
  
  scp /tmp/cpu-xxxx.pcap root@x.x.x.x：/tmp
  抓包文件在业务盘tmp目录，通过scp取出
  
  非镜像直接抓包操作：
  SCC信令直接经过业务盘CPU口，因此不需要镜像，直接进行抓包操作
  项目
  说明
  
  dbg_cpu_switch 5，3，0
  开始抓包
  
  dbg_cpu_switch 5，0，0
  停止抓包
  
  scp /tmp/cpu-xxxx.pcap root@x.x.x.x：/tmp
  抓包文件在业务盘tmp目录，通过scp取出
  
  检查L3VPN源、宿、中间节点是否有如下表所示的异常告警。
  无异常告警➔步骤10。
  存在异常告警：消除异常告警。若故障仍存在，➔步骤10。
  汇总相关信息，联系烽火工程师。
  
  CCC业务不通故障定位及处理
  背景信息
  CCC业务是服务提供商VPN解决方案中一种基于 flexe ccc 技术，网络侧使用 L2link在网络上转发报文。CCC业务组网方式灵活、可扩展性好。
  目前移动5G业务主要采用L3VPN 承载方式，其中专线业务支持FLEXE CCC业务部署。 EMBED Visio.Drawing.11
  故障现象
  常见的CCC业务故障现象如下：
  CCC业务不通，首先考虑配置问题
  CCC业务丢包，首先考虑链路上有误码。
  可能原因
  现网CCC故障问题，原因一般有以下几个方面：
  原因类型
  原因详述
  
  配置问题
  Flexe channel配置未正确配置 (clinet，flexe接口绑定关系)
  L2VPN业务配置未正确配置 (接口绑定关系）
  业务保护未正确配置（flexe channel配置及OAM配置)
  
  单盘问题
  有如下异常告警：
  TEMP_OVER（单盘温度过高）
  COMFAIL（单盘通信中断）
  UNCORR_MEM_ECC_ERR（存储单元不可恢复奇偶校验错误）等相关告警
  
  定位思路
  针对移动场景的CCC业务，总体定位思路如下：
  优先考虑配置问题，依次业务规划，初步进行配置自查。
  确认业务流向后，在当前工作的站点上，查询业务性能等操作，逐段进行性能查询的定位，确定故障大体网元。
  检查完毕无误后，通过告警分析等手段，完成故障链路、单盘的查找定位。
  故障处理流程
  EMBED Visio.Drawing.11
  操作步骤
  根据业务的保护状态，确认业务流向。
  查看主、备用接入/汇聚/核心设备的SPN channel保护状态，确认当前业务工作的主用设备。
  查看主、备用接入、汇聚、核心设备间的隧道OAM状态及保护组的工作状态，确认当前业务的工作路径。
  SPN channel保护状态查询。
  如下图所示，状态为正常时，表示工作路径的下一跳节点为主用设备；状态为桥接时，表示工作路径的下一跳节点为备用设备。
  
  端到端查询业务配置，查看是否建立成功。
  网管上查询业务配置：
  
  设备上查询CCC业务：
  
  设备上查询CCC业务的状态：
  
  检查L2VPN源、宿、中间节点是否有如下表所示的异常告警。
  无异常告警➔步骤8
  存在异常告警：消除异常告警。若故障仍存在，➔步骤8
  告警分类
  告警代码
  告警全称
  
  转发单盘硬件类告警
  TEMP_OVER
  单盘温度过高
  
  
  COMFAIL
  单盘失效
  
  
  UNCORR_MEM_ECC_ERR
  存储单元不可修复奇偶校验错误
  
  主控盘异常类告警
  DISK_USE_PER_OVER
  磁盘利用率过限
  
  
  MEM_USE_PER_OVER
  内存利用率过限
  
  
  CPU_USE_PER_OVER
  CPU利用率过限
  
  链路异常告警
  LINK_LOS
  连接信号丢失
  
  
  R_LOS
  输入信号丢失
  
  
  FLEXE_LOF
  FLEXE开销帧丢失
  
  
  CRC_ERR
  CRC错误包过限
  
  检测报文告警
  
  FLEXE-LOC
  FLEXE通道连接确认信号丢失
  
  
  FLEXE-RDI
  FLEXE远端通道连接信号失效指示
  
  
  汇总相关信息，联系烽火工程师。
  MPLS-TP隧道不通故障定位及处理
  背景信息
  SPN设备上存在两种场景下的L3VPN业务：
  与SPN设备对接，作为接入侧或者核心网设备，由MPLS-TP隧道承载L3VPN业务。
  与PTN设备对接，作为网络N侧的核心设备，由MPLS-TP隧道承载L2L3桥接业务的L3侧业务。
  MPLS-TP隧道一般为静态配置，隧道问题基本上可以通过检查配置的方式进行排查。
  故障现象
  MPLS-TP故障一般是通过叠加MPLS -TP隧道的L2VPN/L3VPN业务感知到：
  L2/L3VPN业务不通，从主、备用汇聚设备均无法ping通核心网IP地址。
  L2/L3VPN业务丢包，从主、备用汇聚设备ping核心网IP地址存在丢包。
  可能原因
  现网MPLS-TP故障问题，原因一般有以下几个方面：
  原因类型
  原因详述
  
  配置问题
  显式路径配置不正确，与实际路径的邻接标签不一致
  
  平台问题
  标签转发表未正常下发到转发平面
  
  单盘问题
  有如下异常告警：
  TEMP_OVER（单盘温度过高）
  COMFAIL（单盘通信中断）
  UNCORR_MEM_ECC_ERR（存储单元不可恢复奇偶校验错误）等相关告警
  
  协议异常
  地址解析协议未正常工作（ARP会话未建立，路由不存在）
  
  定位思路
  针对移动场景的mpls-tp隧道不通，总体定位思路如下：
  优先确认配置问题，根据网络和业务规划进行配置自检，初步进行问题分析。
  通过平台LSP PING/TRACE方法确认MPLS-TP隧道不通的具体原因。
  故障处理流程
  EMBED Visio.Drawing.11
  操作步骤
  LSP PING可进行MPLS-TP隧道的连通性检查。
  查看隧道的状态。
  
  Tunnel状态为UP可进行LSP PING操作。
  
  能ping通：➔与用户沟通，确定是否为无线误报。
  不能ping通：➔步骤2。
  执行LSP TRACE检查，确认故障节点。
  执行LSP TRACE时，MPLS-TP隧道的每一个节点正常情况下都会返回，如下：
  
  若TRACE不通则返回的最后一跳作为故障分析结点进行配置检查。
  Trace不通：➔检查最后返回结点站点配置。
  Trace正常：➔步骤3，检查所有站点配置。
  检查MPLS-TP配置。
  依次查看配置：
  网管上查看配置。
  
  设备底层命令行查询：show mpls traffic-eng tunnels brief。
  
  
  同时中间站点还需要检查标签路由，确认标签处理动作与预期一致。
  隧道配置异常：➔修正隧道配置后确认MPLS-TP隧道是否恢复。
  隧道配置正常：➔步骤4，检查所有站点告警。
  检查MPLS-TP隧道上所有结点异常告警。
  无异常告警➔步骤 5
  存在异常告警：消除异常告警。若故障仍存在，➔步骤5
  汇总相关信息，联系烽火工程师。
  SR-TP隧道不通故障定位及处理
  背景信息
  SPN设备上存在两种场景下的L3VPN业务：
  与SPN设备对接，作为接入侧或者核心网设备，由SR-TP隧道承载L3VPN业务。
  与PTN设备对接，作为网络N侧的核心设备，由MPLS-TP隧道承载L2L3桥接业务的L3侧业务。
  SR-TP隧道一般为静态配置，隧道问题基本上可以通过检查配置的方式进行排查。
  故障现象
  SR-TP故障一般是通过叠加SR-TP隧道的L2VPN/L3VPN业务感知到：
  L2/L3VPN业务不通，从主、备用汇聚设备均无法ping通核心网IP地址。
  L2/L3VPN业务丢包，从主、备用汇聚设备ping核心网IP地址存在丢包。
  可能原因
  现网SR-TP隧道故障问题，原因一般有以下几个方面：
  原因类型
  原因详述
  
  配置问题
  显式路径配置不正确，与实际路径的邻接标签不一致
  
  平台问题
  标签转发表未正常下发到转发平面
  
  定位思路
  针对SR-TP隧道的问题，总体定位思路如下：
  优先确认配置问题，根据网络和业务规划进行配置自检，初步进行问题分析。
  通过平台LSP PING/TRACE方法确认SR-TP隧道不通的具体原因。
  故障处理流程
  EMBED Visio.Drawing.15
  操作步骤
  进行LSP PING检查。
  LSP PING可进行SR-TP隧道的连通性检查。
  首先查看隧道的状态。
  
  Tunnel状态为UP可进行LSP PING操作。
  
  能ping通：➔与用户沟通，确定是否为无线误报。
  不能ping通：➔步骤2。
  执行LSP TRACE检查，确认故障节点。
  执行LSP TRACE时，SR-TP隧道的每一个节点正常情况下都会返回，如下：
  
  若TRACE不通则返回的最后一跳作为故障分析结点进行配置检查。
  Trace不通：➔检查最后返回结点站点配置。
  Trace正常：➔步骤3，检查所有站点配置。
  检查SR-TP配置。
  依次查看配置：TE->显式路径->静态SR，确认检查标签配置与规划路径一致
  
  同时中间站点还需要检查标签路由，确认标签处理动作与预期一致：
  show mpls lsp可查看标签转发表，如下是中间站点对标签1002的处理方式。
  
  隧道配置异常：➔修正隧道配置后确认SR-TP隧道是否恢复。
  隧道配置正常：➔步骤4，检查所有站点告警。
  检查SR-TP隧道上所有结点异常告警。
  无异常告警：➔步骤5。
  存在异常告警：消除异常告警。若故障仍存在，➔步骤5。
  汇总相关信息，联系烽火工程师。
  
  
  FlexE故障定位及处理
  背景信息
  FlexE 是一种灵活以太网接口和链路技术，主要包括灵活以太网功能接口、灵活以太网接口要求、shim层处理、复用和解复用结构和过程、开销安排、客户信号适配、信号传输和故障处理。由于其灵活性、低时延、切片层硬管道隔离以及支持端口跨绑定等特性在SPN中得到广泛应用。
  目前中国移动SPN业务线路侧业务采用FlexE端口承载，场景部署如下图所示。
  
  故障现象
  常见的FlexE业务故障现象如下：
  FlexE开销告警。
  FlexE接口或FlexE-Tunnel down。
  FlexE业务中断。
  FlexE业务丢包或误码。
  可能原因
  现网FlexE故障问题，原因一般有以下几个方面：
  原因类型
  原因详述
  
  配置问题
  FLEXE_GIDM告警（相连的物理端口group num不一致）
  FLEXE _INM告警（相连的物理端口phy num不一致）
  FLEXE _CCM告警（FlexE-client配置的client num或时隙不匹配）
  FLEXE_MM告警（phy所在的group下的phy num不一致）
  FLEXE _BAS_UNP告警（BAS帧周期不匹配）
  
  单盘问题
  有如下异常告警：
  TEMP_OVER(单盘温度过高)
  OFFLINE（单盘不在位）
  
  异常告警
  如下告警为物理端口接收端故障：
  FlexE物理端口RLOS(收无光)
  FlexE物理端口FLEXE _CRC(开销CRC告警)
  FLEXE_LOF(帧丢失告警)
  FLEXE_LOM(复帧丢失告警)
  FLEXE_OB_ERR(开销块错误告警)
  
  
  如下告警为物理端口发送端故障：
  FLEXE_RPF(远端物理层故障告警)
  
  
  如下告警为FlexE Channel收端故障
  FlexE_LF（FlexE Client本端失效）
  FlexE_BAS_LOC（FlexE Client BAS接收帧丢失）
  
  
  如下告警为FlexE Channel远端故障：
  FlexE_BAS_RDI（FlexE Client远端失效）
  
  定位思路
  针对移动场景的应用，FlexE总体定位思路如下：
  确定业务流向，检查业务流途径站点是否有FlexE物理端口或FlexE Channel相关异常告警，若有告警，检查链路连接状态。
  检查业务流途径站点是否有FlexE开销失配告警，若有告警，检查FlexE相关配置。
  检查业务流途径站点FlexE Tunnel接口性能，通过包计数、CRC计数、速率等相关性能，定位中断/丢包/误码的节点/单盘。
  登陆故障节点单盘，可在10000界面下通过帮助函数进一步定位问题。
  故障处理流程
  EMBED Visio.Drawing.11 \* MERGEFORMAT
  操作步骤
  业务路径确认，主控/单盘告警排查。
  根据配置了解业务路径，确认业务途径的各网元，检查各网元是否有如下告警。
  若有，则优先解决单盘硬件或主控异常问题。
  告警分类
  告警代码
  告警全称
  
  转发单盘硬件类告警
  TEMP_OVER
  单盘温度过高
  
  
  COMFAIL
  单盘失效
  
  
  UNCORR_MEM_ECC_ERR
  存储单元不可修复奇偶校验错误
  
  主控盘异常类告警
  DISK_USE_PER_OVER
  磁盘利用率过限
  
  
  MEM_USE_PER_OVER
  内存利用率过限
  
  
  CPU_USE_PER_OVER
  CPU利用率过限
  
  FlexE端口状态排查。
  例如可在9000中使用show命令查看端口的状态，如果端口down请排查物理链路连接情况。
  
  
  
  FlexE链路告警排查。
  例如可在9000中使用show命令查看FlexE相关告警，并检查链路。
  show alarm active boardaddr %slot%
  
  告警分类
  告警代码
  告警全称
  
  FlexE PHY接收故障
  RLOS
  收无光
  
  
  FLEXE_CRC
  FlexE开销CRC校验错
  
  
  FLEXE_LOF
  FlexE开销帧丢失
  
  
  FLEXE_LOM
  FlexE开销复帧丢失
  
  
  FLEXE_OB_ERR
  FlexE开销块错误
  
  FlexE PHY发送故障
  FLEXE_RPF
  FlexE远端PHY失效
  
  FlexE Channel接收故障
  FLEXE_LF
  FlexE Client本端失效
  
  
  FLEXE_LOC
  FlexE 通道连接确认信号丢失
  
  FlexE Channel发送故障
  FLEXE_RDI
  FlexE通道远端连接确认信号丢失
  
  
  FlexE开销失配告警排查。
  检查业务流途径站点是否有FlexE开销失配告警，若有告警，检查FlexE相关配置并修正。
  告警分类
  告警代码
  告警全称
  
  FlexE开销告警
  FLEXE_GIDM
  Group Num不匹配
  
  
  FLEXE_INM
  PHY Num不匹配
  
  
  FLEXE_CCM
  Calendar配置适配（client num或时隙不匹配）
  
  
  FLEXE_MM
  PHY Map不匹配
  
  
  FLEXE_UNP
  BAS帧周期不匹配
  
  FlexE Tunnel性能排查。
  检查业务流途径站点FlexE Tunnel接口性能，通过包计数、CRC计数、速率等相关性能，定位中断/丢包/误码的节点/单盘。
  若业务中断，则找到FlexE Tunnel速率为0或接近0的站点，通过10000界面进一步定位问题。
  若业务丢包/误码，则通过FlexE Tunnel CRC计数定位相关节点，并检查相关物理口链路接收状态。
  9000中查看性能的命令（可基于单条flexe_tunnel查询，示例中查询flexe-tunnel1）：
  show pm statistics sample-type CURR_15MIN | begin flexe-tunnel1
  
  汇总相关信息，联系烽火工程师。
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  主控盘故障定位及处理
  介绍主控盘主备故障的定位及处理方法。
  REF _Ref257919935 \h  \* MERGEFORMAT 主控盘主备故障定位及处理
  REF _Ref257919937 \h  \* MERGEFORMAT 交叉盘激活/去激活失败故障定位及处理
  
  主备无法切换故障定位及处理
  背景信息
  运营商网络设备要求具有高可用性，网络中节点设备核心板卡支持主备部署，大多数情况下，核心、骨干汇聚、接入节点设备主控盘都采用主备部署，采用主备部署解决主控故障情况，转发层面的业务不发生中断。
  故障现象
  网管操作主备盘切换，提示无法操作或者操作失败。
  可能原因
  主备无法切换故障，原因一般有以下几个方面：
  原因类型
  原因详述
  
  批备（批量同步）问题
  FOS进程间通信问题
  FOS组件启动有问题
  组件老化标记没有结束
  组件没有完成批备
  组件处于冻结状态
  
  软件问题
  主备切换的命令异常
  
  版本同步问题
  主备软件版本不同步，UPG组件没有完成批备
  
  定位思路
  针对主备无法切换的问题，总体定位思路如下：
  网管界面控制命令下，下发主控盘盘保护软切换命令，看切换结果是否成功，切换返回失败。
  通过网管界面主备状态查询判断主备状态，如果主备状态栏显示不是Ready，则主备批备没有完成，如果主备状态栏显示Ready，则下发切换异常，软件存在故障，确定故障大体方向。
  如果确定主备状态没有ready，可以断定主备批备没有完成，批备没有完成需要登录设备明确。
  如果批备没有完成，通过show haf component process xxx查看进程下组件没有完成批备，可以明确异常出现在那个组件。
  若通过show haf component命令确定对应组件，直接定位到组件；若不能确认对应组件，到没有形成保护进程的ccma组件查看ccma_xxx.log日志。
  除了上述问题外，其他都需要找平台。
  故障处理流程
  EMBED Visio.Drawing.11
  操作步骤
  通过网管界面下发主备状态查询命令，界面如下。
  
  查看界面下发回显状态查询结果，如果命令行执行成功，找客户沟通。
  
  在网管状态查询界面，查询对应网元的主备状态是否ready。
  如果是ready但切换不成功，问题定位范围是下发切换命令异常，找对应的组件确认即可。
  
  登录设备站点，通过show haf process all查看进程保护状态，缩小范围确认哪个进程批备没有完成；当找到指定组件没有完成批备后，再show haf component process查看指定进程下组件保护状态。
  
  
  若通过步骤3确认有进程没有形成保护，但通过步骤4未定位到具体组件，则查看未形成保护的日志文件，如nem_4.log等。
  搜索对应进程是否有组件启动的问题，搜索关键字（undefined symbol），若找到关键字（undefined symbol）则认为没有组件启动有问题.。
  汇总相关信息，联系烽火工程师。
  
  主备倒换故障定位及处理
  背景信息
  主备倒换告警表明设备主备发生过非人为主备切换，即主用异常重启导致备用自动升级，需针对主用异常重启的问题排查与确认。
  故障现象
  设备主备主控盘无缘无故发生切换，网管会产生主备倒换告警。
  可能原因
  主备倒换故障，原因一般有以下几个方面：
  原因类型
  原因详述
  
  FOS软件异常
  主盘FOS软件进程退出
  批备过程中，主盘异常重启
  
  OS系统重启
  主备软件版本不同步，UPG组件没有完成批备，一次版本同步导致系统重启
  
  定位思路
  针对主备倒换告警引出倒换切换的问题，总体定位思路如下：
  在没有人为切换场景下，网管界面显示主备切换的告警，说明这端设备发生非认为的切换。
  使用CRT工具登录到设备，登录到现在备用（当时主用），在OS系统文件找到fpml.txt，找到异常退出的进程。
  同步骤2登录到现备盘，找到该盘是否存在core文件，通过fos_container加载core文件，并进入堆栈确认异常退出属于那个组件。
  同步骤2登录到现备盘,执行uptime命令，查看当前整盘系统上电启动时间，通过上电时间和网管产生告警时间相比，如果时间一直说明二者有关联。
  同步骤2登录到现备盘，找到该盘的system.log，找到对用的重启时间点、shutdown动作行为，确认该盘OS系统时间和原因。
  故障处理流程
  EMBED Visio.Drawing.11
  操作步骤
  网管界面产生主备倒换告警，确认产生的网元和时间点。
  
  使用CRT登录设备确认是设备是否发生过主备切换。
  没有切换：说明网管上报主备倒换告警属于误报。
  发生切换：➔步骤3。
  
  经过步骤2登录现在备盘，查找现在备盘是否存在core文件，若存在core文件则加载core文件解析函数调用栈，确认该问题是否已经解决。
  
  登录上现在备盘，进入备盘操作系统界面，输入uptime，确认系统启动多长时间，如果uptime显示有刚上电，说明OS操作系统重启。
  
  如果系统有uptime时间显示，但不能确认OS系统重启的原因。相继续支持系统重启原因，查找操作系统systeam.log文件搜索关键字，并根据网管主备切换告警时间，确认OS重的时间和原因。
  
  汇总相关信息，联系烽火工程师。
  
  业务保护和倒换故障定位及处理
  介绍业务保护和倒换故障的定位及处理。
  概述
  VPN FRR倒换故障定位及处理
  混合FRR倒换故障定位及处理
  隧道保护倒换故障定位及处理
  概述
  业务保护和倒换常见问题如下：
  在应该发生保护倒换时，全网未进入保护倒换状态或保护倒换状态错误。
  在全网正常状态下突然发生不明原因的倒换。
  进入保护倒换后，全网或部分业务发生中断的情况。
  背景信息
  
  VPN FRR倒换故障定位及处理
  故障现象
  常见的VPN FRR故障现象如下：
  VPN FRR保护状态查不到。
  保护状态异常，出现主用故障、备用故障或主备都故障进入倒换失败状态。
  保护正常倒换后业务中断。
  可能原因
  故障现象
  原因详述
  
  保护状态查不到
  配置错误：如VPNFRR的路由策略、路由表等配置问题，导致未形成保护
  
  主备异常故障或倒换失败
  查看保护组详细信息，确认检测方式是oam/bfd还是up-level-path
  查看对应项是否存在告警，如果是up-level-path，需要确认是否叠加了隧道保护，进一步确认叠加保护是否主备都故障
  若无相应告警，登录设备确认底层是否存在告警
  690E还需确认告警总线是否正常
  
  倒换后业务中断
  按业务不通问题排查
  
  故障处理流程
  EMBED Visio.Drawing.15
  操作步骤
  网管查看VPN FRR概要信息，关注倒换状态和主备路径状态是否符合预期。
  
  如概要信息出现状态异常，可以指定VPN名称和主备下一跳进一步查看保护组详细状态，确认主用和备用隧道配置是否正常，确认主备用的告警检测方式、检测id及保护id，根据检测方式和检测id查看对应oam告警，根据保护id可以到设备查看指定保护条目做进一步诊断。
  
  若网管查不到对应VPN FRR保护信息，则检查VPN FRR保护关键配置信息是否缺失。
  
  
  登录设备命令行根据vrf名称查看VPN FRR保护路由详情，形成Primary和Secondary及对应tunnel值说明正常。
  
  
  在设备命令行查看VPN FRR状态。
  根据主备tunnel_id可以进一步查看隧道的状态，检测方式如为up-level-path，表示叠加了保护或未配置检测方式，前者需要进一步查看隧道保护状态，后者默认无故障。
  
  汇总相关信息，联系烽火工程师。
  混合FRR倒换故障定位及处理
  故障现象
  常见的混合FRR现象如下
  混合FRR保护状态查不到。
  保护状态异常，出现主用故障、备用故障或主备都故障进入倒换失败状态。
  保护正常倒换后业务中断。
  可能原因
  混合FRR故障，原因一般有以下几个方面：
  故障现象
  原因详述
  
  保护状态查不到
  配置错误：如混合FRR的路由策略、路由表等配置问题，导致未形成保护
  
  
  主备异常故障或倒换失败
  查看保护组详细信息，确认检测方式是oam/bfd还是up-level-path
  查看对应项是否存在告警，如果是up-level-path，需要确认是否叠加了隧道保护，进一步确认叠加保护是否主备都故障
  若无相应告警，登录设备确认底层是否存在告警
  690E还需确认告警总线是否正常
  
  倒换后业务中断
  按业务不通问题排查
  
  故障处理流程
  EMBED Visio.Drawing.15
  操作步骤
  网管查看混合FRR概要信息，关注倒换状态和主备路径状态是否符合预期。
  
  如概要信息出现状态异常，可以指定VPN名称和主备下一跳进一步查询详细状态，确认主用出接口和备用隧道配置是否正常，确认主备用的告警检测方式、检测id及保护id，根据检测方式和检测id查看对应端口/bfd/oam告警，根据保护id可以到设备查看指定保护条目做进一步诊断。
  
  若网管查不到对应HYFRR保护信息，则检查HYFRR保护关键配置信息是否缺失。
  
  
  登录设备命令行根据vrf名称查看HY FRR保护路由详情，形成Primary和Secondary及对应tunnel值说明正常。
  
  
  HYFRR保护形成可通过命令行进一步获取混合FRR的详细信息。。
  
  
  如主用故障，主用检测方式为bfd，检测id为46，可以进一步查看bfd状态确认是否有告警。
  
  汇总相关信息，联系烽火工程师。
  隧道保护倒换故障定位及处理
  故障现象
  常见的隧道保护故障现象如下
  隧道保护查到状态为init。
  保护状态异常，出现主用故障、备用故障或主备都故障进入倒换失败状态。
  隧道保护主用故障后没有倒换。
  保护正常倒换后业务中断。
  可能原因
  隧道保护故障，原因一般有以下几个方面：
  故障现象
  原因详述
  
  保护状态查不到
  隧道保护需要检查主备lsp配置
  
  隧道保护状态出现init
  如倒换状态为none，主备都是init，进一步查看保护组详细信息，查不到说明设备转发面未正常创建保护组，查到了说明状态上报异常。需登录设备检查底层表项
  仅主用或备用出现init，表示保护组正常创建，检测方式出现异常。需登录设备检查底层表项
  
  主备异常故障或倒换失败
  查看保护组详细信息，确认检测方式是oam/bfd，查看对应项是否存在告警。
  若无相应告警，登录设备确认底层是否存在告警
  690E还需确认告警总线是否正常
  
  隧道保护主用故障未倒换
  查看保护组详细信息，确认收发aps码是否正常
  
  倒换后业务中断
  按业务不通问题排查
  
  故障处理流程
  EMBED Visio.Drawing.15
  操作步骤
  网管查看隧道保护概要信息，关注倒换状态和主备路径状态是否符合预期。
  
  如概要信息出现状态异常，可以进一步查询详细状态，确认主用出接口和备用隧道配置是否正常，确认主备用的告警检测方式、检测id及保护id，根据检测方式和检测id查看对应bfd/oam告警，根据保护id可以到设备查看指定保护条目做进一步诊断。
  
  若网管查到隧道保护信息为init，说明保护没形成，可以检查隧道保护关键配置信息是否缺失或通过命令行查看隧道保护的状态信息。
  
  汇总相关信息，联系烽火工程师。
  
  线路故障定位及处理
  介绍线路故障的定位及处理。
  线路光功率异常故障定位及处理
  线路光功率异常故障定位及处理
  背景信息
  光功率是光模块工作正常的重要指标，如果光功率异常，会导致光模块工作异常甚至损坏的情况，因此在工程开通时需要注意光功率，工程上出现光功率过高/过低告警时需要及时进行工程改造。
  故障现象
  常见的光功率异常现象如下：
  收/发光功率过高/过低告警。
  收无光。
  光功率告警抖动。
  光功率正常，端口不UP。
  光功率正常，业务丢包。
  可能原因
  现网光功率异常问题，原因一般有以下几个方面：
  原因类型
  原因详述
  
  传输距离和模块传输距离不匹配
  使用短距光模块在长距场景，或者使用长距光模块在短距场景下未加合理光衰
  
  光纤未插紧
  光纤未卡紧接触不好，导致光功率告警抖动（现网690U出现过一例）
  
  光模块损坏
  在收到过强光功率的情况下，光模块内部器件被击穿损坏。多见于长距光模块（40KM/80KM），特别是QSFP28 40KM光模块
  
  光模块/光纤端面脏污
  工程开通环境不好，导致光模块/光纤端面脏污，需要清洁
  
  配置问题
  通过网管或者命令行配置了激光器关断命令，本端有激光器关断告警（LASER_OFF），对端有收无光告警（RLOS）
  
  定位思路
  针对光功率异常的情况，总体定位思路如下：
  查看光模块状态，对比收发光功率和灵敏度/过载点，最大/最小发光功率，核实收发光光功率是否在范围内。
  发光功率异常：基本是光模块出现异常，更换模块。
  收光功率异常：对比对端发光功率和本端收光功率，计算差值。
  收光功率过大，增加光衰。
  收光功率过小，更换长距光模块。
  光模块收发光功率正常，但是端口不UP。
  查看端口是否是长距离光模块，可能存在损坏可能。
  QSFP28 40KM光模块存在未加光衰自环/短距离光纤直接对同等情况，导致模块内部被击。
  检查是否存在禁用光模块或者已记录可能存在问题的光模块。
  当前问题模块列表如下：CRC问题见CRC章节，本章节不做更多描述。
  设备和模块类型
  说明
  
  690E
  QSFP28
  50G
  10KM
  SPQ50ELRCDFAFH
  索尔斯
  限用，CRC、闪link down
  
  
  
  
  40KM
  SPQ50EERCDFA
  索尔斯
  限用
  
  
  
  100G
  10KM
  EOLQ-161HG-10LAH
  新易胜
  禁用
  
  
  
  
  
  EOLQ-161HG-10-L
  新易胜
  不良品较多，出现多起CRC、闪link down情况
  
  650
  QSFP28
  100G
  10KM
  EOLQ-161HG-10LAH
  新易胜
  禁用
  
  
  故障处理流程
  EMBED Visio.Drawing.11
  操作步骤
  核实传输距离是否和光模块传输距离不匹配。
  查看光模块状态。
  
  核实实际传输距离和光模块标称距离是否匹配。
  如果是传输40KM光纤，则不应该使用10KM光模块，需要更换。
  如果是传输10KM光纤，实际使用40KM光模块，需要增加适当光衰。
  两端发光功率是否异常。
  核实两端光接口是否存在发光功率多低或者过高告警。
  发光功率过高或过低都说明光模块的激光器存在问题，需更换光模块。
  核实是否存在激光器关断告警。
  需要打开激光器。
  两端收光功率是否异常。
  核实两端光接口是否存在收光功率过低/过高/收无光告警。
  计算实际光功率损耗和实际传输距离是否匹配。
  如果实际光功率损耗大于实际传输距离的损耗，可能是光纤传输链路存在问题。一般按照1KM损耗 0.3db来计算。
  例如对端发光是3db，本端收光是-5db，但传输距离为10KM，理论损耗3db，实际损耗8db，此时应该检查光纤光路是否正常，排查光纤是否插紧，更换光纤，清理模块端面等。
  如果实际光功率损耗小于实际传输距离的损耗，存在收光过高告警，则依旧需要调整光衰。
  汇总相关信息，联系烽火工程师。
  
  
  
  PTP故障定位及处理
  介绍PTP故障的定位及处理。
  背景信息
  1588v2配置说明
  锁定状态检查
  应用场景及故障排查
  
  背景信息
  术语
  词语
  解释
  
  BITS
  楼宇综合定时供给，Building Integrated Timing Supply
  
  BMC
  最佳主时钟算法，Best Master Clockalgorithm
  
  PRC
  基准参考时钟，Primary Reference Clock
  
  PTP
  精确时间同步协议，Precision Time Protocol
  
  SSM
  同步状态信息，Synchronization Status Message
  
  时间同步网络总体架构
  时间同步网络以本地网为单位建设，目的是为基站提供高精度时间同步信号。时间同步网由三部分组成：时间服务器从卫星接收时间信号、进行时间分配并提供保持功能。传输网络从时间服务器获取时间源，通过IEEE 1588v2时间协议进行时间信息的传送。基站通过传输设备获取高精度时间同步信号。
  每个本地网配置主用和备用两台时间服务器。时间服务器连接本地频率同步网BITS设备，频率溯源一级基准钟PRC。
  传输网络选择合适的核心层设备分别接入到本地的主备用时间服务器和频率同步网BITS设备，获取时间和频率源。
  本地传输网络所有设备应支持并开通基于1588v2的时间同步和基于同步以太网的频率同步传送功能。
  基站设备通过以太网接口从设备传递的同步以太获取频率信号，从1588v2协议获取时间信号。
  
  图9-1 时间同步网络架构
  注意：
  在1588v2时间同步网络开通运行之前，必须保证整个传输网络的同步以太已经开通并溯源至PRC，不允许单台传输设备运行在内部时钟自由振荡状态，不能出现时钟锁定成环的场景。
  
  1588v2配置说明
  注意：
  和基站对接：基站同步我司设备时，端口配置为Master。
  时间注入点- SPN 690设备
  
  
  
  时间注入点通过1pps+tod同步时，小槽位对应接口1，大槽位对应接口2。通过线路锁定，配置PTP时，或者非时间注入点无需配置该项。
  
  非时间注入点- SPN 690设备
  无需配置“PTP外时间接口配置”配置项，其他配置同时间注入点一致。
  非时间注入点- SPN 650设备
  参考SPN 690设备非时间注入点配置。
  锁定状态检查
  时间状态检查：
  
  
  
  
  应用场景及故障排查
  不同设备之间具体接口互联说明
  如下图所示，当前应用场景下，只有和时间服务器对接的设备可能会用到1pps+tod 接口，其它设备之间均通过线路口，PTP报文来互通。
  EMBED Visio.Drawing.11
  图9-2 不同设备之间接口示意图
  故障处理流程
  
  同步tod无法锁定问题定位
  故障现象
  同步tod无法锁定问题的故障现象如下：
  本端设备不能锁定1pps+tod。
  可能原因
  同步tod无法锁定问题，原因一般有以下几个方面：
  原因类型
  原因详述
  
  配置问题
  PTP全局配置块未正确配置（需要配置使能BMC算法，同步模式混合模式，域号与时间服务器一致）
  PTP本地时钟配置（本地时钟配置按照第三节说明即可，不需要再修改）
  PTP外时钟配置未正确配置（当需要从1pps+tod接口同步时，就得配置对应的接口为输入，根据第三节修改参数)
  设备并没有配置时钟同步（需要先保证设备锁定上游的频率，并且ssm值为2或者4，即prc或者ssu-a）
  
  单盘问题
  有如下异常告警：
  COMFAIL（单盘通信中断）等相关告警
  1PPS+Tod丢失告警
  时钟类告警（未锁定状态，OOCR锁定源频偏超限等告警）
  
  定位思路
  针对SPN应用场景的时间同步网，总体定位思路如下：
  在确定配置无误的情况下，先观察网管是否有1ppstod丢失告警。如果有说明设备没有收到1ppstod信号，需要检查时间服务器输出是否正常，传输TOD的网线是否正常。可以调用时间同步仪表去现场模拟时间服务器进一步排查。
  确认无告警后，查看1588状态中的同步源附加状态中的ssm是否为prc或者ssu-a，如果不是需要排查时钟问题。
  操作步骤
  检查PTP功能各项配置是否正确。
  如下配置图中，黄色的为在网管上新增条目时，对应的默认配置。
  PTP全局配置
  路径跟踪算法
  时区
  同步模式
  域号
  其他选项
  
  BMC方式
  GMT+08：00
  混合式
  与时间源保持一致
  保持默认
  
  
  PTP本地时钟配置
  PTP本地时钟全部保持默认值，域号除外。域号需与时间源配置保持一致，时间才能锁定。
  
  时钟锁定源时钟优先级比较顺序：
  先比较优先级1，比较时钟等级，然后比较时钟精度，稳定度，优先级2。
  输入源和设备本地时钟，谁的优先级高的就会锁定哪个。
  优先级1（Priority1）：范围1-255，数值小的优先级高。
  优先级2（Priority2）：范围1-255，数值小的优先级高。
  PTP外时钟配置
  除了首站需要配置外，其他站点不需要配置PTP外时钟配置。
  当首站通过外时钟锁定，配置1pps+tod时，需要配置对应clk槽位的pps+tod接口配置。
  1PPS+TOD接口配置，3个接口分别对应如下。
  1：主控小槽位；2：主控大槽位；3：辅助端子板。
  外时钟输入源端口方向选择输入，优先级的配置按规划文档来，其它配置不变，输出端口默认即可。
  查看异常站点是否有告警。
  排查单盘中时钟及时间模块的告警，根据告警提示，更改相关配置后再查看模块工作状态。
  比如对接时间服务器的设备通过1PPS+TOD端口来同步，可能会出现设备上报1PPS+TOD输入丢失告警或1PPS+TOD输入劣化告警。这时需要核对单盘配置，检查TOD端口的信号连线，以及时间服务器的输出。
  核对状态信息。
  查看时钟状态
  查看时钟工作状态是否是锁定状态，锁定源状态是否正常，锁定源端口是否为同步端口（可以不为时间同步的端口，但是必须保证时钟锁定的最终源头和时间锁定的源头是同一个，尤其要注意避免时钟锁定成环）。
  如果开启了QL使能，那么锁定源SSM是否为G811时钟。
  
  时间同步全局状态
  时间同步全局状态主要关注同步源状态和同步时间状态。
  同步源状态中时钟ID为时间源的ID，优先级、时钟等级、时钟精度为时间源设置参数，同步端口为slave状态的端口。
  
  同步tod时，同步时间状态主要关注是否锁定，若为失锁状态会有紧急告警。
  
  查看基本状态和本地时钟状态是否为配置的参数。
  
  
  汇总相关信息，联系烽火工程师。
  同步线路口无法锁定问题定位
  故障现象
  同步线路口无法锁定问题的故障现象如下：
  本端设备不跟踪上游线路口PTP报文方向。
  本端设备跟踪上游设备，但状态回显中与上游设备的同步偏差offset偏差较大，不在0ns数值附近。
  可能原因
  同步线路口无法锁定问题，原因一般有以下几个方面：
  原因类型
  原因详述
  
  配置问题
  PTP全局配置块未正确配置（需要配置使能BMC算法，同步模式混合模式，域号与时间服务器一致）
  PTP本地时钟配置（本地时钟配置使用默认值即可，不需要再修改）
  PTP接口时钟配置未正确配置 (需要正确配置对应的线路口及工作模式）
  设备并没有配置时钟同步（需要先保证设备锁定上游的频率）
  
  单盘问题
  有如下异常告警：
  TEMP_OVER(单盘温度过高)，可能导致flexeE单盘工作异常
  COMFAIL（单盘通信中断）等相关告警
  时钟类告警（未锁定状态，OOCR锁定源频偏超限等告警）
  
  定位思路
  针对SPN应用场景的时间同步网，总体定位思路如下：
  由于现网时间同步功能为逐级传递，本端出现告警等异常时，应第一时间确认本端和上游节点的工作状态，找到第一个出问题的设备。
  确认有异常的设备后，在当前工作的站点上，查询时钟，时间两个模块的状态及告警信息，确定引起异常的大致原因。
  根据怀疑方向，核查配置是否无误，是否有单盘级的其它告警影响。
  协议层面检查完毕无误后，通过告警分析等手段，完成故障链路、单盘的查找定位。
  
  操作步骤
  检查PTP功能各项配置是否正确。
  如下配置图中，黄色的为在网管上新增条目时，对应的默认配置。
  PTP全局配置
  路径跟踪算法
  时区
  同步模式
  域号
  其他选项
  
  BMC方式
  GMT+08：00
  混合式
  与时间源保持一致
  保持默认
  
  
  PTP本地时钟配置
  PTP本地时钟全部保持默认值，域号除外。域号需与时间源配置保持一致，时间才能锁定。
  
  时钟锁定源时钟优先级比较顺序：
  先比较优先级1，比较时钟等级，然后比较时钟精度，稳定度，优先级2。
  输入源和设备本地时钟，谁的优先级高的就会锁定哪个。
  优先级1（Priority1）：范围1-255，数值小的优先级高。
  优先级2（Priority2）：范围1-255，数值小的优先级高。
  PTP外时钟配置
  同步PTP时此项配置不需要配。
  PTP接口时钟配置
  传输网内部 配置接口工作模式，为AUTO。UNI口为了避免因为时钟优先级不同，出现反向锁定的情况，可以将UNI口配置为master。
  
  PTP报文参数配置
  690/650设备与680/660/640设备对接的端口，需要将这两个参数 sync报文发包频率和 Delay_Req报文发包频率设置为1，与690/650设备对接的端口不需要修改。
  同种设备对接不用改，因为老设备发包频率低，默认为1hz，新设备发包频率高，为16hz，在新老设备对接的地方需要把新设备的发包频率调整为1 与老设备保持一致。
  
  查看异常站点是否有告警。
  排查单盘中时钟及时间模块的告警，根据告警提示，更改相关配置后再查看模块工作状态。
  排查是否有单盘温度过高告警已经报文丢失告警。
  核对状态信息。
  查看时钟状态
  查看时钟工作状态是否是锁定状态，锁定源状态是否正常，锁定源端口是否为同步端口（可以不为时间同步的端口，但是必须保证时钟锁定的最终源头和时间锁定的源头是同一个，尤其要注意避免时钟锁定成环）。
  如果开启了QL使能，那么锁定源SSM是否为G811时钟。
  
  查看1588配置接口状态
  正常同步场景下，接口状态只会存在master、slave、passive三种状态。一台设备只会存在一个slave端口。
  
  时间同步全局状态
  时间同步全局状态主要关注同步源状态和同步时间状态。
  同步源状态中时钟ID为时间源的ID，优先级、时钟等级、时钟精度为时间源设置参数，同步端口为slave状态的端口。
  
  同步tod时，同步时间状态主要关注是否锁定，若为失锁状态会有紧急告警。
  
  查看基本状态和本地时钟状态是否为配置的参数。
  
  
  查看端口报文收发是否正常
  正常情况下：
  Master端口：announce，sync delayresp报文的发送计数和，delayreq 报文的接收计数会增长（两步模式下，followup报文的发送计数也会增长）
  Slave端口：announce， sync，delayresp报文的接收计数，delayreq 报文的发送计数会增长（两步模式下，followup的接收计数也会增长）
  诊断函数。
  命令行（状态、告警等）
  告警，性能信息为单盘通用方式，下面仅列出ptp模块相关命令行：
  命令类型
  命令行格式
  功能描述
  适用设备
  备注说明
  
  主控命令行界面
  show ptp time-syn-global (base|local-clk|sync-source|sync-time)
  查看时间同步状态数据
  SPN
  base：显示时间同步基本状态的数据
  
  
  
  
  
  local-clk：显示本地时钟状态数据
  
  
  
  
  
  sync-source：显示同步时间源状态数据
  
  
  
  
  
  sync-time：显示本设备时间同步信息数据
  
  
  show ptp time-syn-port
  查看时间同步端口状态
  SPN
  显示所有配置为PTP端口使能的端口时间同步状态
  
  
  show ptp time-syn-port summary
  查看时间同步端口个数
  SPN
  显示所有配置为PTP端口使能的端口个数
  
  需要注意的告警信息如下：
  告警分类
  告警代码
  告警全称
  
  单盘硬件类告警
  TEMP_OVER
  单盘温度过高
  
  
  COMFAIL
  单盘失效
  
  主控盘异常类告警
  DISK_USE_PER_OVER
  磁盘利用率过限
  
  
  MEM_USE_PER_OVER
  内存利用率过限
  
  
  CPU_USE_PER_OVER
  CPU利用率过限
  
  链路异常告警
  LINK_LOS
  连接信号丢失
  
  
  R_LOS
  输入信号丢失
  
  时钟模块告警
  OOCR
  锁定源频偏超限
  
  
  LTI
  线路钟中断
  
  
  REF_SWITCH
  时钟参考源切换
  
  时间模块告警
  PTP_1PPS_TOD_INPUT_LOS
  1PPS TOD信号输入丢失
  
  
  PTP_CLOCK_UNLOCK
  PTP时间失锁
  
  
  PTP物理链路告警
  PTP_PORT_LF
  
  
  PTP_INPUT_DEGRADATION
  PTP输入劣化告警
  
  
  PTP_1PPS_TOD_INPUT_DEGRADATION
  1PPS TOD输入信号 降质
  
  
  PTP_LOS_SYNC_PACKET
  PTP_LOS_DELAY_RESP_PACKET
  PTP报文中的SYNC 或 DELAY_RESP报文丢失
  
  
  PTP_GM_CLOCK_SWITCH
  设备同步的时间参考源发生切换
  
  汇总相关信息，联系烽火工程师。
  
  其他故障定位及处理
  介绍其他故障的定位及处理。
  机电相关故障定位及处理
  时钟故障定位及处理
  DHCP Relay故障定位及处理
  LAG故障定位及处理
  BFD故障定位及处理
  LLDP故障定位及处理
  LACP故障定位及处理
  
  
  机电相关故障定位及处理
  背景信息
  机电相关故障包含设备中电源风扇的问题，风扇主要负责设备温度的控制，可根据不同温度进行调速，电源可通过远程上下电对设备进行控制。机电主要问题有：电源性能问题；电源和风扇的告警问题；风扇调速和配置异常；远程下电命令失效。
  电源性能问题
  故障现象
  常见的电源性能故障现象如下：
  网管上查询电源性能为零。
  可能原因
  电源性能为零问题，原因一般有以下几个方面：
  原因类型
  原因详述
  
  网管性能显示问题
  设备上报了电源性能，网管未显示
  
  设备获取的数据为零
  电源单元上报的数据为零
  
  定位思路
  总体定位思路如下：
  首先要通过Telnet命令行确定设备是否向网管上报数据。
  如果设备命令行显示没有数据，确认电源单元是否有数据上报。
  故障处理流程
  EMBED Visio.Drawing.11 \* MERGEFORMAT
  操作步骤
  查看性能命令行有无数据。
  进入9000，通过show pm statistics sample-type CURR_15MIN命令，查看电源性能有无数据。
  
  
  命令行电源性能有值：➔联系烽火工程师。
  命令行电源性能值为零：➔通过show bmustarus命令查看设备有没有值。
  
  电源有电压值：➔步骤2。
  电源没有电压值：➔联系烽火工程师。
  汇总相关信息，联系烽火工程师。
  电源和风扇的告警问题
  故障现象
  常见的电源风扇告警问题如下：
  告警现象与显示的告警状态不一致。
  出现告警现象的处理方法。
  可能原因
  电源风扇告警问题，原因一般有以下几个方面：
  原因类型
  原因详述
  
  告警状态上报有误
  底层上报告警状态标记位有误
  
  电源故障告警
  电源盘在位，但没有插电源线
  
  电源电压过低、过高告警
  电源电压过低、过高
  
  风扇故障告警
  风扇异常停转
  
  环境温度告警
  风扇抽风口的环境温度过高
  
  电源关断告警
  电源关断
  
  定位思路
  总体定位思路如下：
  首先要通过日志中的告警状态确认告警是否上报有误。
  再根据实际告警情况，进行处理。
  故障处理流程
  EMBED Visio.Drawing.11 \* MERGEFORMAT
  操作步骤
  确认实际环境是否跟告警相符。
  根据上面表格各告警形成的原因，排查设备硬件实际状态，确认是否与告警相符。
  如果相符，则证明出现该告警问题：➔联系烽火工程师。
  如果不相符：
  通过设备上/mnt/userdir/fosuserdir/log/logfile路径下的fsm_admin_4.log确认设备上报的告警状态，1为有告警，0为无告警。
  
  
  如果上报告警状态位有误：➔联系烽火工程师。
  汇总相关信息，联系烽火工程师。
  
  
  时钟故障定位及处理
  背景信息
  设备通信传输中时钟时间同步非常重要，网络不同步会直接导致传输延时、丢包、滑码等影响。
  频率同步也称时钟同步，是指信号之间的频率保持某种严格的特定关系，其相对应的有效瞬间以同一平均速率出现，以维持通信网络中所有的设备以相同的速率运行。
  时间同步也称为相位同步，有两种含义：时刻和时间间隔。前者指连续流逝的时间的某一瞬间，后者是指两个瞬间之间的间隔长。即时间同步应包含频率同步和相位同步。
  SPN设备的时钟同步有2Mhz/2Mbits时钟同步和SyncE同步 ，时间同步有1588v2（PTP）。
  SPN设备位于接入和汇聚核心位置，如下图所示：。
  
  故障现象
  时钟故障现象如下：
  时钟无法锁定。
  可能原因
  时钟故障现象，原因一般有以下几个方面：
  原因类型
  原因详述
  
  配置问题
  时钟全局配置
  时钟输入配置
  时钟输出配置
  
  单盘问题
  有如下异常告警：
  TEMP_OVER（单盘温度过高）
  COMFAIL（单盘通信中断）
  
  协议异常
  SSM等级识别
  
  定位思路
  针对时钟故障现象，总体定位思路如下：
  查看设备告警信息，根据告警信息初步区分单盘问题、线路问题
  设备单盘正常在线，查看端口是否正常，时钟时间物理线路是否完好。
  设备单盘和物理线路正常，检查配置是否已下发正常。
  故障处理流程
  
  操作步骤
  常见告警参考及分析。
  时钟参考源切换告警：设备当前时钟源发生切换，有可能是上游设备发生变化或者当前设备输入优先级、SSM等级发生变化。
  
  时钟源丢失告警：当前时钟源丢失，有可能是上游输出中断、线路中断或者当前设备单盘问题。
  
  锁定源频率超出锁定范围告警：当前时钟源频率超过设备频率锁定门限，有可能是上游设备发生变化，例如源丢失，设备输出频率过大。
  
  检查时钟线路物理端口是否正常。
  网管上检查端口使能状态和工作模式，端口必须使能，上下游工作模式必须一致。
  
  底层输入show ip interface brief命令，查看端口是否up。
  
  检查时钟配置是否下发正确。
  时钟全局配置，检查时钟模式、QL使能、ESMC帧使能以及外时钟类型设置。
  
  配置项
  说明
  
  时钟工作模式
  auto（自动）
  
  QL使能选择
  如果是2Mbits或者syncE
  当需要通过SSM等级区分时钟输入源，使能QL
  不需要通过SSM等级区分时钟输入源时，不使能QL
  如果是2Mhz，不使能QL
  
  ESMC帧使能
  使能
  
  输入源
  如果时钟输入源是外时钟2Mhz或2Mbits，需要检查外时钟输入源配置：
  Mbits作为输入源时，上游设备与下游设备的SA值必须选择相同，外时钟类型选择HDB3
  2Mhz作为输入源时，上下游外时钟类型选择Hz
  EMBED PBrush
  
  时钟输入配置，针对时钟选源的配置，包括SSM等级、优先级配置。
  配置项
  说明
  
  SSM等级
  自动提取S1
  
  优先级
  将主用时钟源优先级选择为最高值，值越小，优先级越高
  
  
  时钟输出配置，设备需要输出时钟给下游设备时，配置时钟输出。
  
  线路时钟输出配置
  配置项
  说明
  
  SSM等级
  自动提取S1
  
  SSM等级使能
  使能
  
  优先级使能
  不使能
  
  
  外时钟输出配置
  端口选择外时钟的配置之外，还需配置PLL。
  配置项
  说明
  
  端口外时钟配置
  SSM等级
  自动提取S1
  
  
  SSM等级使能
  使能
  
  
  优先级使能
  不使能
  
  PLL配置
  SSM等级使能
  不使能
  
  
  优先级使能
  使能
  
  
  优先级
  0或者1
  
  
  
  
  汇总相关信息，联系烽火工程师。
  
  DHCP Relay故障定位及处理
  背景信息
  如果DHCP Client与DHCP Server在同一个本地网络，则客户机可以正确地获得动态分配的IP地址。
  如果DHCP Client与DHCP Server不在同一个本地网络，则需要使用DHCP Relay Agent（中继代理）。
  EMBED Visio.Drawing.15
  DHCP Relay代理可以传递DHCP消息到不在同一个物理子网的DHCP Server，也可以将DHCP Server的消息传回给不在同一个物理子网的DHCP Client。
  使用DHCP Relay代理后，就不需要在所有网段上都设置一个DHCP服务器，这样可以提高组网的经济性。
  DHCP中继功能，目的是将客户端的DHCP请求中继给DHCP服务器。
  在SPN应用场景中，DHCP relay部署在UPE设备跟基站对接的UNI口上，以提供gNodeB作为dhcp客户端向跨网段的DHCP服务器申请基站IP地址的功能。网内L3VPN需要保证DHCP Relay跟DHCP Server之间路由可达。
  DHCP报文交互过程
  
  基站启动广播DHCP Discover报文。
  DHCP Relay收到DHCP Discover报文后，将其中有效信息重新封装，单播发给DHCP服务器。
  DHCP服务器分配IP，使用DHCP Offer报文回复给DHCP Relay。
  DHCP Relay将该Offer报文封装为一个广播DHCP Offer报文发给基站。
  基站收到DHCP Offer后，发送DHCP Request用于确认。
  DHCP Relay收到DHCP Request报文后，将其中有效信息重新封装，单播发给DHCP服务器。
  DHCP服务器确认IP，使用DHCP Ack报文回复给DHCP Relay。
  DHCP Relay将该Ack报文转发给基站。
  至此基站和服务器均认可和确认该IP地址的使用，基站下一步会自动设置该IP地址到系统，至此IP地址配置成功。
  故障现象
  基站无法通过DHCP获取到正确的IP地址，即用户反馈基站无法上网管或ping不通，DHCP client发了discover包，但是没看到DHCP relay给DHCP server转发discover包。
  可能原因
  DHCP relay没有给DHCP server转发discover包，原因一般有以下几个方面：
  原因类型
  原因详述
  
  配置问题
  接口没有配置DHCP relay功能
  没有配置DHCP relay的目标服务器
  
  环境问题
  DHCP relay和DHCP server之间路由不通畅
  
  定位思路
  针对dhcp relay没有给DHCP server转发discover包，总体定位思路如下：
  检查与DHCP client直连的端口，是否配置了DHCP relay功能。
  检查步骤一中的端口上，是否配置了DHCP relay的目标服务器，并且检查配置的目标服务器IP地址是否和我们DHCP服务器的IP地址一样。
  检查DHCP relay和DHCP server之间，是否路由通畅，即是否可以相互ping通。
  查看DHCP relay统计信息。
  故障处理流程
  EMBED Visio.Drawing.11
  操作步骤
  检查UPE设备跟基站对接的UNI口是否配置了DHCP relay。
  检查与DHCP client直连的端口，是否配置了DHCP relay功能。
  Show run查看dhcp的配置，看是否select relay使能了dhcp relay功能。
  
  检查是否配置了目标服务器。
  检查步骤一中的端口上，是否配置了DHCP relay的目标服务器。
  检查配置的目标服务器IP地址是否和我们DHCP服务器的IP地址一样。
  Show run查看relay address。
  
  检查DHCP Relay和DHCP Server之间路由是否通畅。
  在UPE节点上以跟基站对接的UNI口的IP地址作为源ping DHCP Server的IP地址，如果ping不通，需要检查L3VPN路由不通的问题，可以参考L3VPN不通故障处理章节进一步处理
  查看dhcp relay模块统计信息。
  检查DHCP relay收发统计的discover个数信息。
  
  上图统计各条信息的含义如下：
  项目
  含义
  
  bad_packets_received
  错误包
  
  received_from_clients
  从client收到的包
  
  discover_received
  从client收到的discover包
  
  request_received
  从client收到的request包
  
  inform_received
  从client收到的inform包
  
  release_received
  从client收到的release包
  
  decline_received
  从client收到的decline包
  
  received_from_servers
  从server收到的包
  
  offer_received
  从server收到的offer包
  
  ack_received
  从server收到的ack包
  
  nak_received
  从server收到的nak包
  
  relayed_to_servers
  发送给server的包
  
  discover_relayed
  发送给server的discover包
  
  request_relayed
  发送给server的request包
  
  inform_relayed
  发送给server的inform包
  
  release_relayed
  发送给server的release包
  
  decline_relayed
  发送给server的decline包
  
  relayed_to_clients
  发送给client的包
  
  offer_relayed
  发送给client的offer包
  
  ack_relayed
  发送给client的ack包
  
  nak_relayed
  发送给client的nak包
  
  UPE作为DHCP-Relay，作用只是将client和server之间交互的报文进行转发，所以只需要关心每一类报文received了之后是否relayed。在配置和路由都正常的情况下，通过报文统计分析，可以大概判断故障点。
  下面以discover offer交互流程为例进行的分析。
  如果discover-received无计数，则UPE设备未收到基站发送的discover报文，可能基站DHCP Client部署有问题，需要跟基站一起排查，期间可以联系烽火工程师在UPE UNI口对应的单盘上抓包确认确实未收到基站发出的报文。
  如果discover-received有计数但是discover-relayed无计数或者比discover-received少，则认为可能UPE设备有问题，可以联系烽火工程师排查。
  如果discover-received和discover-relayed相同并且有增长，但是request_received未增长，则可能是DHCP Server问题，可以联系DHCP Server厂家工程师一起分析。
  如果offer_received有计数，但是offer-relayed无计数或者比offer-received少，则可能是UPE设备给基站转发offer报文有问题，需要排查UPE设备，可以联系烽火工程师协助处理。
  如果offer-received和offer-relayed相同并且有增长，但是没有后续报文统计，可能基站DHCP Client部署有问题，需要跟基站一起排查，期间可以联系烽火工程师在UPE UNI口对应的单盘上抓包确认是否将报文发到跟基站对接的线路上。
  汇总相关信息，联系烽火工程师。
  
  LAG故障定位及处理
  背景信息
  链路聚合（Link Aggregation）是指将多个物理端口汇聚在一起，形成一个逻辑端口，以实现出/入流量吞吐量在各成员端口的负荷分担，交换机根据用户配置的端口负荷分担策略决定网络封包从哪个成员端口发送到对端的交换机。
  当交换机检测到其中一个成员端口的链路发生故障时，就停止在此端口上发送封包，并根据负荷分担策略在剩下的链路中重新计算报文的发送端口，故障端口恢复后再次担任收发端口。链路聚合在增加链路带宽、实现链路传输弹性和工程冗余等方面是一项很重要的技术。
  故障现象
  常见的故障现象如下：
  L3VPN业务不通，从LAG成员对接的设备均无法ping通核心网IP地址。
  L3VPN业务负载分担不均匀。
  可能原因
  DHCP relay没有给DHCP server转发discover包，原因一般有以下几个方面：
  原因类型
  原因详述
  
  配置问题
  LAG组未配置路由(接口路由)
  LAG组模式配置错误(模式包括LACP、主备、负载分担)
  LAG组错误配置MAC(lag接口最好不要配置MAC，系统会自动分配)
  LAG id配置错误(lag组的id值应该小于规格)
  
  单盘问题
  单盘LAG成员与主控的状态不一致（比如主动显示active，但是单盘却未实际加入）
  
  协议异常
  LACP协议未正常工作（LACP会话未建立）
  
  定位思路
  针对L3VPN-LAG，总体定位思路如下：
  由于现网业务带有节点、链路等保护，故障发生后，通过保护的检测报文，应第一时间确认业务流向，确定当前工作的PE站点。
  确认业务流向后，在当前工作的站点上，进行ping/Trace等操作，逐段进行ping测试定位，确定故障大体方向。
  确认lag组状态，lag组各成员。
  协议层面检查完毕无误后，通过告警分析等手段，完成故障链路、单盘的查找定位。
  故障处理流程
  
  操作步骤
  根据业务的保护状态，确认业务流向。
  因为lag业务中一个lag组往往配置了多个成员，需要确定业务真正的流向，通过检测报文，应第一时间确认业务流向，确定当前工作的PE站点。
  在汇聚设备上，执行 ping ip-address vpn-instance vrf-name命令，ping测的目的地址为无线核心网相关网段地址，检测是否可以端到端ping通，以此来确认lag组状态，lag组各成员。
  lag端口状态。
  9000上，通过命令show lag查询。
  如果显示lag down，可能的原因为LAG组中没有加入LAG成员。
  
  lag成员状态。
  在UPE节点上以跟基站对接的UNI口的IP地址作为源ping DHCP Server的IP地址，如果ping不通，需要检查L3VPN路由不通的问题，可以参考L3VPN不通故障处理章节进一步处理
  查看dhcp relay模块统计信息。
  lag配置中有主备模式和负载分担模式，如果在主备模式下，lag组中至多只有一个成员，每个单盘实际加入的lag成员可能不一致。
  9000上，通过命令show lag查询。
  
  下图为局部放大图
  
  如果显示成员状态为inactive，参考aps-lag查询方法。
  8800上，在查询ddpo信息确认实际下发的lag成员。
  mem_info为每个lag成员的信息，slot、port代表成员的端口和槽位。
  
  10000-芯片底层，使用diag lag查看芯片底层实际加入的成员。
  Enable为Y是芯片底层实际加入的成员，如上图可以看到此时lag中加入了一个成员，成员的Gport port为0x800c00a，在以太盘中可以计算出端口、槽位信息，其中高4-5可计算出槽位信息，计算方法为c/2+1即7槽，低1-2位为端口信息，即10槽。
  
  负载分担模式中芯片底层可以加入多个成员，查询实际加入成员的方法与主备模式相同。
  查询正常转发流程有问题，参考动态L3VPN故障定位及处理。
  汇总相关信息，联系烽火工程师。
  aps-lag查询方法
  LAG保护状态详细说明。
  命令行原型
  aps_lag_show(lag_id)
  
  功能说明
  查看LAG运行状态和存储数据
  
  参数说明
  Lag id
  
  返回值说明
  
  State=0代表正常，已经加入lag组。
  State=1代表异常，需要查看是否有相应告警。
  
  LAG实际状态与主控不一致。
  telnet 127.1 8800，进入aps组件，输入aps_lag_show_all()。
  如图所示：配了bfd告警就是检测bfd，此时bfdAlm有告警。如果跟实际情况不符，就要联系开发人员定位原因，一般协议栈上的告警和APS不一致，多为FPGA告警总线异常导致。
  
  典型案例-lag组错误配置MAC致使业务不通
  通过前面方法定位发现lag组的状态正常，lag组中成员的状态正常，但业务还是不通，可以再确认lag的组的MAC是否正常，正常情况下不需要配置lag组的MAC，在错误配置lag组的MAC后还会导致修改设备高36位固定MAC致使业务不通，确认端方法如下：
  9000上，通过命令show lag、或show arp all查询对应lag的mac。
  设备上所有接口的高36位MAC，应该保持一致。
  
  
  10000-芯片底层，通过g ihp_my_mac查询设备底层设置的高36位MAC。
  底层的MAC应该和9000命令行上查询的MAC保持一致。
  
  
  
  BFD故障定位及处理
  背景信息
  为了保护关键应用，网络中会设计有三定的冗余备份链路，网络发生故障时就要求网络设备能够快速检测出故障并将流量切换至备份链路以加快网络收敛速度。
  目前有些链路通过硬件检测机制来实现快速故障检测。但是某些链路（如以太网链路）不具备这样的检测机制。此时，应用就要依靠上层协议自身的机制来进行故障检测，上层协议的检测时间都在1秒以上，这样的故障检测时间对某些应用来说是不能容忍的。
  某些路由协议如OSPF、ISIS虽然有Fast Hello功能来加快检测速度，但是检测时间也只能达到1秒的精度，而且Fast Hello功能只是针对本协议的，无法为其它协议提供快速故障检测。
  BFD协议提供了一个通用标准化的与介质、协议无关的快速故障检测机制。具有以下优点：
  对网络设备间任意类型的双向转发路径进行故障检测，包括直连物理链路、虚电路、隧道、MPLS LSP、多跳路由路径以及单向链路等。
  可以为不同的上层应用服务，提供些致的快速故障检测时间。
  提供小于1秒的检测时间，从而加快网络收敛速度，减少应用中断时间，提高网络的可靠性。
  目前的BFD类型主要有以下几种：
  BFD for IP：用于检测链路是否故障
  BFD for LAG：用于检测LAG成员口链路状态是否异常
  BFD for PW：用于检测VPWS/VPLS业务对应PW是否故障
  BFD for TE：用于检测RSVP-TE/SR-TE隧道是否故障
  BFD for LDP：用于检测LDP FTN隧道是否故障
  不同BFD的主要工作过程基本相同，如下：
  BFD在两个端点之间的一条链路上先建立一个BFD会话（依靠上层协议建立，例如OSPF的邻居建立时，会将邻居信息告知BFD，BFD根据这个信息再建立BFD邻居），如果两个端点之间存在多条链路，则可以为每条链路建立一个BFD会话。
  BFD在建立会话的两个网络节点之间进行BFD检测。如果发现链路故障就拆除BFD邻居，并立刻通知上层协议，则上层协议会立刻进行相应的切换。
  故障现象
  常见的BFD故障现象如下：
  BFD配置后无法up
  BFD存在震荡
  没有生成BFD会话
  BFD配置残留
  可能原因
  现网BFD故障问题，原因一般有以下几个方面：
  原因类型
  原因详述
  
  配置问题
  BFD未正确配置（BFD基本配置）
  BFD绑定业务未正确配置（ISIS/OSPF/BGP/RSVP-TE/LDP/SR-TE/接口/VPWS/VPLS配置）
  
  设备侧异常
  设备侧存在丢包
  设备侧没有正常上报BFD状态
  
  业务异常
  BFD绑定业务存在异常导致BFD down
  BFD绑定业务未正常下发创建或删除会话
  业务未响应BFD所报的告警
  
  定位思路
  针对BFD，总体定位思路如下：
  查看是否生成BFD会话，会话是否学习到描述符。
  查看两端BFD信息是否正常。
  确定BFD对应业务是否正常。
  配置残留情况确认是否为passive会话。
  故障处理流程
  
  
  操作步骤
  确认BFD信息。
  确认BFD配置，静态BFD确认BFD信息及绑定业务信息，动态BFD确定对应业务信息。
  静态BFD保证两边描述符是否对应，对应业务的配置是否正确。
  
  动态BFD确认业务配置块里是否配置了BFD使能，对于BFD for BGP情况，基于非直连口建立的BGP邻居是否配置多跳使能（如图）
  
  配置残留情况处理。
  确认是否为被动会话，被动会话需要等待10分钟后才会自动删除，若不是被动会话或10分钟后依然残留，和技术支持联系定位解决。
  
  未生成会话情况处理。
  动态BFD会话未生成情况下，先确认BFD对应业务是否正常为up状态，若不正常，按照业务对应相关故障排查流程排查。若正常后仍然存在问题，和技术支持联系定位解决。
  
  未学习到描述符情况处理。
  确认两端BFD信息是否匹配：
  不匹配：确认配置是否有误，无误和技术支持联系定位解决。
  匹配：使用ping命令确认业务及链路状态是否正常。不能ping通，按照业务对应相关故障排查流程排查。若正常后仍然存在问题，对于TE/LSP类型的动态BFD确认对端是否生成动态会话并记录，和技术支持联系定位解决。
  
  持续down情况处理。
  使用ping命令确认业务及链路状态是否正常。不能ping通，按照业务对应相关故障排查流程排查。若正常后仍然存在问题，和技术支持联系定位解决。
  
  震荡情况处理。
  使用ping命令确认业务及链路状态是否正常。Ping的过程存在震荡的情况下，检查链路状态，按照业务对应相关故障排查流程排查。若正常后仍然存在问题，和技术支持联系定位解决。
  
  汇总信息，联系烽火工程师处理。
  LLDP故障定位及处理
  背景信息
  LLDP（Link Layer Discovery Protocol，链路层发现协议），作为链路层协议，它提供了一种标准的链路层发现方式，可以将本端设备的的主要能力、管理地址、设备标识、接口标识等信息组织成不同的TLV（Type/Length/Value，类型/长度/值），并封装在LLDPDU（Link Layer Discovery Protocol Data Unit，链路层发现协议数据单元）中发布给与自己直连的邻居，邻居收到这些信息后将其以标准MIB（Management Information Base，管理信息库）的形式保存起来，以供网络管理系统查询及判断链路的通信状况。
  故障现象
  常见的LLDP故障现象如下：
  LLDP接口代理无邻居信息。
  可能原因
  常见的LLDP故障，原因一般有以下几个方面：
  原因类型
  原因详述
  
  配置问题
  LLDP功能未使能（全局去使能,单个LLDP接口代理去使能）
  
  单盘问题
  未支持LLDP报文以太网类型0x88CC的包处理
  
  协议异常
  LLDP无收包统计
  LLDP有错误收包统计
  
  定位思路
  针对LLDP故障，总体定位思路如下：
  LLDP默认全局使能并打开所有父接口LLDP代理,先确认LLDP全局未被配置去使能,再确认LLDP接口代理未被配置去使能。
  确认LLDP接口代理链路物理状态是否正常。确认LLDP收\发包情况,通过命令show lldp statistic查看收发包计数,重复该命令确认收发包计数是否每半分钟稳定增长。若收包计数没有变化，TCPDUMP抓包也无LLDP报文，考虑单盘LLDP报文上送等问题定位。
  若链路状态正常，检查有收包,查看LLDP邻居无信息,请联系烽火工程师定位。
  故障处理流程
  EMBED Visio.Drawing.11
  操作步骤
  检查聚合组配置，检查LLDP接口代理或全局去使能情况。
  查看LLDP接口代理去使能配置情况。
  
  查看LLDP全局去使能情况。
  
  检查链路物理状态，查看LLDP收发包情况。
  检查链路物理状态情况。
  
  检查LLDP报文收发状况。
  收、发包计数统计：
  
  正常情况下，收发包计数统计数值没有太大差距。计数数值若没有每30秒稳定增长，则考虑收包异常，可能是单盘上送异常，或对端发包异常。若有错误包统计，则需TCPDUMP抓包具体分析包错误原因。
  检查看LLDP邻居信息。
  初步查看LLDP邻居摘要信息结果。
  
  初步定某个接口没有邻居信息。
  进一步查看LLDP邻居全量信息。
  
  正常情况下，在有收发包，是没有错误包统计时，有LLDP邻居信息，若还没有该接口代理邻居信息，则联系烽火工程师定位。
  汇总相关信息，联系烽火工程师。
  LACP故障定位及处理
  背景信息
  随着网络中部署的业务量不断增长，对于全双工点对点链路，单条物理链路的带宽已不能满足正常的业务流量需求。如果将当前接口板替换为具备更高带宽的接口板，则会浪费现有的设备资源，而且升级代价较大。如果增加设备间的链路数量，则在作为三层口使用时需要在每个接口上配置IP地址，从而导致浪费IP地址资源。
  此时，可以把多个独立的物理接口绑定在一起作为一个大带宽的逻辑接口使用，即链路聚合技术，既不用替换接口板也不会浪费IP地址资源。那么就需要一种捆绑技术，将多个物理接口捆绑成一个逻辑接口，这个逻辑接口就称为聚合接口。那么LACP协议就是该捆绑技术所用到的协议。
  故障现象
  常见的LACP故障现象如下：
  聚合组选中状态全部未选中，LAG口状态DOWN。
  聚合组选中状态部分未选中，LAG口状态UP，LACP状态部分选中。
  可能原因
  常见的LACP故障，原因一般有以下几个方面：
  原因类型
  原因详述
  
  配置问题
  加入聚合组的LACP成员与对端LACP成员非互通成对
  LACP系统ID与对端LACP系统ID配置相同
  聚合组最大活动链路数小于加入该聚合组的成员数
  
  单盘问题
  未支持LACP报文以太网类型0x8809的包处理
  LACP报文上送错误接口,LACP报文需上送成员口,不是上送LAG口
  
  协议异常
  LACP无收包统计
  LACP有错误收包统计
  LACP有收包,但协商结果未选中
  
  定位思路
  针对LACP故障，总体定位思路如下：
  确认加入聚合组成员配置无误,包括加入聚合的链路是否正确，本对端LAG模式是否都为LACP模式,本对端LACP系统ID是否不同等。
  确认LACP成员链路物理状态是否正常。确认LACP收\发包情况,通过命令show lacp statistics查看收包计数，通过命令show lacpx information查看发包计数，判断收发计数总数是否大致相当，收包计数是否每半分钟稳定增长。若LACP收包计数没有变化，TCPDUMP抓包也无LACP报文，考虑单盘查找定位LACP报文上送等问题定位。
  若链路状态正常，查看LACP选中状态,通过命令show lag LAGNUM，查看SelectedStatus值,初步定位是哪个聚合组成员状态为非选中,通过show lacp state,查看本、对端Synchronization、Collecting、Distributing三个状态标记位值是否为1，判断LACP选中状态。
  故障处理流程
  EMBED Visio.Drawing.11
  操作步骤
  检查聚合组配置，检查LACP系统ID是否与对端重复。
  查看LAG口模式，确定为LACP模式，检查最小、最大活动链路数配置情况。
  
  查看LACP系统ID是否与对端重复，若重复，请修改。
  
  检查聚合组成员链路物理状态，查看LACP收发包情况。
  检查聚合组成员链路物理状态情况。
  
  检查LACP报文收发状况。
  收包计数统计：
  
  发包计数统计：
  
  正常情况下，收发包计数统计数值没有太大差距。计数数值若没有每30秒稳定增长，则考虑收包异常，可能是单盘上送异常，或对端发包异常。
  检查看LACP协商状态。
  初步定为聚合组成员LACP协商选中结果。
  
  初步定某成员未选中，需要通过LACP命令精确定为未选中的原因。
  通过LACP状态机数值查看未选中的原因。
  
  正常情况下，LACP本、对端Synchronization、Collecting、Distributing三个状态标记位值都为1，则为选中。若未选中的端口有收包，但是上述状态位不是1，请联系联系烽火工程师定位。
  汇总相关信息，联系烽火工程师。
  
  
  软件升级失败处理
  用户可以在升级的各个阶段，随时查看整包升级的进度及状态信息。在预升级阶段，如果整包软件包注册和检查有任何错误，都会通过状态显示到用户界面。用户可以根据错误提示信息，及时解决相关的问题，保障系统升级的顺利完成。
  整包预升级注册时报错
  介绍主控抓包的方法。
  整包不存在
  执行startup命令后显示如下：
  
  这种情况一般是网管ftp下载时ip地址等填写错误，或者传输到一半发生中断，导致升级目录下整包名文件不存在。
  软件整包存在主用主控盘的"/mnt/userdir/upgrade"目录，只需检查此目录下是否存在注册的整包名即可，发现没有包则需重新下载。
  处于busy状态
  执行startup命令后显示如下：
  
  这种情况一般是前面已经执行了升级的动作，但是并没有执行完成，需要等待对应的单条命令执行完毕后，才能继续执行相关升级命令。
  整包注册后执行激活失败
  在升级注册命令执行后，网管通过show startup-status查看注册结果，如果返回的是“startup-successful”说明注册成功，执行激活重启就完成了升级。
  如果show startup-status查看注册结果显示不成功，会显示简略的错误信息，可以通过show startup-state调试命令查看当前详细的注册状态，只有注册完成后才能执行激活，否则会直接返回错误。
  注册完成状态是show startup-state命令行的“State”列都显示“READY”，执行激活就会成功。
  注册成功的显示如下：
  
  如下是注册失败的情形，“State”列显示一个“WH_PACK_CHECK_ERROR”：
  
  执行激活命令后直接会报错：
  
  根据show startup-state显示命令中“State”显示，注册失败情况大概有如下几种情形：
  盘状态显示VER_IS_ACTIVE
  分析
  在设备上最多保存两个整包，bmumanager用ID1和ID2分别标识，如果当前运行整包的ID是ID1，则注册时需发送注册ID2，否则反之。
  在upg启动后会通过定时器不断获取向bmumanager下发主备使能、获取整包信息（包括ID），如果bmumanager出错返回不了，upg无法知道bmumanager当前运行整包ID。导致再次注册发的ID 50%概率会与当前激活ID冲突，导致无法升级。
  定位
  首先如果使用过bmumanager命令手动更新过整包，则不兼容整包命令行升级，需自行重启设备后再命令行升级。
  确定没有用通过bmumanager命令手动更新过整包，则用show packages info命令查看是否有整包信息，如果整包信息都是空的，说明未能从bmumanager获取到整包信息，需找bmumanager排查。
  盘状态一直显示REG_ING
  分析
  这种情况说明注册一直没有回复，注册本身比较耗时，当前设置15分钟超时，没有超时的情况下认为是正常的，如果超时则打印“register timeout”，原因比较多，一般需要根据upg的日志查看。
  定位
  目前遇到几点：
  主备盘通信比较慢，主备同步花了相当的时间，直到超时。
  scp封装的提供的接口存在bug，导致锁死无返回。
  可以通过查看日志没有主备拷贝成功的打印，需要找专门的接口人查看。
  盘状态显示COPY_WH_PACK_ERROR
  分析
  这个说明前期检查和同步都完成，向bmumanager发起注册命令码，bmumanager在执行解包拷贝等动作时，发现盘空间不够导致。
  定位
  先检查清理下主用和备用主控盘的磁盘空间，待升级的整包是否过大，能删的尽量先删除。
  清理后重新注册还不能解决的，需要bmumanager开发人员排查（之前要求bmumanager相关开发人员写出文档查看如何判断空间不够，答复是每个设备不一样，情况种类多，未能提供，说直接找刘力恺即可）。
  盘状态显示BACKUP_FILE_ERROR
  分析
  这种情况一般出现在主备环境中，在升级注册时，由UPG发起主备主控上整包同步，即将整包拷贝到备盘上，再分别发起注册。由于备盘上空间不够直接返回错误，或者主备通信断连，或者拷贝超时无法完成。
  定位
  登录备用主控盘查看磁盘空间，清理删除冗余文件，清理后重新升级注册，如果仍然未解决，则如上节“盘状态显示COPY_WH_PACK_ERROR”一样找bmumanager开发人员排查。
  盘状态显示FILE_IMCOMPATIBLE
  分析
  这种情况比较好定位，一般是测试人员把包弄混了，升级了错误的包导致。
  定位
  解压整包，查看相关文件是否匹配当前升级的设备。
  盘状态显示WH_PACK_CHECK_ERROR
  分析
  这种情况一般都是通过网管传整包时，整包被破坏了，导致检验不通过。
  定位
  解压整包，查看整包是否损坏。
  
  
  网管服务器异常处理
  服务状态监测工具
  工具目录：D:\UNM2000\pas\tools\IceGridGUI.jar
  首次打开时，需要填写如下参数（其中IP对应改成各自安装网管时的数据库IP，其他参数保持不变）：
  Administrator
  UnmBusIceGrid
  tcp -h 10.170.161.60 -p 52001
  
  服务正常状态：
  
  服务异常状态：
  
  服务启动日日志
  日志目录：D:\UNM2000\server\log\unm_service_monitor.2020-03-26.log
  服务启动过程：
  
  服务全部启动完成截图如下：
  
  服务启动异常日志：
  
  服务异常文件查看
  网管服务因各种原因崩溃后，会在特定目录生成异常文件，服务异常后，会再次尝试启动，一般都能正常启动，极少数情况下，需要在ICEGRID工具中进行启动；极端情况下，例如感染病毒、人为误删了关键配置文件时，服务无法启动。
  异常文件目录：D:\UNM2000\platform\bin
  异常文件示例：
  一般来说，某网管操作造成服务异常时，界面会弹错，例如“未知错误”“std::exception”等错误信息时，可第一时间，查看进行该操作的时间点时，是否有对应服务的异常文件。
  若一线发现，某服务持续上报异常，即频繁产生异常文件，可及时联系网管接口人处理，并将异常文件以邮件形式反馈。
  其他情况下，偶现的个别服务异常文件，且在使用过程中未出现报错，不影响业务开通时，可不做重点关注。
  
  网管管理工具无法打开或者提示用户数量限制
  网管管理工具（主要用于网管配置导入导出，入口为U2000界面菜单栏→系统→网管管理工具）无法打开时，可以查看系统服务中UNMCMAgent、UNMCMService服务是否运行正常，分别重启这两个服务后，基本都能恢复正常：
  
  登录网管管理工具时，提示用户数量限制，一般是服务器其他用户打开了管理工具但是未及时退出导致，通过重启UNMCMAgent、UNMCMService服务可解决：
  
  如果重启UNMCMAgent、UNMCMService服务无法解决问题，或者UNMCMAgent、UNMCMService服务无法启动，排查服务器是否感染病毒，并联系各省网管接口人安排研发介入排查。
  
  
  控制命令/状态查询/配置下发失败时日志分析
  网管跟SPN设备之间交互的netconf配置通道用于网元配置下发、网元状态命令行查询、控制命令，当出现网元配置下发失败、状态命令行查询失败以及控制命令下发失败时可以通过分析网管上的netconf交互日志，确认是网管问题还是设备问题。
  网管报错信息分析
  网元ID获取。将光标选中网元对象，然后同时敲CTRL+F12。
  如下图三机楼E30 NE9的网元ID为13172757。
  
  配置下发出现部分激活或者失败时，可以通过快捷键CRTL+SHIFT+F2查看下载详情，确认是哪些网元配置下发失败以及对应的报错信息，根据报错信息进行分析确认原因。
  
  如果是超时报错，可以通过快捷键CRTL+SHIFT+F12+网管任意界面双击，调出界面控制台，查看界面与后台服务调用日志，排除是否网管异常导致。
  如果有异常，请直接联系网管工程师处理。如下图所示：
  
  如果网管界面显示的下发报错信息无法进一步定位，可以在网管找出对应的网元的日志信息进行分析。可参看其他章节介绍的日志查看和分析方法。
  网管和网元交互日志分析
  网管下发日志
  网管下发日志仅有网管下发的命令，和设备返回的最终信息，成功或错误信息，不含详细交互细节。
  该日志无法查看详细交互细节，一般初步定为使用。
  该目录下的文件，以网元ID命名，每个网元一个文件。该文件会对每个网元记录网管给设备下发的所有命令。
  必现问题定位时，可先删除文件，重新下发，避免日志过多，查询不便。
  日志目录
  
  交互日志示例：关注红色方框中的信息，是设备返错的信息，关注ErrorPathInfo和ErrorDetail，如下图所示。
  
  NETCONF日志
  NETCONF日志记录网管与设备交互的详细日志，网管绝大多数的配置（SRTP的部分配置不在该日志体现）下发均可在该交互日志中得到体现。
  日志目录：D:\UNM2000\server\log\netconf，如下图所示。
  
  日志分析
  通过网管上的下载报错信息确认是哪个网元返错，找到返错网元的网元ID和网元IP，然后通过网元ID或者网元IP查找对应的下发记录（对比下发时间）。
  设备返错的信息重点关注error-message和error-number，不同的返错信息原因不一样。
  
  常见设备返错信息及处理方法
  no exec info错误
  现象
  <?xml version="1.0" encoding="utf-8"?>
  <rpc-reply xmlns:nc="urn:ietf:params:xml:ns:netconf:base:1.0"
           xmlns:ncx="http://netconfcentral.org/ns/yuma-ncx"

           xmlns="urn:ietf:params:xml:ns:netconf:base:1.0"

           message-id="9">

  <rpc-error>
  <error-type>application</error-type>
  <error-tag>operation-failed</error-tag>
  <error-severity>error</error-severity>
  <error-app-tag>general-error</error-app-tag>
  <error-message xml:lang="en">no exec info</error-message>
  <error-info>
  <bad-value xmlns="http://netconfcentral.org/ns/yuma-ncx">no exec info</bad-value>
  <error-number xmlns="http://netconfcentral.org/ns/yuma-ncx">929</error-number>
  </error-info>
  </rpc-error>
  </rpc-reply>
  解法
  按下列步骤检查：
  根据配置报文中的参数检查yang文件中list及leaf下是否加了fh映射语句，以及映射语句中的字段是否与对应的yang2uim.xml中的名字匹配。
  检查对应的yang2uim是否存在xml语法错误，如多了或缺了符号和标签，可使用ie浏览器打开yang2uim.xml文件，如内容不能显示或显示不完整，则说明xml格式有问题，请检查自己的修改点。
  unkown namespace错误
  现象
  <?xml version="1.0" encoding="utf-8"?>
  <rpc-reply xmlns:nc="urn:ietf:params:xml:ns:netconf:base:1.0"
  xmlns:ncx="http://netconfcentral.org/ns/yuma-ncx"
  xmlns="urn:ietf:params:xml:ns:netconf:base:1.0"
           message-id="9">

  <rpc-error xmlns:inv="http://fiberhome.com/fhnw/yang/oam/fos-bfd">
  <error-type>protocol</error-type>
  <error-tag>unknown-namespace</error-tag>
  <error-severity>error</error-severity>
  <error-app-tag>data-invalid</error-app-tag>
  <error-message xml:lang="en">unknown namespace</error-message>
  <error-info>
  <bad-element xmlns:inv="INVALID">inv:bfd-if</bad-element>
  <bad-namespace>http://fiberhome.com/fhnw/yang/oam/fos-bfd</bad-namespace>
  <error-number xmlns="http://netconfcentral.org/ns/yuma-ncx">229</error-number>
  </error-info>
  </rpc-error>
  </rpc-reply>
  解法
  本错误说明网管下发的配置中的namespace与设备YANG模型的namespace不一致。按下列步骤检查：
  网管检查下发的配置中的namespace与发布的YANG模型内容是否一致。
  网管检查无误后，由设备对应模块负责人检查YANG模型功能是否开发完成，是否上传SVN，modules目录netconfd.conf文件中是否加入本yang文件名。
  检查修改的yang是否有语法错误，可使用yang designer工具检查或查看nem_4.log日志是否有Error: one or more modules could not be loaded打印点。
  value not in set/bad value错误
  现象
  
  解法
  下发的值不正确，包括枚举值的字符串不在定义范围内，整形值不在定义范围内。可按找error-path中的路径定位到具体出错的节点，检查下发的值。
  error-number大于900的错误
  现象
  Error-number大于900，常见为907。
  
  解法
  配置已经通过了YANG语法的检查，发给CM模块之后，CM模块或业务模块返回的错误。对于这类问题，其有效信息为error-message中的字符串，该字符串是CM返回的错误提示。
  有时CM返回空的错误提示，为查看详细错误信息可在9000命令行使用show cm config result命令，可看到具体报错业务及原因，则联系对应业务同事定位。
  按下列步骤检查：
  查看网管日志，搜索最近的报错日志，根据报错message-id找到对应下发配置报文，判断配置属于哪个业务模块。
  对应业务模块确认报错信息及下发的配置参数，可使用show cm config result命令进一步确认。
  commit错误
  现象
  edit-config并无错误，commit命令出错。
  解法
  Commit命令出错，说明配置已通过yang和CM的检查，在CM把数据发给业务模块后，业务模块报错。此类问题说明业务模块在收到数据时也存在检查，且检查结果出错。需业务模块处理，业务模块可结合报错信息与show cm config result命令查看。
  wrong node type错误
  现象
  <?xml version="1.0" encoding="utf-8"?>
  <rpc-reply xmlns:nc="urn:ietf:params:xml:ns:netconf:base:1.0"
  xmlns:static-route-cfg="http://fiberhome.com/ns/yang/FH-FOS-R8000-urm-cfg"
  xmlns:ncx="http://netconfcentral.org/ns/yuma-ncx"
  xmlns="urn:ietf:params:xml:ns:netconf:base:1.0"
           message-id="3">

  <rpc-error>
  <error-type>protocol</error-type>
  <error-tag>unknown-element</error-tag>
  <error-severity>error</error-severity>
  <error-app-tag>data-invalid</error-app-tag>
  <error-message xml:lang="en">wrong node type</error-message>
  <error-info>
  <error-number xmlns="http://netconfcentral.org/ns/yuma-ncx">282</error-number>
  </error-info>
  </rpc-error>
  </rpc-reply>
  解法
  下发的union类型参数的值不符合union中的type定义，检查配置值需要符合union类型中type定义的格式。
  unknown object错误
  现象
  <?xml version="1.0" encoding="utf-8"?>
  <rpc-reply xmlns:nc="urn:ietf:params:xml:ns:netconf:base:1.0"
  xmlns:static-route-cfg="http://fiberhome.com/ns/yang/FH-FOS-R8000-urm-cfg"
  xmlns:ncx="http://netconfcentral.org/ns/yuma-ncx"
  xmlns="urn:ietf:params:xml:ns:netconf:base:1.0"
           message-id="5">

  <rpc-error>
  <error-type>protocol</error-type>
  <error-tag>unknown-element</error-tag>
  <error-severity>error</error-severity>
  <error-app-tag>data-invalid</error-app-tag>
  <error-path>/nc:rpc/nc:edit-config/nc:config/static-route-cfg:route-static/static-route-cfg:vrfs/static-route-cfg:vrf</error-path>
  <error-message xml:lang="en">unknown object</error-message>
  <error-info>
  <bad-element>static-route-cfg:vrfname</bad-element>
  <error-number xmlns="http://netconfcentral.org/ns/yuma-ncx">293</error-number>
  </error-info>
  </rpc-error>
  </rpc-reply>
  解法
  节点名与YANG文件中定义不符，可根据错误信息中<bad-element>字段查看哪个节点名错误，然后由网管排查下发的配置报文是否与发布的YANG模型一致。若一致，则为设备问题，需设备相应模块确认相关节点是否与上传了SVN。
  Uim data convert failed错误
  现象
  <?xml version="1.0" encoding="UTF-8"?>
  <rpc-reply message-id="2" xmlns:nc="urn:ietf:params:xml:ns:netconf:base:1.0"
 xmlns:acl="http://fiberhome.com/fhnw/yang/ipservice/fos-acl"

 xmlns:ncx="http://netconfcentral.org/ns/yuma-ncx"

 xmlns="urn:ietf:params:xml:ns:netconf:base:1.0">

 <rpc-error>

  <error-type>application</error-type>

  <error-tag>operation-failed</error-tag>

  <error-severity>error</error-severity>

  <error-app-tag>general-error</error-app-tag>

  <error-message xml:lang="en">uim data convert failed</error-message>

  <error-info>

   <bad-value xmlns="http://netconfcentral.org/ns/yuma-ncx">uim data convert failed</bad-value>

   <error-number xmlns="http://netconfcentral.org/ns/yuma-ncx">926</error-number>

  </error-info>

 </rpc-error>

  </rpc-reply>
  解法
  按下列步骤检查：
  根据配置报文中的参数检查对应的yang2uim.xml中的uimType与uimLen字段是否与uim设计匹配。
  输入参数FTYPE类型校验失败，检查各输入参数值是否合法。
  部分参数的FTYPE类型netconf未支持，联系netconf模块开发协助定位，提供下发报文及netconf日志文件。
  xml reader EOF错误
  现象
  返回信息为空或如下所示：
  <?xml version="1.0" encoding="utf-8"?>
  <rpc-reply xmlns:nc="urn:ietf:params:xml:ns:netconf:base:1.0"
  xmlns:static-route-cfg="http://fiberhome.com/ns/yang/FH-FOS-R8000-urm-cfg"
  xmlns:ncx="http://netconfcentral.org/ns/yuma-ncx"
  xmlns="urn:ietf:params:xml:ns:netconf:base:1.0"
           message-id="2">

  <rpc-error>
  <error-type>protocol</error-type>
  <error-tag>unknown-element</error-tag>
  <error-severity>error</error-severity>
  <error-app-tag>data-invalid</error-app-tag>
  <error-path>/nc:rpc/nc:edit-config/nc:config/static-route-cfg:route-static/static-route-cfg:vrfs/static-route-cfg:vrf[static-route-cfg:vrf-name='vrf1']/static-route-cfg:vrf-name</error-path>
  <error-message xml:lang="en">wrong node type</error-message>
  <error-info>
  <bad-element>static-route-cfg:address-family</bad-element>
  <error-number xmlns="http://netconfcentral.org/ns/yuma-ncx">282</error-number>
  </error-info>
  </rpc-error>
  <rpc-error>
  <error-type>protocol</error-type>
  <error-tag>operation-failed</error-tag>
  <error-severity>error</error-severity>
  <error-app-tag>libxml2-error</error-app-tag>
  <error-message xml:lang="en">xml reader EOF</error-message>
  <error-info>
  <error-number xmlns="http://netconfcentral.org/ns/yuma-ncx">221</error-number>
  </error-info>
  </rpc-error>
  </rpc-reply>
  解法
  下发报文不符合xml格式，存在语法错误，检查xml报文格式是否有笔误，xml中开始结束标签是否对应。
  
  ARP诊断方法
  ARP报文统计命令行
  当ARP学习不正常时，可以对接的两端设备上通过ARP报文统计命令行分析故障原因。
  下图是指定接口的arp报文统计。
  
  也可以通过show arp packet statistics查看所有接口arp报文统计。
  REQ-OUT：本端发出的ARP请求报文统计
  REPLY-IN：收到对端的ARP应答报文统计
  REQ-IN：收到对端的ARP请求报文统计
  REPLY-OUT：本端发出的ARP应答报文统计
  ARP debug命令行
  注意事项：当前无法控制只打印一个接口的日志，所以当总的ARP报文很多（通过报文统计命令显示的报文增长速率判断）的时候慎用！！！
  当需要分析报文交互详细信息时，可以通过arp debug命令将相关日志打印出来，具体操作步骤如下：
  登录到设备，按照顺序执行如下如下命令。
  命令1：config terminal
  命令2：infoc source arp channel 1 debug debugstate enable debuglevel debugging log logstate enable loglevel debugging trap trapstate enable traplevel debugging
  命令3：commit
  命令4：terminal monitor
  
  新开一个telnet客户端登陆到设备，执行如下命令，然后步骤1窗口会打印相关日志。
  
  目前debug arp packet命令参数只需要关注all和receive，其中all表示打印所有的包，receive表示打印所有接口收上来的包。
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  NDP诊断方法
  NDP报文统计查询命令行
  
  NS报文(NA报文
  NS-IN：收到对端的NS请求报文统计
  NS-OUT：本端发出的NS请求报文统计
  NA-IN：本端发出的NA应答报文统计
  NA-OUT：收到对端的NA应答报文统计
  BAD-NS-IN：收到对端错误的NS报文统计
  BAD-NA-IN：收到对端错误的NA报文统计
  
  
  NDP debug命令行
  注意事项：当前无法控制只打印一个接口的日志，所以当总的NDP报文很多（通过报文统计命令显示的报文增长速率判断）的时候慎用！！！
  当需要分析报文交互详细信息时，可以通过ndp debug命令将相关日志打印出来，具体操作步骤如下：
  登录到设备，按照顺序执行如下如下命令。
  命令1：config terminal
  命令2：infoc source ndp channel 1 debug debugstate enable debuglevel debugging log logstate enable loglevel debugging trap trapstate enable traplevel debugging
  命令3：commit
  命令4：terminal monitor
  
  新开一个telnet客户端登陆到设备，执行如下命令，然后步骤1）窗口会打印相关日志。
  
  目前debug ndp packet命令参数只需要关注all和common-receive，其中all表示打印所有的包，common-receive表示打印所有接口收上来的包。
  
  
  
  
  
  
  
  
  
  
  
  
  OAM配置检查和CV帧统计方法
  SR-TP OAM配置检查
  配置检查要点。
  源、宿网元OAM配置需要对应。
  在多业务管理中确定源、宿网元及其tunnel id和对应的OAM ID（对应设备show running 中me-name名称）。
  在网元配置的SR-TP配置块中以tunnel id作为关键字查询详细的OAM配置。
  关注MEG名称、本端mep id、远端mep id。
  要求源、宿对应的OAM条目的meg名称相同、源网元的本端mep id跟宿网元的远端mep id相同、源网元远端mep id跟宿网元本端mep id相同。
  网管上配置检查。
  在多业务管理界面查看源网元和宿网元对应的OAM ID（me-name）以及本端和对端的mep id。
  
  找出该隧道源宿网元对应的tunnel id。
  
  通过tunnel id在网元管理器SR-TP配置中找到对应的tunnel配置条目。
  
  查看该条目OAM详细信息（工作OAM和保护OAM检查方法相同）。
  
  设备配置检查（源宿查看方法相同）
  通过show running | begin meg命令查看oam配置，如下图。
  
  查看tunnel 7绑定的OAM。
  
  查看设备tunnel状态详细信息，跟网管上绑定的OAM要一致。
  
  CV帧统计查询方法
  正常情况OAM的CV帧收发计数应该相同（收发应该相差不大，设备上报的是即时值，可以多读几次）。
  可以在多业务管理器中指定某一条业务，然后右键→当前性能，然后查看cv帧的统计计数。
  下图中线路号网管默认不显示，可以在表头上右键→表格列选择显示出来。
  
  
  
  EMBED Word.Document.8 \s  EMBED Word.Document.8 \s
